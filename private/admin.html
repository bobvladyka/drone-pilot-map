<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Admin â€“ SprÃ¡va pilotÅ¯</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <style>
    .edit-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .edit-btn:hover {
      background-color: #45a049;
    }
    #form-wrapper {
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 5px;
      margin-top: 20px;
    }
    #form-wrapper form {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    #form-wrapper label {
      display: block;
      margin-bottom: 5px;
    }
    #form-wrapper input,
    #form-wrapper select,
    #form-wrapper textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
<script>
// Add this at the top of your admin.html script
fetch('/check-admin-session')
  .then(res => {
    if (!res.ok) {
      window.location.href = '/adminland.html';
    }
  })
  .catch(err => {
    window.location.href = '/adminland.html';
  });

</script>
  <h1>Admin â€“ SprÃ¡va pilotÅ¯</h1>

  <button onclick="deleteAll()">ğŸ—‘ï¸ Smazat vÅ¡echny zÃ¡znamy</button>
  <button onclick="deleteSelected()">ğŸ—‘ï¸ Odstranit vybranÃ©</button>
  
  <!-- Add this button near the other action buttons -->
<button onclick="sendGdprReminder()">âœ‰ï¸ Odeslat GDPR pÅ™ipomÃ­nku</button>

  <p id="status"></p>

  <table>
  <thead>
  <tr>
    <th><input type="checkbox" onclick="toggleAll(this)"></th>
    <th>ID</th>
    <th>E-mail</th>
    <th>GPS</th>
    <th>Typ ÃºÄtu</th>
    <th>ViditelnÃ½ do</th>
    <th>Akce</th>
  </tr>
</thead>

  <tbody id="pilot-table"></tbody>
</table>

  <div id="form-wrapper" style="display:none;">
    <h3>Ãšprava pilota</h3>
    <form onsubmit="submitForm(event)">
      <input type="hidden" id="id" />
      
      <label>JmÃ©no: <input id="name" required /></label>
      <label>Lokace: <input id="location" /></label>
      <label>E-mail: <input id="email" type="email" required /></label>
      <label>Telefon: <input id="phone" /></label>
      <label>PoznÃ¡mka: <textarea id="note"></textarea></label>
      <label>ZemÄ›pisnÃ¡ Å¡Ã­Å™ka: <input id="latitude" type="number" step="0.000001" /></label>
      <label>ZemÄ›pisnÃ¡ dÃ©lka: <input id="longitude" type="number" step="0.000001" /></label>
      <label>Heslo (hash): <input id="password_hash" /></label>
      <label>Web: <input id="website" type="url" /></label>
      <label>MÄ›sto: <input id="city" /></label>
      <label>Ulice: <input id="street" /></label>
      <label>PSÄŒ: <input id="zip" /></label>
      <label>Kraj: <input id="region" /></label>
      <label>Licence: <textarea id="licenses"></textarea></label>
      <label>Drony: <textarea id="drones"></textarea></label>
      <label>Ochota dojÃ­Å¾dÄ›t:
        <select id="travel">
          <option value="">-- Vyber --</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </label>
      <label>Specializace: <input id="specialization" /></label>
      <label>DobrovolnÃ­k:
        <select id="volunteer">
          <option value="">-- Vyber --</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </label>
      <label>RegistraÄnÃ­ ÄÃ­slo: <input id="registrationnumber" /></label>
      <label>DostupnÃ½:
        <select id="available">
          <option value="">-- Vyber --</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </label>

<div class="mb-3">
  <label class="form-label">Viditelnost:</label>
  
  <select id="visible" required>
    <option value="ANO">ANO</option>
    <option value="NE">NE</option>
  </select>
</label>

<label>Datum platby: 
  <input id="visible_payment" type="date" />
</label>

<label>PlatnÃ© do: 
  <input id="visible_valid" type="date" />
</label>
</div>
      
      <div style="grid-column: 1 / -1;">
        <button type="submit" class="edit-btn">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
        <button type="button" onclick="document.getElementById('form-wrapper').style.display='none'" style="margin-left:10px;">ZruÅ¡it</button>
      </div>
    </form>
  </div>

  <script>

fetch('/check-admin-session', {
    credentials: 'include'  // OdesÃ­lÃ¡nÃ­ session cookie
})
.then(res => {
    if (!res.ok) {
        window.location.href = '/adminland.html';
    }
})
.catch(err => {
    window.location.href = '/adminland.html';
});
    let editingId = null;

    function loadPilots() {
  fetch('/pilots')
    .then(res => res.json())
    .then(data => {
      const table = document.getElementById('pilot-table');
      table.innerHTML = '';  // VyÄistÃ­ stÃ¡vajÃ­cÃ­ Å™Ã¡dky tabulky

      data.forEach(p => {
  const row = document.createElement('tr');

  // VÃ½poÄet Äasu do vyprÅ¡enÃ­ viditelnosti
  let daysLeft = getDaysLeft(p.visible_valid);

  // âœ… / â— pro GPS
  let gpsStatus = (p.latitude && p.longitude) ? 'âœ…' : 'â—';

  row.innerHTML = `
  <td><input type="checkbox" class="row-checkbox" value="${p.id}" /></td>
  <td>${p.id}</td>
  <td>${p.email || ''}</td>
  <td style="text-align:center;">${gpsStatus}</td>
  <td>${p.type_account || ''}</td>
  <td class="${getVisibilityClass(p.visible_valid)}">
    ${p.visible_valid ? `ViditelnÃ½ do: ${daysLeft} dnÃ­` : 'NE'}
  </td>
  <td>
    <button class="edit-btn" onclick="sendMembershipEmail(${p.id}, '1m')">+1M</button>
    <button class="edit-btn" onclick="sendMembershipEmail(${p.id}, '6m')">+6M</button>
    <button class="edit-btn" onclick="sendMembershipEmail(${p.id}, '12m')">+12M</button>
    <select onchange="changeAccountType(${p.id}, this.value)" style="margin-left:5px;">
      <option value="">ZmÄ›nit ÃºÄet</option>
      <option value="Free">Free</option>
      <option value="Basic">Basic</option>
      <option value="Premium">Premium</option>
    </select>
  </td>
`;

  table.appendChild(row);
});

    });
}

// PomocnÃ¡ funkce pro formÃ¡tovÃ¡nÃ­ data
function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('cs-CZ');
}

    

    function edit(p) {
  editingId = p.id;
  const fields = [
    'id', 'name', 'location', 'email', 'phone', 'note', 
    'latitude', 'longitude', 'password_hash', 'website',
    'city', 'street', 'zip', 'region', 'licenses', 'drones',
    'travel', 'specialization', 'volunteer', 'registrationnumber', 'available', 
    'visible', 'visible_payment', 'visible_valid'
  ];

  fields.forEach(f => {
    const element = document.getElementById(f);
    if (element) {
      if (f === 'visible_payment' || f === 'visible_valid') {
        element.value = p[f] ? new Date(p[f]).toISOString().split('T')[0] : '';
      } else {
        element.value = p[f] || '';
      }
    }
  });

  document.getElementById('form-wrapper').style.display = 'block';
}

function getDaysLeft(validDateStr) {
  const now = new Date();
  const validDate = new Date(validDateStr);
  const diff = Math.ceil((validDate - now) / (1000 * 60 * 60 * 24));
  return diff >= 0 ? diff : 0;
}

function getVisibilityClass(validDateStr) {
  if (!validDateStr) return 'text-danger'; // pokud nenÃ­ data valid, zobrazÃ­ ÄervenÄ›
  
  const daysLeft = getDaysLeft(validDateStr);
  if (daysLeft <= 5) return 'text-danger'; // ÄervenÃ¡
  if (daysLeft <= 10) return 'text-warning'; // Å¾lutÃ¡
  return 'text-success'; // zelenÃ¡
}

function sendGdprReminder() {
  const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'))
    .map(cb => cb.value);
  
  if (selected.length === 0) {
    if (!confirm("Nevybrali jste Å¾Ã¡dnÃ© piloty. Chcete odeslat pÅ™ipomÃ­nku VÅ EM pilotÅ¯m bez GDPR souhlasu?")) {
      return;
    }
  }

  if (!confirm(`Opravdu chcete odeslat GDPR pÅ™ipomÃ­nku ${selected.length > 0 ? 'vybranÃ½m' : 'vÅ¡em'} pilotÅ¯m?`)) return;

  fetch('/admin-send-gdpr-reminder', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      ids: selected.length > 0 ? selected : null 
    })
  })
    .then(res => res.text())
    .then(msg => {
      document.getElementById('status').textContent = msg;
    })
    .catch(err => {
      document.getElementById('status').textContent = "Chyba pÅ™i odesÃ­lÃ¡nÃ­: " + err;
    });
}

function getVisibilityClass(validDateStr) {
  if (!validDateStr) return 'text-danger';

  const daysLeft = getDaysLeft(validDateStr);
  if (daysLeft <= 5) return 'text-danger'; // ÄervenÃ¡
  if (daysLeft <= 10) return 'text-warning'; // Å¾lutÃ¡
  return 'text-success'; // zelenÃ¡
}


    function submitForm(e) {
      e.preventDefault();
      const data = {};
       const paymentDate = document.getElementById('visible_payment').value;
  const validDate = document.getElementById('visible_valid').value;

      if (paymentDate && validDate && new Date(paymentDate) > new Date(validDate)) {
    alert('Datum platby nemÅ¯Å¾e bÃ½t pozdÄ›ji neÅ¾ datum platnosti');
    return;
  }

      const fields = [
        'id', 'name', 'location', 'email', 'phone', 'note', 
        'latitude', 'longitude', 'password_hash', 'website',
        'city', 'street', 'zip', 'region', 'licenses', 'drones',
        'travel', 'specialization', 'volunteer', 'registrationnumber', 'available', 'visible', 'visible_payment', 'visible_valid' 
      ];
      
      fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          data[id] = element.value;
        }
      });

      fetch('/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.text())
        .then(msg => {
          document.getElementById('status').textContent = msg;
          document.getElementById('form-wrapper').style.display = 'none';
          loadPilots();
        });
    }




    function deleteAll() {
      if (!confirm("Opravdu chcete smazat vÅ¡echny piloty?")) return;
      fetch('/delete-all', { method: 'POST' })
        .then(res => res.text())
        .then(msg => {
          document.getElementById('status').textContent = msg;
          loadPilots();
        });
    }

    function toggleAll(master) {
      const checkboxes = document.querySelectorAll('.row-checkbox');
      checkboxes.forEach(cb => cb.checked = master.checked);
    }

    function deleteSelected() {
      const selected = Array.from(document.querySelectorAll('.row-checkbox:checked'))
        .map(cb => cb.value);
      console.log('Selected IDs:', selected);  // Toto pÅ™idÃ¡me pro ladÄ›nÃ­
      if (selected.length === 0) {
        alert("Nevybrali jste Å¾Ã¡dnÃ© piloty.");
        return;
      }

      if (!confirm(`Opravdu chcete smazat ${selected.length} vybranÃ½ch pilotÅ¯?`)) return;

      fetch('/delete-selected', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selected })
      })
        .then(res => res.text())
        .then(msg => {
          document.getElementById('status').textContent = msg;
          loadPilots();
        });
    }



    loadPilots();

function sendMembershipEmail(id, period) {
  let url = '';
  if (period === '1m') url = `/send-membership-email-1m?id=${id}`;
  if (period === '6m') url = `/send-membership-email-6m?id=${id}`;
  if (period === '12m') url = `/send-membership-email-12m?id=${id}`;

  fetch(url)
    .then(res => res.text())
    .then(msg => {
      document.getElementById('status').textContent = msg;
      loadPilots();
    })
    .catch(err => {
      document.getElementById('status').textContent = "Chyba: " + err;
    });
}

function changeAccountType(id, type) {
  if (!type) return;
  if (!confirm(`Opravdu zmÄ›nit ÃºÄet pilota ${id} na ${type}?`)) return;

  fetch('/update-membership', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: getEmailById(id), membership_type: type })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('status').textContent = `âœ… ÃšÄet zmÄ›nÄ›n na ${type}`;
        loadPilots();
      } else {
        document.getElementById('status').textContent = "âŒ Chyba: " + data.message;
      }
    })
    .catch(err => {
      document.getElementById('status').textContent = "âŒ Chyba: " + err;
    });
}

// pomocnÃ¡ funkce â€“ najde email podle ID ze zobrazenÃ© tabulky
function getEmailById(id) {
  const row = [...document.querySelectorAll('#pilot-table tr')]
    .find(r => r.children[1] && r.children[1].textContent == id);
  return row ? row.children[2].textContent : null;
}


  </script>


</body>
</html>
