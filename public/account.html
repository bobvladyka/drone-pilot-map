<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Můj účet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
</head>
<body>
  <div class="card shadow-sm p-4" style="border-radius: var(--radius); background-color: white;">
    <h1 class="text-center mb-4">🧑‍✈️ Účet pilota</h1>

    <form id="account-form" class="row g-3">
      <input type="hidden" id="id" name="id">
      


      <div class="col-md-6">
        <label class="form-label">Jméno:</label>
        <input type="text" id="name" name="name" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">E-mail:</label>
        <input type="email" id="email" name="email" class="form-control" required readonly>
      </div>

      <div class="col-md-6">
        <label class="form-label">Telefon:</label>
        <input type="tel" id="phone" name="phone" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Odkaz na portfolio ve formátu <i>https://...</i> :</label>
        <input type="url" id="website" name="website" class="form-control">
      </div>

<div class="col-md-6">
  <label class="form-label">
    Registrační číslo provozovatele
    <span 
  data-bs-toggle="tooltip" 
  data-bs-placement="top" 
  title="Toto číslo se nikde nezobrazuje. Slouží pouze k identifikaci provozovatele, který tímto potvrzuje legální provoz dronu. Vyplňte pouze veřejnou část." 
  style="cursor: help; font-size: 1rem; vertical-align: middle;">
  ℹ️
</span> : 
  </label>
  <input type="text" 
         id="registrationnumber" 
         name="registrationnumber" 
         class="form-control" 
         pattern="CZE[a-z A-Z 0-9]{13}" 
         maxlength="16" 
         data-bs-toggle="tooltip"
         title="Toto číslo se nikde nezobrazuje. Slouží pouze k identifikaci provozovatele, který tímto potvrzuje legální provoz dronu.">
</div>





      <div class="col-md-4">
        <label class="form-label">Ulice:</label>
        <input type="text" id="street" name="street" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">Město:</label>
        <input type="text" id="city" name="city" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">PSČ:</label>
        <input type="text" id="zip" name="zip" class="form-control">
      </div>

      <div class="col-12">
        <label for="region" class="form-label">Kraj:</label>
        <select id="region" name="region" class="form-select">
          <option value="">– Vyber kraj –</option>
          <option value="Hlavní město Praha">Hlavní město Praha</option>
          <option value="Středočeský kraj">Středočeský kraj</option>
          <option value="Jihočeský kraj">Jihočeský kraj</option>
          <option value="Plzeňský kraj">Plzeňský kraj</option>
          <option value="Karlovarský kraj">Karlovarský kraj</option>
          <option value="Ústecký kraj">Ústecký kraj</option>
          <option value="Liberecký kraj">Liberecký kraj</option>
          <option value="Královéhradecký kraj">Královéhradecký kraj</option>
          <option value="Pardubický kraj">Pardubický kraj</option>
          <option value="Kraj Vysočina">Kraj Vysočina</option>
          <option value="Jihomoravský kraj">Jihomoravský kraj</option>
          <option value="Olomoucký kraj">Olomoucký kraj</option>
          <option value="Zlínský kraj">Zlínský kraj</option>
          <option value="Moravskoslezský kraj">Moravskoslezský kraj</option>
        </select>
      </div>

	<div class="alert alert-info" style="margin-top: 10px;">
  📍 Pokud se nezobrazuješ na mapě, zkontroluj správnost adresy. Nejlépe funguje, pokud uvedeš <strong>ulici, město a kraj</strong>.
</div>

      <div class="col-12">
        <label class="form-label">Povolení (licence):</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A1/A3" id="a1a3">
          <label class="form-check-label" for="a1a3">A1/A3</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A2" id="a2">
          <label class="form-check-label" for="a2">A2</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="LUC" id="luc">
          <label class="form-check-label" for="luc">LUC</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="SPECIFIC" id="specific">
          <label class="form-check-label" for="specific">SPECIFIC</label>
        </div>
      </div>

      <div class="col-md-6">
  <label class="form-label">Dron / vybavení:</label>
  <div id="drones"></div>

  <button type="button" id="add-drone-btn" class="btn-sm mt-2">
  <span class="me-1">+</span> Přidat dron / vybavení
</button>

</div>

      <div class="col-md-6">
        <label class="form-label">Ochota dojíždět:</label>
        <select id="travel" name="travel" class="form-select">
          <option value="">– Vyber –</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


<div class="col-md-6">
        <label class="form-label">Jsem k dispozici:</label>
        <select id="available" name="available" class="form-select">
          <option value="">– Vyber –</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


      <div class="col-12">
        <label class="form-label">Specializace:</label>
        <select id="specialization" name="specialization" multiple class="form-select">
          <option value="Foto/video">Foto/video</option>
          <option value="Fotogrammetrie">Fotogrammetrie</option>
          <option value="Senoseč">Senoseč</option>
          <option value="Termální inspekce">Termální inspekce</option>
          <option value="FPV průlety">FPV průlety</option>
          <option value="Jiné">Jiné (více v poznámce)</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Poznámka:</label>
        <textarea id="note" name="note" rows="3" class="form-control"></textarea>
      </div>

      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="volunteer" name="volunteer" value="ANO">
          <label class="form-check-label" for="volunteer">Dobrovolník</label>
        </div>
      </div>


      <a href="/changepass.html">Změnit heslo</a>

      <div class="col-12">
        <div id="membership-status" class="alert alert-light border d-flex justify-content-between align-items-center" style="display: none;">
  <span id="membership-text"></span>
  <a href="/prodlouzit-clenstvi.html" class="btn btn-sm btn-outline-primary">Prodloužit členství</a>
</div>
<div class="alert alert-secondary mt-4">
  📢 Pozvi kamaráda a získej na týden členství <b>zdarma!</b><br>
  Tvůj odkaz: 
  <code id="ref-link"></code>
</div>
  
<div class="col-12 mt-4" id="gdpr-consent-section" style="display: none;">
  <h5>Souhlas se zveřejněním kontaktů</h5>
  <p class="text-muted">
    Pokud souhlasíte, váš e‑mail a telefon budou viditelné pro ostatní uživatele v souladu s vaším tarifem. Nastavení souhlasu GDPR je dostupné pouze pro uživatele s tarifem <b>Premium</b>. Ostatní uživatelé již souhlas udělili během registračního procesu.
  </p>
  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="publicContactConsent">
    <label class="form-check-label" for="publicContactConsent">
      Souhlasím se zveřejněním mého e‑mailu a telefonu
    </label>
  </div>
</div>  
  <span id="consent-status" class="ms-2 text-muted"></span>
  <button type="button" class="btn btn-outline-primary mt-2" id="saveConsentBtn">Uložit souhlas</button>
</div>
        <button type="submit" class="pilot-login-btn w-100">💾 Uložit změny</button>
        
        <div class="text-center mt-3">
          <a href="/index.html" class="btn btn-link">← Zpět na mapu</a>
        </div>
      </div>
    </form>

<div id="status"></div>

  </div>

 <div id="chat-content">
    <!-- Zde se dynamicky načtou konverzace pilota -->
  </div>


  <script>

let currentPilot = null;
    const storedEmail = localStorage.getItem("loggedEmail");
const params = new URLSearchParams(window.location.search);
const email = params.get("email") || localStorage.getItem("loggedEmail");


if (!email) {
  // Pokud není e-mail ani v URL ani v localStorage, přesměruj na přihlášení
  window.location.href = "/login.html";
}
    const status = document.getElementById("status");



function addDroneField(value = "") {
  const container = document.getElementById("drones");
  const inputGroup = document.createElement("div");
  inputGroup.className = "input-group mb-2";

  const input = document.createElement("input");
  input.type = "text";
  input.name = "drones[]";
  input.className = "form-control";
  input.value = value;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "btn btn-outline-danger";
  removeBtn.innerHTML = "🗑️";
  removeBtn.onclick = () => inputGroup.remove();

  inputGroup.appendChild(input);
  inputGroup.appendChild(removeBtn);
  container.appendChild(inputGroup);
}


   fetch("/get-my-pilot?email=" + encodeURIComponent(email))
  .then(res => {
    if (!res.ok) throw new Error("Nepřihlášen nebo pilot nenalezen");
    return res.json();
  })
  .then(pilot => {
  currentPilot = pilot;
  console.log("Data pilota:", pilot);

// 🚨 Handle GDPR consent section visibility
    if (pilot.type_account !== "Premium") {
      // Hide GDPR consent section for non-Premium accounts
      document.getElementById("publicContactConsent").disabled = true;
      document.getElementById("saveConsentBtn").disabled = true;
    } else {
      // Enable GDPR consent for Premium accounts
      document.getElementById("publicContactConsent").disabled = false;
      document.getElementById("saveConsentBtn").disabled = false;
    }

  fetch('/get-my-consents?email=' + encodeURIComponent(pilot.email))
    .then(res => res.json())
    .then(data => {
      document.getElementById('publicContactConsent').checked = data.hasPublicConsent;
    })
    .catch(err => console.warn(err));

    // 🔒 Omezení pro Free účet
if (pilot.type_account === "Free") {
  const availableSelect = document.getElementById("available");
  availableSelect.value = "ANO";      // přednastavit ANO
  availableSelect.disabled = true;    // uzamknout

  document.getElementById("website").disabled = true;
  document.getElementById("note").disabled = true;

  // 🚫 Uzamknout registrační číslo
  document.getElementById("registrationnumber").disabled = true;

  // 🚫 Ponechat jen 1 dron a zakázat přidávání
  const addBtn = document.querySelector('button[onclick="addDroneField()"]');
  if (addBtn) addBtn.remove();
  // Odstranit nadbytečné drony (ponechat jen první)
  const dronesContainer = document.getElementById("drones");
  if (dronesContainer.children.length > 1) {
    [...dronesContainer.children].slice(1).forEach(el => el.remove());
  }

  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 1) {
      alert("Ve Free účtu lze vybrat pouze jednu specializaci.");
      const lastSelected = this.selectedOptions[this.selectedOptions.length - 1].value;
      [...this.options].forEach(opt => opt.selected = (opt.value === lastSelected));
    }
  });
}
if (pilot.type_account === "Basic") {

  
   // Max 2 drony
  const addBtn = document.getElementById("add-drone-btn");
  addBtn.addEventListener("click", () => {
    const dronesContainer = document.getElementById("drones");
    if (dronesContainer.children.length >= 2) {
      alert("V Basic účtu lze přidat maximálně 2 drony.");
      return; // ⛔ zastaví přidání
    }
    addDroneField();
  });

  // Max 2 specializace
  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 2) {
      alert("V Basic účtu lze vybrat maximálně 2 specializace.");
      this.selectedOptions[this.selectedOptions.length - 1].selected = false;
    }

  });
}


// Načíst stav souhlasu
fetch('/get-my-consents')
  .then(res => res.json())
  .then(data => {
    document.getElementById('publicContactConsent').checked = data.hasPublicConsent;
  });

// Uložit/odvolat souhlas
document.getElementById('saveConsentBtn').addEventListener('click', () => {
  const consent = document.getElementById('publicContactConsent').checked;
  const consentStatusElement = document.getElementById('consent-status');

    // Date and time in UTC format
  const consentDate = new Date();
  consentDate.setHours(consentDate.getHours());  // Adjust to UTC+2
  const formattedDate = consentDate.toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' });

  // Store the consent in localStorage
  localStorage.setItem('publicContactConsent', consent);
  localStorage.setItem('consentDate', formattedDate);

  fetch('/save-consent', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: currentPilot.email, 
      consent_type: 'public_contact',
      consent_text: consent 
        ? 'Souhlasím se zveřejněním e-mailu a telefonu v mém profilu.' 
        : 'Odvolávám souhlas se zveřejněním e-mailu a telefonu v mém profilu.',
      granted: consent,
      timestamp: consent ? consentDate.toISOString() : null // Send timestamp if consented
    })
  })
  .then(res => {
    if (!res.ok) throw new Error('Chyba při ukládání souhlasu');
    
    // Update UI with the stored consent status and date
    if (consent) {
      consentStatusElement.textContent = `Udělil souhlas dne: ${formattedDate}`;
      consentStatusElement.style.color = 'green';
    } else {
      consentStatusElement.textContent = 'Souhlas neudělen';
      consentStatusElement.style.color = 'red';
    }
  })
  .catch(err => {
    consentStatusElement.textContent = 'Chyba při ukládání souhlasu';
    consentStatusElement.style.color = 'red';
    alert(err.message);
  });
});

    // 🟢 Zobrazení členství a odpočtu dní
    if (pilot.visible_valid) {
      const validDate = new Date(pilot.visible_valid);
      const today = new Date();
      const daysLeft = Math.ceil((validDate - today) / (1000 * 60 * 60 * 24));

      const membershipBox = document.getElementById("membership-status");
      const membershipText = document.getElementById("membership-text");

      if (membershipBox && membershipText) {
        membershipText.innerHTML = `<strong>Členství platné do:</strong> ${validDate.toLocaleDateString('cs-CZ')} (${daysLeft} dní)`;

         // Add account type information
    let accountTypeText = '';
    if (pilot.type_account === "Free") {
      accountTypeText = '<span style="color: lightgreen; font-weight: bold;">Free</span>';
    } else if (pilot.type_account === "Basic") {
      accountTypeText = '<span style="color: darkgreen; font-weight: bold;">Basic</span>';
    } else if (pilot.type_account === "Premium") {
      accountTypeText = '<span style="color: purple; font-weight: bold;">Premium</span>';
    }

    membershipText.innerHTML += `<br><strong>Typ účtu:</strong> ${accountTypeText}`;
        membershipBox.style.display = "flex";
        membershipBox.classList.remove("alert-success", "alert-warning", "alert-danger");

        if (daysLeft <= 0) {
      membershipBox.classList.add("alert-danger");
      
      // Popup alert when membership is expired or 0 days left
      alert("Vaše členství vypršelo nebo je již neplatné. Buďto si můžete předplatit členství na stránce <a href='/prodlouzit-clenstvi.html'>Prodloužit členství</a> nebo pokračovat v režimu Free.");
    } else if (daysLeft <= 5) {
      membershipBox.classList.add("alert-warning");
    } else {
      membershipBox.classList.add("alert-success");
        }
      }


    }

    // 📝 Načítání dat pilota do formuláře
    document.getElementById("id").value = pilot.id || "";
    document.getElementById("name").value = pilot.name || "";
    document.getElementById("email").value = pilot.email || "";
    document.getElementById("phone").value = pilot.phone || "";
    document.getElementById("website").value = pilot.website || "";

    document.getElementById("registrationnumber").value = pilot.registrationnumber || "";
    document.getElementById("street").value = pilot.street || "";
    document.getElementById("city").value = pilot.city || "";
    document.getElementById("zip").value = pilot.zip || "";
    document.getElementById("region").value = pilot.region || "";

    const dronesArray = (pilot.drones || "").split(",").map(d => d.trim()).filter(d => d);
    dronesArray.forEach(d => addDroneField(d));
    if (dronesArray.length === 0) addDroneField();

    document.getElementById("note").value = pilot.note || "";
    document.getElementById("travel").value = pilot.travel || "";

    const licenses = (pilot.licenses || "").split(",").map(s => s.trim());
    document.querySelectorAll("input[name='licenses']").forEach(cb => {
      cb.checked = licenses.includes(cb.value);
    });

    if (pilot.specialization) {
      const specializations = pilot.specialization.split(',').map(s => s.trim());
      [...document.getElementById("specialization").options].forEach(opt => {
        opt.selected = specializations.includes(opt.value);
      });
    }

    if (pilot.volunteer === "ANO") {
      document.getElementById("volunteer").checked = true;
    }

    document.getElementById("available").value = pilot.available || "";
  });


    document.getElementById("account-form").addEventListener("submit", async e => {
      e.preventDefault();


	const regNumberInput = document.getElementById("registrationnumber");
  if (!regNumberInput.checkValidity()) {
    // Zobrazí chybu, pokud je pole neplatné
    regNumberInput.focus(); // Scrolluje na problémové pole
    document.getElementById("status").textContent = "❌ Chyba: Zadejte platné registrační číslo (formát CZE + 10 znaků).";
    document.getElementById("status").classList.add("text-danger");
    return; // Zastaví odeslání
  }
      const data = {
        id: document.getElementById("id").value,
        email: document.getElementById("email").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        website: document.getElementById("website").value,
        registrationnumber: regNumberInput.value.trim(),
        street: document.getElementById("street").value,
        city: document.getElementById("city").value,
        zip: document.getElementById("zip").value,
        region: document.getElementById("region").value,
        drones: Array.from(document.getElementsByName("drones[]")).map(i => i.value.trim()).filter(v => v).join(", "),
        note: document.getElementById("note").value,
        travel: document.getElementById("travel").value,
        licenses: Array.from(document.querySelectorAll("input[name='licenses']:checked")).map(cb => cb.value).join(", "),
        specialization: Array.from(document.getElementById("specialization").selectedOptions).map(o => o.value).join(", "),
        volunteer: document.getElementById("volunteer").checked ? "ANO" : "NE",
        available: document.getElementById("available").value,
      visible: currentPilot?.visible,
      visible_valid: currentPilot?.visible_valid,
      visible_payment: currentPilot?.visible_payment
      };

console.log("Odesílaná data:", data);
      const res = await fetch("/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      status.textContent = text;
      status.classList.remove("text-danger", "text-success");
      status.classList.add(res.ok ? "text-success" : "text-danger");
	status.classList.toggle("text-success", res.ok);
  status.classList.toggle("text-danger", !res.ok);
    });
  </script>

<script>
  const refEmail = localStorage.getItem("loggedEmail");
  if (refEmail) {
    const refUrl = `https://najdipilota.cz/register.html?ref=${encodeURIComponent(refEmail)}`;
    document.getElementById("ref-link").textContent = refUrl;
  }
</script>

<script>
  // Assume type_account is dynamically set from your user data
  const type_account = 'Premium'; // Replace this with the actual logic that fetches the user's account type

  // Only display the GDPR consent section if the user has a Premium account
  if (type_account === 'Premium') {
    document.getElementById('gdpr-consent-section').style.display = 'block';
  }
</script>

 <script>
    document.addEventListener("DOMContentLoaded", async () => {
  const loggedEmail = localStorage.getItem("loggedEmail");

  // Pokud není uživatel přihlášen, přesměrujeme na stránku přihlášení
  if (!loggedEmail) {
    alert("Nejste přihlášeni! Přihlaste se prosím.");
    window.location.href = "/index.html"; // Přesměrování na stránku přihlášení
    return;
  }

  // 1. Načtení konverzací pro pilota
  try {
    const response = await fetch(`/api/get-conversations?pilotEmail=${encodeURIComponent(loggedEmail)}`);
    const conversations = await response.json();

    if (conversations.length === 0) {
      document.getElementById("chat-content").innerHTML = "<p>Nemáte žádné konverzace.</p>";
    } else {
      // Pokud máte nějaké konverzace, zobrazíme je
      conversations.forEach(conv => {
        const convElement = document.createElement("div");
        convElement.classList.add("conversation");
        convElement.innerHTML = `
          <h3>Konverzace s: ${conv.inzerentEmail}</h3>
          <a href="/chat.html?conversationId=${conv.conversationId}" class="btn btn-primary">
            Přejít do chatu
          </a>
        `;
        document.getElementById("chat-content").appendChild(convElement);
      });
    }

  } catch (error) {
    console.error("Chyba při načítání konverzací:", error);
    document.getElementById("chat-content").innerHTML = "<p>Chyba při načítání konverzací.</p>";
  }
});
  </script>

</body>
</html>
