<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Můj účet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
</head>
<body>
  <div class="card shadow-sm p-4" style="border-radius: var(--radius); background-color: white;">
    <h1 class="text-center mb-4">🧑‍✈️ Účet pilota</h1>

    <form id="account-form" class="row g-3">
      <input type="hidden" id="id" name="id">

      <div class="col-md-6">
        <label class="form-label">Jméno:</label>
        <input type="text" id="name" name="name" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">E-mail:</label>
        <input type="email" id="email" name="email" class="form-control" required readonly>
      </div>

      <div class="col-md-6">
        <label class="form-label">Telefon:</label>
        <input type="tel" id="phone" name="phone" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Web / Instagram / odkaz na portfolio:</label>
        <input type="url" id="website" name="website" class="form-control">
      </div>

<div class="col-md-6">
  <label class="form-label">
    Registrační číslo provozovatele
    <span 
  data-bs-toggle="tooltip" 
  data-bs-placement="top" 
  title="Toto číslo se nikde nezobrazuje. Slouží pouze k identifikaci provozovatele, který tímto potvrzuje legální provoz dronu. Vyplňte pouze veřejnou část." 
  style="cursor: help; font-size: 1rem; vertical-align: middle;">
  ℹ️
</span> : 
  </label>
  <input type="text" 
         id="registrationnumber" 
         name="registrationnumber" 
         class="form-control" 
         pattern="CZE[a-z A-Z 0-9]{13}" 
         maxlength="16" 
         data-bs-toggle="tooltip"
         title="Toto číslo se nikde nezobrazuje. Slouží pouze k identifikaci provozovatele, který tímto potvrzuje legální provoz dronu.">
</div>



      <div class="col-md-4">
        <label class="form-label">Ulice:</label>
        <input type="text" id="street" name="street" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">Město:</label>
        <input type="text" id="city" name="city" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">PSČ:</label>
        <input type="text" id="zip" name="zip" class="form-control">
      </div>

      <div class="col-12">
        <label for="region" class="form-label">Kraj:</label>
        <select id="region" name="region" class="form-select">
          <option value="">– Vyber kraj –</option>
          <option value="Hlavní město Praha">Hlavní město Praha</option>
          <option value="Středočeský kraj">Středočeský kraj</option>
          <option value="Jihočeský kraj">Jihočeský kraj</option>
          <option value="Plzeňský kraj">Plzeňský kraj</option>
          <option value="Karlovarský kraj">Karlovarský kraj</option>
          <option value="Ústecký kraj">Ústecký kraj</option>
          <option value="Liberecký kraj">Liberecký kraj</option>
          <option value="Královéhradecký kraj">Královéhradecký kraj</option>
          <option value="Pardubický kraj">Pardubický kraj</option>
          <option value="Kraj Vysočina">Kraj Vysočina</option>
          <option value="Jihomoravský kraj">Jihomoravský kraj</option>
          <option value="Olomoucký kraj">Olomoucký kraj</option>
          <option value="Zlínský kraj">Zlínský kraj</option>
          <option value="Moravskoslezský kraj">Moravskoslezský kraj</option>
        </select>
      </div>

	<div class="alert alert-info" style="margin-top: 10px;">
  📍 Pokud se nezobrazuješ na mapě, zkontroluj správnost adresy. Nejlépe funguje, pokud uvedeš <strong>ulici, město a kraj</strong>.
</div>

      <div class="col-12">
        <label class="form-label">Povolení (licence):</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A1/A3" id="a1a3">
          <label class="form-check-label" for="a1a3">A1/A3</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A2" id="a2">
          <label class="form-check-label" for="a2">A2</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="LUC" id="luc">
          <label class="form-check-label" for="luc">LUC</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="SPECIFIC" id="specific">
          <label class="form-check-label" for="specific">SPECIFIC</label>
        </div>
      </div>

      <div class="col-md-6">
  <label class="form-label">Dron / vybavení:</label>
  <div id="drones"></div>

  <button type="button" class="btn-sm mt-2" onclick="addDroneField()">
  <span class="me-1">+</span> Přidat dron / vybavení
</button>

</div>

      <div class="col-md-6">
        <label class="form-label">Ochota dojíždět:</label>
        <select id="travel" name="travel" class="form-select">
          <option value="">– Vyber –</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


<div class="col-md-6">
        <label class="form-label">Jsem k dispozici:</label>
        <select id="available" name="available" class="form-select">
          <option value="">– Vyber –</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


      <div class="col-12">
        <label class="form-label">Specializace:</label>
        <select id="specialization" name="specialization" multiple class="form-select">
          <option value="Foto/video">Foto/video</option>
          <option value="Fotogrammetrie">Fotogrammetrie</option>
          <option value="Senoseč">Senoseč</option>
          <option value="Termální inspekce">Termální inspekce</option>
          <option value="FPV průlety">FPV průlety</option>
          <option value="Jiné">Jiné (více v poznámce)</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Poznámka:</label>
        <textarea id="note" name="note" rows="3" class="form-control"></textarea>
      </div>

      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="volunteer" name="volunteer" value="ANO">
          <label class="form-check-label" for="volunteer">Dobrovolník</label>
        </div>
      </div>
      <a href="/changepass.html">Změnit heslo</a>

      <div class="col-12">
        <button type="submit" class="pilot-login-btn w-100">💾 Uložit změny</button>
        <p id="status" class="mt-3 text-center fw-semibold"></p>
        <div class="text-center mt-3">
          <a href="/index.html" class="btn btn-link">← Zpět na mapu</a>
        </div>
      </div>
    </form>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");
    const status = document.getElementById("status");

function addDroneField(value = "") {
  const container = document.getElementById("drones");
  const inputGroup = document.createElement("div");
  inputGroup.className = "input-group mb-2";

  const input = document.createElement("input");
  input.type = "text";
  input.name = "drones[]";
  input.className = "form-control";
  input.value = value;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "btn btn-outline-danger";
  removeBtn.innerHTML = "🗑️";
  removeBtn.onclick = () => inputGroup.remove();

  inputGroup.appendChild(input);
  inputGroup.appendChild(removeBtn);
  container.appendChild(inputGroup);
}


    fetch("/pilots")
      .then(res => res.json())
      .then(data => {
        const pilot = data.find(p => p.email === email);
        console.log("Data pilota:", pilot);
        if (!pilot) {
          status.textContent = "Pilot nenalezen.";
          status.classList.add("text-danger");
          return;
        }

        document.getElementById("id").value = pilot.id || "";
        document.getElementById("name").value = pilot.name || "";
        document.getElementById("email").value = pilot.email || "";
        document.getElementById("phone").value = pilot.phone || "";
        document.getElementById("website").value = pilot.website || "";
        console.log("Načtený pilot:", pilot); 
        document.getElementById("registrationnumber").value = pilot.registrationnumber || "";
        document.getElementById("street").value = pilot.street || "";
        document.getElementById("city").value = pilot.city || "";
        document.getElementById("zip").value = pilot.zip || "";
        document.getElementById("region").value = pilot.region || "";
        const dronesArray = (pilot.drones || "").split(",").map(d => d.trim()).filter(d => d);
dronesArray.forEach(d => addDroneField(d));
if (dronesArray.length === 0) addDroneField();
        document.getElementById("note").value = pilot.note || "";
        document.getElementById("travel").value = pilot.travel || "";

        const licenses = (pilot.licenses || "").split(",").map(s => s.trim());
        document.querySelectorAll("input[name='licenses']").forEach(cb => {
          cb.checked = licenses.includes(cb.value);
        });

        if (pilot.specialization) {
          const specializations = pilot.specialization.split(',').map(s => s.trim());
          [...document.getElementById("specialization").options].forEach(opt => {
            opt.selected = specializations.includes(opt.value);
          });
        }

        if (pilot.volunteer === "ANO") {
          document.getElementById("volunteer").checked = true;
        }

        if (pilot.available === "ANO") {
  document.getElementById("available").checked = true;
}
      });

    document.getElementById("account-form").addEventListener("submit", async e => {
      e.preventDefault();


	const regNumberInput = document.getElementById("registrationnumber");
  if (!regNumberInput.checkValidity()) {
    // Zobrazí chybu, pokud je pole neplatné
    regNumberInput.focus(); // Scrolluje na problémové pole
    document.getElementById("status").textContent = "❌ Chyba: Zadejte platné registrační číslo (formát CZE + 10 znaků).";
    document.getElementById("status").classList.add("text-danger");
    return; // Zastaví odeslání
  }
      const data = {
        id: document.getElementById("id").value,
        email: document.getElementById("email").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        website: document.getElementById("website").value,
        registrationnumber: regNumberInput.value.trim(),
        street: document.getElementById("street").value,
        city: document.getElementById("city").value,
        zip: document.getElementById("zip").value,
        region: document.getElementById("region").value,
        drones: Array.from(document.getElementsByName("drones[]")).map(i => i.value.trim()).filter(v => v).join(", "),
        note: document.getElementById("note").value,
        travel: document.getElementById("travel").value,
        licenses: Array.from(document.querySelectorAll("input[name='licenses']:checked")).map(cb => cb.value).join(", "),
        specialization: Array.from(document.getElementById("specialization").selectedOptions).map(o => o.value).join(", "),
        volunteer: document.getElementById("volunteer").checked ? "ANO" : "NE",
        available: document.getElementById("available").value
      };

console.log("Odesílaná data:", data);
      const res = await fetch("/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      status.textContent = text;
      status.classList.remove("text-danger", "text-success");
      status.classList.add(res.ok ? "text-success" : "text-danger");
	status.classList.toggle("text-success", res.ok);
  status.classList.toggle("text-danger", !res.ok);
    });
  </script>

</body>
</html>
