<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MÅ¯j ÃºÄet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <meta name="robots" content="index, follow">

 <!-- Leaflet a MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- Favicony -->
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="manifest" href="/icons/site.webmanifest">
<link rel="icon" href="/icons/favicon.ico" type="image/x-icon">  


</head>
<body>
  <div class="card shadow-sm p-4" style="border-radius: var(--radius); background-color: white;">
<!-- Quickbar: akce po pÅ™ihlÃ¡Å¡enÃ­ -->
<div id="account-quickbar" class="sticky-top bg-light border-bottom py-2 shadow-sm">
  <div class="container d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <a href="/index.html" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left-circle me-1"></i>ZpÄ›t na mapu
      </a>
      <a href="/moje-zpravy.html" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-envelope me-1"></i>Moje zprÃ¡vy
      </a>
      <a id="poptavkyBtn" href="/poptavky.html" class="btn btn-outline-dark btn-sm d-none">
        <i class="bi bi-briefcase-fill me-1"></i>PoptÃ¡vky
      </a>
    </div>

    <span id="loggedAs" class="text-muted small d-none d-md-inline"></span>
  </div>
</div>
<br>

    <h1 class="text-center mb-4">ğŸ§‘â€âœˆï¸ ÃšÄet pilota</h1>

    <form id="account-form" class="row g-3">
      <input type="hidden" id="id" name="id">
      


      <div class="col-md-6">
        <label class="form-label">JmÃ©no:</label>
        <input type="text" id="name" name="name" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">E-mail:</label>
        <input type="email" id="email" name="email" class="form-control" required readonly>
      </div>

      <div class="col-md-6">
        <label class="form-label">Telefon:</label>
        <input type="tel" id="phone" name="phone" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Odkaz na portfolio ve formÃ¡tu <i>https://...</i> :</label>
        <input type="url" id="website" name="website" class="form-control">
      </div>

<div class="col-md-6">
  <label class="form-label">
    RegistraÄnÃ­ ÄÃ­slo provozovatele
    <span 
  data-bs-toggle="tooltip" 
  data-bs-placement="top" 
  title="Toto ÄÃ­slo se nikde nezobrazuje. SlouÅ¾Ã­ pouze k identifikaci provozovatele, kterÃ½ tÃ­mto potvrzuje legÃ¡lnÃ­ provoz dronu. VyplÅˆte pouze veÅ™ejnou ÄÃ¡st." 
  style="cursor: help; font-size: 1rem; vertical-align: middle;">
  â„¹ï¸
</span> : 
  </label>
  <input type="text" 
         id="registrationnumber" 
         name="registrationnumber" 
         class="form-control" 
         pattern="CZE[a-z A-Z 0-9]{13}" 
         maxlength="16" 
         data-bs-toggle="tooltip"
         title="Toto ÄÃ­slo se nikde nezobrazuje. SlouÅ¾Ã­ pouze k identifikaci provozovatele, kterÃ½ tÃ­mto potvrzuje legÃ¡lnÃ­ provoz dronu.">
</div>





      <div class="col-md-4">
        <label class="form-label">Ulice:</label>
        <input type="text" id="street" name="street" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">MÄ›sto:</label>
        <input type="text" id="city" name="city" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">PSÄŒ:</label>
        <input type="text" id="zip" name="zip" class="form-control">
      </div>

      <div class="col-12">
        <label for="region" class="form-label">Kraj:</label>
        <select id="region" name="region" class="form-select">
          <option value="">â€“ Vyber kraj â€“</option>
          <option value="HlavnÃ­ mÄ›sto Praha">HlavnÃ­ mÄ›sto Praha</option>
          <option value="StÅ™edoÄeskÃ½ kraj">StÅ™edoÄeskÃ½ kraj</option>
          <option value="JihoÄeskÃ½ kraj">JihoÄeskÃ½ kraj</option>
          <option value="PlzeÅˆskÃ½ kraj">PlzeÅˆskÃ½ kraj</option>
          <option value="KarlovarskÃ½ kraj">KarlovarskÃ½ kraj</option>
          <option value="ÃšsteckÃ½ kraj">ÃšsteckÃ½ kraj</option>
          <option value="LibereckÃ½ kraj">LibereckÃ½ kraj</option>
          <option value="KrÃ¡lovÃ©hradeckÃ½ kraj">KrÃ¡lovÃ©hradeckÃ½ kraj</option>
          <option value="PardubickÃ½ kraj">PardubickÃ½ kraj</option>
          <option value="Kraj VysoÄina">Kraj VysoÄina</option>
          <option value="JihomoravskÃ½ kraj">JihomoravskÃ½ kraj</option>
          <option value="OlomouckÃ½ kraj">OlomouckÃ½ kraj</option>
          <option value="ZlÃ­nskÃ½ kraj">ZlÃ­nskÃ½ kraj</option>
          <option value="MoravskoslezskÃ½ kraj">MoravskoslezskÃ½ kraj</option>
        </select>
      </div>

	<div class="alert alert-info" style="margin-top: 10px;">
  ğŸ“ Pokud se nezobrazujeÅ¡ na mapÄ›, zkontroluj sprÃ¡vnost adresy. NejlÃ©pe funguje, pokud uvedeÅ¡ <strong>ulici, mÄ›sto a kraj</strong>.
</div>

      <div class="col-12">
        <label class="form-label">PovolenÃ­ (licence):</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A1/A3" id="a1a3">
          <label class="form-check-label" for="a1a3">A1/A3</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A2" id="a2">
          <label class="form-check-label" for="a2">A2</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="LUC" id="luc">
          <label class="form-check-label" for="luc">LUC</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="SPECIFIC" id="specific">
          <label class="form-check-label" for="specific">SPECIFIC</label>
        </div>
      </div>

      <div class="col-md-6">
  <label class="form-label">Dron / vybavenÃ­:</label>
  <div id="drones"></div>

  <button type="button" id="add-drone-btn" class="btn-sm mt-2">
  <span class="me-1">+</span> PÅ™idat dron / vybavenÃ­
</button>

</div>

      <div class="col-md-6">
        <label class="form-label">Ochota dojÃ­Å¾dÄ›t:</label>
        <select id="travel" name="travel" class="form-select">
          <option value="">â€“ Vyber â€“</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


<div class="col-md-6">
        <label class="form-label">Jsem k dispozici:</label>
        <select id="available" name="available" class="form-select">
          <option value="">â€“ Vyber â€“</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


      <div class="col-12">
        <label class="form-label">Specializace:</label>
        <select id="specialization" name="specialization" multiple class="form-select"></select>
      </div>

      <div class="col-12">
        <label class="form-label">PoznÃ¡mka:</label>
        <textarea id="note" name="note" rows="3" class="form-control" maxlength="80"></textarea>
<small id="noteCounter" class="text-muted">0 / 80 znakÅ¯</small>

      </div>

      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="volunteer" name="volunteer" value="ANO">
          <label class="form-check-label" for="volunteer">DobrovolnÃ­k</label>
        </div>
      </div>


      <a href="/changepass.html">ZmÄ›nit heslo</a>

      <div class="col-12">
        <div id="membership-status" class="alert alert-light border d-flex justify-content-between align-items-center" style="display: none;">
  <span id="membership-text"></span>
  <a href="/prodlouzit-clenstvi.html" class="btn btn-sm btn-outline-primary">ProdlouÅ¾it ÄlenstvÃ­</a>
</div>
<div class="alert alert-secondary mt-4">
  ğŸ“¢ Pozvi kamarÃ¡da a zÃ­skej na tÃ½den ÄlenstvÃ­ <b>zdarma!</b><br>
  TvÅ¯j odkaz: 
   <code id="ref-code">â€”</code>
  <span id="ref-url" class="d-none"></span>
  <button id="copy-btn" class="btn pilot-login-button btn-sm ms-2 w-100" title="KopÃ­rovat odkaz">
    <i class="bi bi-clipboard"></i> KopÃ­rovat pozvÃ¡nku
  </button>
</div>
  
<div class="col-12 mt-4" id="gdpr-consent-section">
  <h5>Souhlas se zveÅ™ejnÄ›nÃ­m kontaktÅ¯</h5>
  <p class="text-muted">
    Pokud souhlasÃ­te, vÃ¡Å¡ e-mail a telefon budou viditelnÃ© pro ostatnÃ­ uÅ¾ivatele.
  </p>
  <span id="consent-status" class="ms-2 text-muted"></span>
  <button type="button" class="btn btn-outline-primary mt-2" id="toggleConsentBtn">NaÄÃ­tÃ¡mâ€¦</button>
</div>



        <button type="submit" class="pilot-login-btn w-100">ğŸ’¾ UloÅ¾it zmÄ›ny</button>
        
        
      </div>
    </form>

<div id="status"></div>

  </div>

 <div id="chat-content">
    <!-- Zde se dynamicky naÄtou konverzace pilota -->
  </div>


  <script>

let currentPilot = null;
    const storedEmail = localStorage.getItem("loggedEmail");
const params = new URLSearchParams(window.location.search);
const email = params.get("email") || localStorage.getItem("loggedEmail");


if (!email) {
  // Pokud nenÃ­ e-mail ani v URL ani v localStorage, pÅ™esmÄ›ruj na pÅ™ihlÃ¡Å¡enÃ­
  window.location.href = "/login.html";
}
    const status = document.getElementById("status");



function addDroneField(value = "") {
  const container = document.getElementById("drones");
  const inputGroup = document.createElement("div");
  inputGroup.className = "input-group mb-2";

  const input = document.createElement("input");
  input.type = "text";
  input.name = "drones[]";
  input.className = "form-control";
  input.value = value;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "btn btn-outline-danger";
  removeBtn.innerHTML = "ğŸ—‘ï¸";
  removeBtn.onclick = () => inputGroup.remove();

  inputGroup.appendChild(input);
  inputGroup.appendChild(removeBtn);
  container.appendChild(inputGroup);
}


   fetch("/get-my-pilot?email=" + encodeURIComponent(email))
  .then(res => {
    if (!res.ok) throw new Error("NepÅ™ihlÃ¡Å¡en nebo pilot nenalezen");
    return res.json();
  })
  .then(pilot => {
  currentPilot = pilot;
  console.log("Data pilota:", pilot);

// NaÄti kategorie aÅ¾ teÄ (uÅ¾ znÃ¡me currentPilot)
fetch('/categories?ts=' + Date.now(), { cache: 'no-store' })
  .then(res => res.json())
  .then(categories => {
    const select = document.getElementById("specialization");
    select.innerHTML = ''; // multiselect: Å¾Ã¡dnÃ¡ default poloÅ¾ka

    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = String(cat.id);      // hodnota = ID
      option.textContent = cat.name;      // zobrazovanÃ½ text
      select.appendChild(option);
    });

    // PÅ™edvybrat podle specialization_ids (fallback podle nÃ¡zvÅ¯)
    const ids = Array.isArray(currentPilot?.specialization_ids)
      ? currentPilot.specialization_ids.map(String)
      : [];

    if (ids.length) {
      [...select.options].forEach(o => { o.selected = ids.includes(o.value); });
    } else if (currentPilot?.specialization) {
      const byName = currentPilot.specialization.split(',').map(s => s.trim());
      [...select.options].forEach(o => { o.selected = byName.includes(o.textContent); });
    }
  })
  .catch(err => console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ kategoriÃ­:", err));


// ğŸš¨ Handle GDPR consent section visibility
if (pilot.type_account === "Free") {
  document.getElementById("gdpr-consent-section").style.display = "none";
} else {
  document.getElementById("gdpr-consent-section").style.display = "block";
  const btn = document.getElementById("toggleConsentBtn");
  if (btn) btn.disabled = false;
}

  fetch('/get-my-consents?email=' + encodeURIComponent(pilot.email))
    .then(res => res.json())
    .then(data => {
      document.getElementById('publicContactConsent').checked = data.hasPublicConsent;
    })
    .catch(err => console.warn(err));

    // ğŸ”’ OmezenÃ­ pro Free ÃºÄet
if (pilot.type_account === "Free") {
  const availableSelect = document.getElementById("available");
  availableSelect.value = "ANO";      // pÅ™ednastavit ANO
  availableSelect.disabled = true;    // uzamknout

  document.getElementById("website").disabled = true;
  document.getElementById("note").disabled = true;

  // ğŸš« Uzamknout registraÄnÃ­ ÄÃ­slo
  document.getElementById("registrationnumber").disabled = true;

  // ğŸš« Ponechat jen 1 dron a zakÃ¡zat pÅ™idÃ¡vÃ¡nÃ­
  const addBtn = document.querySelector('button[onclick="addDroneField()"]');
  if (addBtn) addBtn.remove();
  // Odstranit nadbyteÄnÃ© drony (ponechat jen prvnÃ­)
  const dronesContainer = document.getElementById("drones");
  if (dronesContainer.children.length > 1) {
    [...dronesContainer.children].slice(1).forEach(el => el.remove());
  }

  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 1) {
      alert("Ve Free ÃºÄtu lze vybrat pouze jednu specializaci.");
      const lastSelected = this.selectedOptions[this.selectedOptions.length - 1].value;
      [...this.options].forEach(opt => opt.selected = (opt.value === lastSelected));
    }
  });
}
if (pilot.type_account === "Basic") {

  
   // Max 2 drony
  const addBtn = document.getElementById("add-drone-btn");
  addBtn.addEventListener("click", () => {
    const dronesContainer = document.getElementById("drones");
    if (dronesContainer.children.length >= 2) {
      alert("V Basic ÃºÄtu lze pÅ™idat maximÃ¡lnÄ› 2 drony.");
      return; // â›” zastavÃ­ pÅ™idÃ¡nÃ­
    }
    addDroneField();
  });

  // Max 2 specializace
  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 2) {
      alert("V Basic ÃºÄtu lze vybrat maximÃ¡lnÄ› 2 specializace.");
      this.selectedOptions[this.selectedOptions.length - 1].selected = false;
    }

  });
}


// GDPR â€“ novÃ© UI s tlaÄÃ­tkem
(function initGdprToggle() {
  const consentStatusElement = document.getElementById('consent-status');
  const toggleConsentBtn = document.getElementById('toggleConsentBtn');

  function setConsentUI(hasConsent, whenText = null) {
    if (!consentStatusElement || !toggleConsentBtn) return;
    if (hasConsent) {
      consentStatusElement.textContent = whenText ? `Souhlas udÄ›len: ${whenText}` : 'Souhlas udÄ›len';
      consentStatusElement.style.color = 'green';
      toggleConsentBtn.textContent = 'Odvolat souhlas';
      toggleConsentBtn.dataset.action = 'revoke';
    } else {
      consentStatusElement.textContent = 'Souhlas neudÄ›len';
      consentStatusElement.style.color = 'red';
      toggleConsentBtn.textContent = 'UdÄ›lit souhlas';
      toggleConsentBtn.dataset.action = 'grant';
    }
  }

  // 1) NaÄti timestamp souhlasu
  fetch('/get-consent-timestamp?email=' + encodeURIComponent(pilot.email))
    .then(res => {
      if (res.ok) return res.json();
      if (res.status === 404) return null;
      throw new Error('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ souhlasu');
    })
    .then(data => {
      if (data && data.timestamp) {
        const when = new Date(data.timestamp).toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' });
        setConsentUI(true, when);
      } else {
        setConsentUI(false);
      }
    })
    .catch(() => setConsentUI(false));

  // 2) PÅ™epÃ­naÄ â€“ udÄ›lit/odvolat
  if (toggleConsentBtn) {
    toggleConsentBtn.addEventListener('click', () => {
      const grant = toggleConsentBtn.dataset.action === 'grant';
      const consentDate = new Date();
      const formattedDate = consentDate.toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' });

      fetch('/save-consent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: pilot.email,
          consent_type: 'public_contact',
          consent_text: grant
            ? 'SouhlasÃ­m se zveÅ™ejnÄ›nÃ­m e-mailu a telefonu v mÃ©m profilu.'
            : 'OdvolÃ¡vÃ¡m souhlas se zveÅ™ejnÄ›nÃ­m e-mailu a telefonu v mÃ©m profilu.',
          granted: grant,
          timestamp: grant ? consentDate.toISOString() : null
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('Chyba pÅ™i uklÃ¡dÃ¡nÃ­ souhlasu');
        setConsentUI(grant, grant ? formattedDate : null);
      })
      .catch(err => {
        consentStatusElement.textContent = 'Chyba pÅ™i uklÃ¡dÃ¡nÃ­ souhlasu';
        consentStatusElement.style.color = 'red';
        alert(err.message);
      });
    });
  }
})();

    // ğŸŸ¢ ZobrazenÃ­ ÄlenstvÃ­ a odpoÄtu dnÃ­
    if (pilot.visible_valid) {
      const validDate = new Date(pilot.visible_valid);
      const today = new Date();
      const daysLeft = Math.ceil((validDate - today) / (1000 * 60 * 60 * 24));

      const membershipBox = document.getElementById("membership-status");
      const membershipText = document.getElementById("membership-text");

      if (membershipBox && membershipText) {
        membershipText.innerHTML = `<strong>ÄŒlenstvÃ­ platnÃ© do:</strong> ${validDate.toLocaleDateString('cs-CZ')} (${daysLeft} dnÃ­)`;

         // Add account type information
    let accountTypeText = '';
    if (pilot.type_account === "Free") {
      accountTypeText = '<span style="color: lightgreen; font-weight: bold;">Free</span>';
    } else if (pilot.type_account === "Basic") {
      accountTypeText = '<span style="color: darkgreen; font-weight: bold;">Basic</span>';
    } else if (pilot.type_account === "Premium") {
      accountTypeText = '<span style="color: purple; font-weight: bold;">Premium</span>';
    }

    membershipText.innerHTML += `<br><strong>Typ ÃºÄtu:</strong> ${accountTypeText}`;
        membershipBox.style.display = "flex";
        membershipBox.classList.remove("alert-success", "alert-warning", "alert-danger");

        if (daysLeft <= 0) {
      membershipBox.classList.add("alert-danger");
      
      // Popup alert when membership is expired or 0 days left
      alert("VaÅ¡e ÄlenstvÃ­ vyprÅ¡elo nebo je jiÅ¾ neplatnÃ©. BuÄto si mÅ¯Å¾ete pÅ™edplatit ÄlenstvÃ­ na strÃ¡nce <a href='/prodlouzit-clenstvi.html'>ProdlouÅ¾it ÄlenstvÃ­</a> nebo pokraÄovat v reÅ¾imu Free.");
    } else if (daysLeft <= 5) {
      membershipBox.classList.add("alert-warning");
    } else {
      membershipBox.classList.add("alert-success");
        }
      }


    }

    // ğŸ“ NaÄÃ­tÃ¡nÃ­ dat pilota do formulÃ¡Å™e
    document.getElementById("id").value = pilot.id || "";
    document.getElementById("name").value = pilot.name || "";
    document.getElementById("email").value = pilot.email || "";
    document.getElementById("phone").value = pilot.phone || "";
    document.getElementById("website").value = pilot.website || "";

    document.getElementById("registrationnumber").value = pilot.registrationnumber || "";
    document.getElementById("street").value = pilot.street || "";
    document.getElementById("city").value = pilot.city || "";
    document.getElementById("zip").value = pilot.zip || "";
    document.getElementById("region").value = pilot.region || "";

    const dronesArray = (pilot.drones || "").split(",").map(d => d.trim()).filter(d => d);
    dronesArray.forEach(d => addDroneField(d));
    if (dronesArray.length === 0) addDroneField();

    document.getElementById("note").value = pilot.note || "";
    document.getElementById("travel").value = pilot.travel || "";

    const licenses = (pilot.licenses || "").split(",").map(s => s.trim());
    document.querySelectorAll("input[name='licenses']").forEach(cb => {
      cb.checked = licenses.includes(cb.value);
    });

    if (pilot.specialization_ids?.length) {
  const sel = pilot.specialization_ids.map(String);
  [...document.getElementById("specialization").options].forEach(opt => {
    opt.selected = sel.includes(opt.value);
  });
}

    if (pilot.volunteer === "ANO") {
      document.getElementById("volunteer").checked = true;
    }

    document.getElementById("available").value = pilot.available || "";
  });


    document.getElementById("account-form").addEventListener("submit", async e => {
      e.preventDefault();


	const regNumberInput = document.getElementById("registrationnumber");
  if (!regNumberInput.checkValidity()) {
    // ZobrazÃ­ chybu, pokud je pole neplatnÃ©
    regNumberInput.focus(); // Scrolluje na problÃ©movÃ© pole
    document.getElementById("status").textContent = "âŒ Chyba: Zadejte platnÃ© registraÄnÃ­ ÄÃ­slo (formÃ¡t CZE + 10 znakÅ¯).";
    document.getElementById("status").classList.add("text-danger");
    return; // ZastavÃ­ odeslÃ¡nÃ­
  }

const specSelect = document.getElementById("specialization");
const specialization_ids = [...specSelect.selectedOptions].map(o => Number(o.value)).filter(n => Number.isInteger(n) && n > 0);
const specialization = [...specSelect.selectedOptions].map(o => o.textContent).join(", ");

      const data = {
        id: document.getElementById("id").value,
        email: document.getElementById("email").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        website: document.getElementById("website").value,
        registrationnumber: regNumberInput.value.trim(),
        street: document.getElementById("street").value,
        city: document.getElementById("city").value,
        zip: document.getElementById("zip").value,
        region: document.getElementById("region").value,
        drones: Array.from(document.getElementsByName("drones[]")).map(i => i.value.trim()).filter(v => v).join(", "),
        note: document.getElementById("note").value,
        travel: document.getElementById("travel").value,
        licenses: Array.from(document.querySelectorAll("input[name='licenses']:checked")).map(cb => cb.value).join(", "),
        specialization,          // text pro kompatibilitu (mÅ¯Å¾e bÃ½t i null)
  specialization_ids,      // hlavnÃ­ zdroj pravdy (ID),
        volunteer: document.getElementById("volunteer").checked ? "ANO" : "NE",
        available: document.getElementById("available").value,
      visible: currentPilot?.visible,
      visible_valid: currentPilot?.visible_valid,
      visible_payment: currentPilot?.visible_payment
      };

console.log("OdesÃ­lanÃ¡ data:", data);
      const res = await fetch("/update", {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8"  },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      status.textContent = text;
      status.classList.remove("text-danger", "text-success");
      status.classList.add(res.ok ? "text-success" : "text-danger");
	status.classList.toggle("text-success", res.ok);
  status.classList.toggle("text-danger", !res.ok);
    });

document.getElementById("copy-btn").addEventListener("click", () => {
  const refLink = document.getElementById("ref-link");
  const textToCopy = refLink.textContent.trim();

  // VytvoÅ™enÃ­ doÄasnÃ©ho textarea elementu pro kopÃ­rovÃ¡nÃ­ do schrÃ¡nky
  const textarea = document.createElement("textarea");
  textarea.value = textToCopy;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand("copy");
  document.body.removeChild(textarea);

  // ZmÄ›na textu tlaÄÃ­tka po ÃºspÄ›Å¡nÃ©m zkopÃ­rovÃ¡nÃ­
  const copyBtn = document.getElementById("copy-btn");
  copyBtn.textContent = "ZkopÃ­rovÃ¡no!";
  setTimeout(() => {
    copyBtn.textContent = "KopÃ­rovat";
  }, 2000);  // ObnovÃ­ text po 2 vteÅ™inÃ¡ch
});

document.addEventListener("DOMContentLoaded", () => {
  const noteInput = document.getElementById("note");
  const counter = document.getElementById("noteCounter");
  const maxLength = noteInput.getAttribute("maxlength");

  function updateCounter() {
    counter.textContent = `${noteInput.value.length} / ${maxLength} znakÅ¯`;
  }

  noteInput.addEventListener("input", updateCounter);
  updateCounter(); // inicializace pÅ™i naÄtenÃ­ strÃ¡nky
});

document.addEventListener('DOMContentLoaded', () => {
  const loggedEmail = localStorage.getItem('loggedEmail');
  const loggedAs = document.getElementById('loggedAs');
  if (loggedEmail && loggedAs) {
    loggedAs.textContent = `PÅ™ihlÃ¡Å¡en: ${loggedEmail}`;
  }

  // Zobraz PoptÃ¡vky jen pro Basic/Premium
  fetch('/get-my-pilot', { credentials: 'include' })
    .then(r => r.ok ? r.json() : null)
    .then(me => {
      const t = (me?.type_account || '').toLowerCase();
      if (t === 'basic' || t === 'premium') {
        document.getElementById('poptavkyBtn')?.classList.remove('d-none');
      }
    })
    .catch(() => {});
});

  </script>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const loggedEmail = localStorage.getItem('loggedEmail');
  const codeEl = document.getElementById('ref-code');
  const urlEl  = document.getElementById('ref-url');
  const copyBtn = document.getElementById('copy-btn');

  if (!loggedEmail || !codeEl || !urlEl || !copyBtn) return;

  try {
    const r = await fetch(`/ref-code?email=${encodeURIComponent(loggedEmail)}`, { credentials: 'include' });
    if (!r.ok) throw new Error('NepodaÅ™ilo se naÄÃ­st kÃ³d.');
    const { code, url } = await r.json();

    codeEl.textContent = code;  // zobrazÃ­me jen kÃ³d
    urlEl.textContent  = url;   // celÃ¡ URL pro kopÃ­rovÃ¡nÃ­ (skrytÃ¡)

    copyBtn.addEventListener('click', () => {
      const toCopy = urlEl.textContent.trim(); // kopÃ­ruje se celÃ¡ URL s kÃ³dem
      const ta = document.createElement('textarea');
      ta.value = toCopy;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      copyBtn.textContent = 'ZkopÃ­rovÃ¡no!';
      setTimeout(() => (copyBtn.textContent = 'KopÃ­rovat pozvÃ¡nku'), 2000);
    });
  } catch (e) {
    codeEl.textContent = 'â€”';
    copyBtn.disabled = true;
    copyBtn.title = 'KÃ³d se nepodaÅ™ilo naÄÃ­st';
    console.warn(e);
  }
});
</script>

<script>
  // badge do quickbaru (account.html)
  function renderUnreadBadgeIntoAccount(count) {
    const btn = document.querySelector('#account-quickbar a[href="/moje-zpravy.html"]');
    if (!btn) return;

    let badge = btn.querySelector('#unread-badge-account');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'unread-badge-account';
      badge.className = 'badge rounded-pill bg-danger ms-2';
      btn.appendChild(badge);
    }
    if (count > 0) {
      badge.textContent = String(count);
      badge.style.display = '';
    } else {
      badge.style.display = 'none';
    }
  }

  async function refreshUnreadAccountBadge() {
    const email = localStorage.getItem('loggedEmail');
    if (!email) return;
    try {
      const r = await fetch('/unread-count?pilotEmail=' + encodeURIComponent(email));
      const data = await r.json();
      renderUnreadBadgeIntoAccount(data.count || 0);
    } catch {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    const loggedEmail = localStorage.getItem('loggedEmail');
    if (loggedEmail) {
      refreshUnreadAccountBadge();
      setInterval(refreshUnreadAccountBadge, 60000);
    }
  });
</script>


 
</body>
</html>
