<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M≈Øj √∫ƒçet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <meta name="robots" content="index, follow">

 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="manifest" href="/icons/site.webmanifest">
<link rel="icon" href="/icons/favicon.ico" type="image/x-icon">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
 

<style>
  /* Styl pro ot√°ƒçen√≠ ≈°ipky u skr√Ωvateln√©ho n√°hledu */
  button[data-bs-target="#collapsePreview"][aria-expanded="true"] .collapse-arrow {
    transform: rotate(180deg);
  }
  .collapse-arrow {
    transition: transform 0.2s ease-in-out;
  }
</style> 


</head>
<body>
  <div id="account-quickbar" class="sticky-top bg-light border-bottom py-2 shadow-sm">
  <div class="container d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <a href="/index.html" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-map me-1"></i>Mapa
      </a>
      <a href="/moje-zpravy.html" class="btn btn-outline-secondary btn-sm ms-2">
        <i class="bi bi-envelope me-1"></i>Moje zpr√°vy
      </a>
      <a id="poptavkyBtn" href="/poptavky.html" class="btn btn-outline-secondary btn-sm ms-2 d-none">
        <i class="bi bi-clipboard-plus me-1"></i>Popt√°vky
      </a>

<!-- üîß Dopl≈àkov√© slu≈æby pro piloty -->
<div class="dropdown ms-2">
  <a class="btn btn-outline-secondary btn-sm dropdown-toggle d-flex align-items-center"
     href="#"
     role="button"
     data-bs-toggle="dropdown"
     aria-expanded="false">

    <i class="bi bi-tools me-1"></i>Slu≈æby pilota | v TESTOV√ÅN√ç!!!
  </a>

  <ul class="dropdown-menu">
    <li>
      <a class="dropdown-item"
         href="mailto:dronadmin@seznam.cz?subject=Anal√Ωza%20provozu&body=Chci%20poptat%20anal√Ωzu%20provozu.">
        üìç Anal√Ωza provozu (250 Kƒç)
      </a>
    </li>

    <li>
      <a class="dropdown-item"
         href="mailto:dronadmin@seznam.cz?subject=Legislativn√≠%20slu≈æby&body=Chci%20poptat%20legislativn√≠%20slu≈æby.">
        üìù Legislativa ‚Äì individu√°ln√≠ cena
      </a>
    </li>
  </ul>
</div>

      <a class="btn btn-outline-secondary btn-sm ms-2" 
   data-bs-toggle="collapse" 
   href="#collapsePreview" 
   role="button" 
   aria-expanded="false" 
   aria-controls="collapsePreview">
    <i class="bi bi-eye me-1"></i>N√°hled
    <i class="bi bi-chevron-down collapse-arrow ms-1"></i>
</a>

    </div>
    <span id="loggedAs" class="text-muted small d-none d-md-inline"></span>
  </div>
</div>
<br>

<div class="collapse" id="collapsePreview">
  <div class="container">
    <div class="p-3 border-bottom bg-white">

      <div class="btn-group d-flex w-100 mb-3" role="group">
        <input type="radio" class="btn-check" name="preview-toggle" id="preview-advertiser" autocomplete="off" checked>
        <label class="btn btn-outline-warning" for="preview-advertiser" style="font-size: 0.9em;">
          <i class="bi bi-person-check-fill me-1"></i> Jako p≈ôihl√°≈°en√Ω Inzerent
        </label>
      
        <input type="radio" class="btn-check" name="preview-toggle" id="preview-public" autocomplete="off">
        <label class="btn btn-outline-secondary" for="preview-public" style="font-size: 0.9em;">
          <i class="bi bi-person-fill me-1"></i> Jako Ve≈ôejnost (nep≈ôihl√°≈°en)
        </label>
      </div>
      <p class="text-center text-muted small mb-2" id="preview-helper-text">
        N√°hled se automaticky aktualizuje p≈ôi zmƒõnƒõ ve formul√°≈ôi.
      </p>
      <div id="map-preview-container" class="d-flex justify-content-center">
        <div id="map-preview-content" style="width: 100%; max-width: 450px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background-image: url('/icons/bg-map.png'); background-size: 300%; background-position: 30% 40%;">
          <div class="p-3 text-center text-muted">Naƒç√≠t√°m n√°hled...</div>
        </div>
      </div>
    </div>
  </div>
</div>
<br>

    <h1 class="text-center mb-4">üßë‚Äç‚úàÔ∏è √öƒçet pilota</h1>

    <form id="account-form" class="row g-3">
      <input type="hidden" id="id" name="id">
      


      <div class="col-md-6">
        <label class="form-label">Jm√©no:</label>
        <input type="text" id="name" name="name" class="form-control" required>
      </div>

      <div class="col-md-6">
  <label class="form-label">E-mail:</label>
  <div class="input-group">
    <input type="email" id="email" name="email" class="form-control" required readonly>
    <a href="/change_email.html" class="btn btn-outline-secondary btn-sm">Zmƒõnit</a>
  </div>
</div>


      <div class="col-md-6">
        <label class="form-label">Telefon:</label>
        <input type="tel" id="phone" name="phone" class="form-control">
      </div>

      <div class="col-md-6">
        <label class="form-label">Odkaz na portfolio ve form√°tu <i>https://...</i> :</label>
        <input type="url" id="website" name="website" class="form-control">
      </div>

<div class="col-md-6">
  <label class="form-label">
    Registraƒçn√≠ ƒç√≠slo provozovatele
    <span 
  data-bs-toggle="tooltip" 
  data-bs-placement="top" 
  title="Toto ƒç√≠slo se nikde nezobrazuje. Slou≈æ√≠ pouze k identifikaci provozovatele, kter√Ω t√≠mto potvrzuje leg√°ln√≠ provoz dronu. Vypl≈àte pouze ve≈ôejnou ƒç√°st." 
  style="cursor: help; font-size: 1rem; vertical-align: middle;">
  ‚ÑπÔ∏è
</span> : 
  </label>
  <input type="text" 
         id="registrationnumber" 
         name="registrationnumber" 
         class="form-control" 
         pattern="CZE[a-z A-Z 0-9]{13}" 
         maxlength="16" 
         data-bs-toggle="tooltip"
         title="Toto ƒç√≠slo se nikde nezobrazuje. Slou≈æ√≠ pouze k identifikaci provozovatele, kter√Ω t√≠mto potvrzuje leg√°ln√≠ provoz dronu.">
</div>





      <div class="col-md-4">
        <label class="form-label">Ulice:</label>
        <input type="text" id="street" name="street" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">Mƒõsto:</label>
        <input type="text" id="city" name="city" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label">PSƒå:</label>
        <input type="text" id="zip" name="zip" class="form-control">
      </div>

      <div class="col-12">
        <label for="region" class="form-label">Kraj:</label>
        <select id="region" name="region" class="form-select">
          <option value="">‚Äì Vyber kraj ‚Äì</option>
          <option value="Hlavn√≠ mƒõsto Praha">Hlavn√≠ mƒõsto Praha</option>
          <option value="St≈ôedoƒçesk√Ω kraj">St≈ôedoƒçesk√Ω kraj</option>
          <option value="Jihoƒçesk√Ω kraj">Jihoƒçesk√Ω kraj</option>
          <option value="Plze≈àsk√Ω kraj">Plze≈àsk√Ω kraj</option>
          <option value="Karlovarsk√Ω kraj">Karlovarsk√Ω kraj</option>
          <option value="√östeck√Ω kraj">√östeck√Ω kraj</option>
          <option value="Libereck√Ω kraj">Libereck√Ω kraj</option>
          <option value="Kr√°lov√©hradeck√Ω kraj">Kr√°lov√©hradeck√Ω kraj</option>
          <option value="Pardubick√Ω kraj">Pardubick√Ω kraj</option>
          <option value="Kraj Vysoƒçina">Kraj Vysoƒçina</option>
          <option value="Jihomoravsk√Ω kraj">Jihomoravsk√Ω kraj</option>
          <option value="Olomouck√Ω kraj">Olomouck√Ω kraj</option>
          <option value="Zl√≠nsk√Ω kraj">Zl√≠nsk√Ω kraj</option>
          <option value="Moravskoslezsk√Ω kraj">Moravskoslezsk√Ω kraj</option>
        </select>
      </div>

	<div class="alert alert-info" style="margin-top: 10px;">
  üìç Pokud se nezobrazuje≈° na mapƒõ, zkontroluj spr√°vnost adresy. Nejl√©pe funguje, pokud uvede≈° <strong>ulici, mƒõsto a kraj</strong>.
</div>

      <div class="col-12">
        <label class="form-label">Povolen√≠ (licence):</label><br>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A1/A3" id="a1a3">
          <label class="form-check-label" for="a1a3">A1/A3</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="OPEN A2" id="a2">
          <label class="form-check-label" for="a2">A2</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="LUC" id="luc">
          <label class="form-check-label" for="luc">LUC</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="licenses" value="SPECIFIC" id="specific">
          <label class="form-check-label" for="specific">SPECIFIC</label>
        </div>
      </div>

      <div class="col-md-6">
  <label class="form-label">Dron / vybaven√≠:</label>
  <div id="drones"></div>

  <button type="button" id="add-drone-btn" class="btn-sm mt-2">
  <span class="me-1">+</span> P≈ôidat dron / vybaven√≠
</button>

</div>

      <div class="col-md-6">
        <label class="form-label">Ochota doj√≠≈ædƒõt:</label>
        <select id="travel" name="travel" class="form-select">
          <option value="">‚Äì Vyber ‚Äì</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


<div class="col-md-6">
        <label class="form-label">Jsem k dispozici:</label>
        <select id="available" name="available" class="form-select">
          <option value="">‚Äì Vyber ‚Äì</option>
          <option value="ANO">ANO</option>
          <option value="NE">NE</option>
        </select>
      </div>


      <div class="col-12">
        <label class="form-label">Specializace:</label>
        <input type="text" id="specializationSearch" class="form-control mb-2" placeholder="Hledat specializaci‚Ä¶">

        <select id="specialization" name="specialization" multiple class="form-select"></select>

      <button type="button" id="addCategoryBtn" class="btn btn-outline-primary btn-sm mt-2 d-none">
    ‚ûï P≈ôidat vlastn√≠ specializaci
</button>

      </div>

      <div class="col-12">
        <label class="form-label">Pozn√°mka:</label>
        <textarea id="note" name="note" rows="3" class="form-control" maxlength="80"></textarea>
<small id="noteCounter" class="text-muted">0 / 80 znak≈Ø</small>

      </div>

      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="volunteer" name="volunteer" value="ANO">
          <label class="form-check-label" for="volunteer">Dobrovoln√≠k</label>
        </div>
      </div>


      <a href="/changepass.html">Zmƒõnit heslo</a>

      <div class="col-12">
        <div id="membership-status" class="alert alert-light border d-flex justify-content-between align-items-center" style="display: none;">
  <span id="membership-text"></span>
  <a href="/prodlouzit-clenstvi.html" class="btn btn-sm btn-outline-primary">Prodlou≈æit ƒçlenstv√≠</a>
</div>
<div class="alert alert-secondary mt-4">
  üì¢ Pozvi kamar√°da a z√≠skej na t√Ωden ƒçlenstv√≠ <b>zdarma!</b><br>
  Tv≈Øj odkaz: 
   <code id="ref-code">‚Äî</code>
  <span id="ref-url" class="d-none"></span>
  <button id="copy-btn" class="btn pilot-login-button btn-sm ms-2 w-100" title="Kop√≠rovat odkaz">
    <i class="bi bi-clipboard"></i> Kop√≠rovat pozv√°nku
  </button>
</div>
  
<div class="col-12 mt-4" id="gdpr-consent-section">
  <h5>Souhlas se zve≈ôejnƒõn√≠m kontakt≈Ø</h5>
  <p class="text-muted">
    Pokud souhlas√≠te, v√°≈° e-mail a telefon budou viditeln√© pro ostatn√≠ u≈æivatele.
  </p>
  <span id="consent-status" class="ms-2 text-muted"></span>
  <button type="button" class="btn btn-outline-primary mt-2" id="toggleConsentBtn">Naƒç√≠t√°m‚Ä¶</button>
</div>



        <button type="submit" class="pilot-login-btn w-100">üíæ Ulo≈æit zmƒõny</button>
        <button type="button" id="deleteAccountBtn" class="btn btn-danger w-100 mt-3">
  üóëÔ∏è Smazat √∫ƒçet
</button>




  
        
        
      </div>
    </form>

<div id="status"></div>




  <script>
// --- Hlavn√≠ skript pro formul√°≈ô ---
let currentPilot = null;
    const storedEmail = localStorage.getItem("loggedEmail");
const params = new URLSearchParams(window.location.search);
const email = params.get("email") || localStorage.getItem("loggedEmail");


if (!email) {
  // Pokud nen√≠ e-mail ani v URL ani v localStorage, p≈ôesmƒõruj na p≈ôihl√°≈°en√≠
  window.location.href = "/login.html";
}
    const status = document.getElementById("status");



function addDroneField(value = "") {
  const container = document.getElementById("drones");
  const inputGroup = document.createElement("div");
  inputGroup.className = "input-group mb-2";

  const input = document.createElement("input");
  input.type = "text";
  input.name = "drones[]";
  input.className = "form-control";
  input.value = value;

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "btn btn-outline-danger";
  removeBtn.innerHTML = "üóëÔ∏è";
  removeBtn.onclick = () => inputGroup.remove();

  inputGroup.appendChild(input);
  inputGroup.appendChild(removeBtn);
  container.appendChild(inputGroup);
}


   fetch("/get-my-pilot?email=" + encodeURIComponent(email))
  .then(res => {
    if (!res.ok) throw new Error("Nep≈ôihl√°≈°en nebo pilot nenalezen");
    return res.json();
  })
  .then(pilot => {
  currentPilot = pilot;
  renderMapPreview(); // <-- TADY POPRV√â KRESL√çME N√ÅHLED
  console.log("Data pilota:", pilot);

// Naƒçti kategorie a≈æ teƒè (u≈æ zn√°me currentPilot)
fetch('/categories?ts=' + Date.now(), { cache: 'no-store' })
  .then(res => res.json())
  .then(categories => {
    const select = document.getElementById("specialization");
    select.innerHTML = ''; // multiselect: ≈æ√°dn√° default polo≈æka

    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = String(cat.id);      // hodnota = ID
      option.textContent = cat.name;      // zobrazovan√Ω text
      select.appendChild(option);
    });

    // P≈ôedvybrat podle specialization_ids (fallback podle n√°zv≈Ø)
    const ids = Array.isArray(currentPilot?.specialization_ids)
      ? currentPilot.specialization_ids.map(String)
      : [];

    if (ids.length) {
      [...select.options].forEach(o => { o.selected = ids.includes(o.value); });
    } else if (currentPilot?.specialization) {
      const byName = currentPilot.specialization.split(',').map(s => s.trim());
      [...select.options].forEach(o => { o.selected = byName.includes(o.textContent); });
    }
  })
  .catch(err => console.error("Chyba p≈ôi naƒç√≠t√°n√≠ kategori√≠:", err));



// üîç FULLTEXT hled√°n√≠ specializac√≠ ‚Äì filtruje <select> podle textu
document.getElementById("specializationSearch").addEventListener("input", function () {
  const term = this.value.toLowerCase();
  const select = document.getElementById("specialization");

  [...select.options].forEach(opt => {
    const text = opt.textContent.toLowerCase();
    opt.style.display = text.includes(term) ? "block" : "none";
  });
});




// üö® Handle GDPR consent section visibility
if (pilot.type_account === "Free") {
  document.getElementById("gdpr-consent-section").style.display = "none";
} else {
  document.getElementById("gdpr-consent-section").style.display = "block";
  const btn = document.getElementById("toggleConsentBtn");
  if (btn) btn.disabled = false;
}

//  Tento blok 'get-my-consents' je nahrazen novou logikou v 'initGdprToggle'
//  fetch('/get-my-consents?email=' + encodeURIComponent(pilot.email))
//    .then(res => res.json())
//    .then(data => {
//      document.getElementById('publicContactConsent').checked = data.hasPublicConsent;
//    })
//    .catch(err => console.warn(err));

    // üîí Omezen√≠ pro Free √∫ƒçet
if (pilot.type_account === "Free") {
  const availableSelect = document.getElementById("available");
  availableSelect.value = "ANO";      // p≈ôednastavit ANO
  availableSelect.disabled = true;    // uzamknout

  document.getElementById("website").disabled = true;
  document.getElementById("note").disabled = true;

  // üö´ Uzamknout registraƒçn√≠ ƒç√≠slo
  document.getElementById("registrationnumber").disabled = true;

  // üö´ Ponechat jen 1 dron a zak√°zat p≈ôid√°v√°n√≠
  // Odeb√≠r√°me tlaƒç√≠tko podle ID, ne podle onclick
  const addBtn = document.getElementById("add-drone-btn");
  if (addBtn) addBtn.style.display = 'none'; // Skryjeme tlaƒç√≠tko
  
  // Odstranit nadbyteƒçn√© drony (ponechat jen prvn√≠)
  const dronesContainer = document.getElementById("drones");
  if (dronesContainer.children.length > 1) {
    [...dronesContainer.children].slice(1).forEach(el => el.remove());
  }

  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 1) {
      alert("Ve Free √∫ƒçtu lze vybrat pouze jednu specializaci.");
      const lastSelected = this.selectedOptions[this.selectedOptions.length - 1].value;
      [...this.options].forEach(opt => opt.selected = (opt.value === lastSelected));
    }
  });
}
if (pilot.type_account === "Basic") {

  
   // Max 2 drony
  const addBtn = document.getElementById("add-drone-btn");
  addBtn.addEventListener("click", () => {
    const dronesContainer = document.getElementById("drones");
    if (dronesContainer.children.length >= 2) {
      alert("V Basic √∫ƒçtu lze p≈ôidat maxim√°lnƒõ 2 drony.");
      return; // ‚õî zastav√≠ p≈ôid√°n√≠
    }
    addDroneField();
  });

  // Max 2 specializace
  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 2) {
      alert("V Basic √∫ƒçtu lze vybrat maxim√°lnƒõ 2 specializace.");
      this.selectedOptions[this.selectedOptions.length - 1].selected = false;
    }

  });
}

if (pilot.type_account === "Premium") {

  // ‚ûï Zviditelni tlaƒç√≠tko pro p≈ôid√°n√≠ vlastn√≠ specializace
  const addBtn = document.getElementById("addCategoryBtn");
  if (addBtn) addBtn.classList.remove("d-none");


  // Max 10 specializac√≠
  const specializationSelect = document.getElementById("specialization");
  specializationSelect.addEventListener("change", function () {
    if (this.selectedOptions.length > 10) {
      alert("V Premium √∫ƒçtu lze vybrat maxim√°lnƒõ 10 specializac√≠.");
      this.selectedOptions[this.selectedOptions.length - 1].selected = false;
    }
  });
}

// ‚ûï Funkce pro p≈ôid√°n√≠ nov√© specializace (Premium)
const addCategoryBtn = document.getElementById("addCategoryBtn");
if (addCategoryBtn) {
  addCategoryBtn.addEventListener("click", async () => {
    const name = prompt("Zadej n√°zev nov√© specializace:");

    if (!name || !name.trim()) return;

    try {
      const res = await fetch("/add-category", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim() })
      });

      let data;
try {
  data = await res.json();
} catch {
  // Pokud odpovƒõƒè nen√≠ JSON ‚Üí pova≈æuj to za √∫spƒõch, ale znovu naƒçti seznam kategori√≠
  console.warn("Odpovƒõƒè nebyla JSON ‚Äì pravdƒõpodobnƒõ √∫spƒõch, ale bez JSON.");
  await reloadCategoriesAfterAdd(name.trim());
  alert("Specializace p≈ôid√°na.");
  return;
}


      if (data.error) {
        alert("Chyba: " + data.error);
        return;
      }

      // P≈ôid√°n√≠ nov√© specializace do Choices.js
window.choicesSpecialization.setChoices(
  [{ value: data.id, label: data.name, selected: true }],
  'value',
  'label',
  true
);



      alert("Specializace p≈ôid√°na.");

    } catch (err) {
      console.error(err);
      alert("Specializace p≈ôid√°na.");
    }
  });
}


// Po naƒçten√≠ pilota (tam, kde je currentPilot = pilot)
if (!pilot.latitude || !pilot.longitude) {
  const warning = document.createElement("div");
  warning.className = "alert alert-danger mt-3";
  warning.innerHTML = "‚ö†Ô∏è Va≈°e poloha se nezobrazuje spr√°vnƒõ. Pros√≠m, upravte adresu.";
  const form = document.getElementById("account-form");
  form.parentNode.insertBefore(warning, form);
}



// GDPR ‚Äì nov√© UI s tlaƒç√≠tkem
(function initGdprToggle() {
  const consentStatusElement = document.getElementById('consent-status');
  const toggleConsentBtn = document.getElementById('toggleConsentBtn');

  function setConsentUI(hasConsent, whenText = null) {
    if (!consentStatusElement || !toggleConsentBtn) return;
    if (hasConsent) {
      consentStatusElement.textContent = whenText ? `Souhlas udƒõlen: ${whenText}` : 'Souhlas udƒõlen';
      consentStatusElement.style.color = 'green';
      toggleConsentBtn.textContent = 'Odvolat souhlas';
      toggleConsentBtn.dataset.action = 'revoke';
    } else {
      consentStatusElement.textContent = 'Souhlas neudƒõlen';
      consentStatusElement.style.color = 'red';
      toggleConsentBtn.textContent = 'Udƒõlit souhlas';
      toggleConsentBtn.dataset.action = 'grant';
    }
  }

  // 1) Naƒçti timestamp souhlasu
  fetch('/get-consent-timestamp?email=' + encodeURIComponent(pilot.email))
    .then(res => {
      if (res.ok) return res.json();
      if (res.status === 404) return null;
      throw new Error('Chyba p≈ôi naƒç√≠t√°n√≠ souhlasu');
    })
    .then(data => {
      const hasConsent = data && data.timestamp;
      if (currentPilot) currentPilot.hasPublicConsent = !!hasConsent; // <-- AKTUALIZACE STAVU
      
      if (hasConsent) {
        const when = new Date(data.timestamp).toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' });
        setConsentUI(true, when);
      } else {
        setConsentUI(false);
      }
      renderMapPreview(); // <-- P≈òEKRESLEN√ç PO NAƒåTEN√ç SOUHLASU
    })
    .catch(() => {
        if (currentPilot) currentPilot.hasPublicConsent = false; // <-- AKTUALIZACE STAVU
        setConsentUI(false);
        renderMapPreview(); // <-- P≈òEKRESLEN√ç I P≈òI CHYBƒö
    });

  // 2) P≈ôep√≠naƒç ‚Äì udƒõlit/odvolat
  if (toggleConsentBtn) {
    toggleConsentBtn.addEventListener('click', () => {
      const grant = toggleConsentBtn.dataset.action === 'grant';
      const consentDate = new Date();
      const formattedDate = consentDate.toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' });

      fetch('/save-consent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: pilot.email,
          consent_type: 'public_contact',
          consent_text: grant
            ? 'Souhlas√≠m se zve≈ôejnƒõn√≠m e-mailu a telefonu v m√©m profilu.'
            : 'Odvol√°v√°m souhlas se zve≈ôejnƒõn√≠m e-mailu a telefonu v m√©m profilu.',
          granted: grant,
          timestamp: grant ? consentDate.toISOString() : null
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('Chyba p≈ôi ukl√°d√°n√≠ souhlasu');
        setConsentUI(grant, grant ? formattedDate : null);
        
        if (currentPilot) currentPilot.hasPublicConsent = grant; // <-- AKTUALIZACE STAVU
        renderMapPreview(); // <-- P≈òEKRESLEN√ç PO ZMƒöNƒö
      })
      .catch(err => {
        consentStatusElement.textContent = 'Chyba p≈ôi ukl√°d√°n√≠ souhlasu';
        consentStatusElement.style.color = 'red';
        alert(err.message);
      });
    });
  }
})();

    // üü¢ Zobrazen√≠ ƒçlenstv√≠ a odpoƒçtu dn√≠
    if (pilot.visible_valid) {
      const validDate = new Date(pilot.visible_valid);
      const today = new Date();
      const daysLeft = Math.ceil((validDate - today) / (1000 * 60 * 60 * 24));

      const membershipBox = document.getElementById("membership-status");
      const membershipText = document.getElementById("membership-text");

      if (membershipBox && membershipText) {
        membershipText.innerHTML = `<strong>ƒålenstv√≠ platn√© do:</strong> ${validDate.toLocaleDateString('cs-CZ')} (${daysLeft} dn√≠)`;

         // Add account type information
    let accountTypeText = '';
    if (pilot.type_account === "Free") {
      accountTypeText = '<span style="color: lightgreen; font-weight: bold;">Free</span>';
    } else if (pilot.type_account === "Basic") {
      accountTypeText = '<span style="color: darkgreen; font-weight: bold;">Basic</span>';
    } else if (pilot.type_account === "Premium") {
      accountTypeText = '<span style="color: purple; font-weight: bold;">Premium</span>';
    }

    membershipText.innerHTML += `<br><strong>Typ √∫ƒçtu:</strong> ${accountTypeText}`;
        membershipBox.style.display = "flex";
        membershipBox.classList.remove("alert-success", "alert-warning", "alert-danger");

        if (daysLeft <= 0) {
      membershipBox.classList.add("alert-danger");
      
      // Popup alert when membership is expired or 0 days left
      alert("Va≈°e ƒçlenstv√≠ vypr≈°elo nebo je ji≈æ neplatn√©. Buƒèto si m≈Ø≈æete p≈ôedplatit ƒçlenstv√≠ na str√°nce /prodlouzit-clenstvi.html nebo pokraƒçovat v re≈æimu Free.");
    } else if (daysLeft <= 5) {
      membershipBox.classList.add("alert-warning");
    } else {
      membershipBox.classList.add("alert-success");
        }
      }


    }

    // üìù Naƒç√≠t√°n√≠ dat pilota do formul√°≈ôe
    document.getElementById("id").value = pilot.id || "";
    document.getElementById("name").value = pilot.name || "";
    document.getElementById("email").value = pilot.email || "";
    document.getElementById("phone").value = pilot.phone || "";
    document.getElementById("website").value = pilot.website || "";

    document.getElementById("registrationnumber").value = pilot.registrationnumber || "";
    document.getElementById("street").value = pilot.street || "";
    document.getElementById("city").value = pilot.city || "";
    document.getElementById("zip").value = pilot.zip || "";
    document.getElementById("region").value = pilot.region || "";

    const dronesArray = (pilot.drones || "").split(",").map(d => d.trim()).filter(d => d);
    dronesArray.forEach(d => addDroneField(d));
    if (dronesArray.length === 0) addDroneField();

    document.getElementById("note").value = pilot.note || "";
    document.getElementById("travel").value = pilot.travel || "";

    const licenses = (pilot.licenses || "").split(",").map(s => s.trim());
    document.querySelectorAll("input[name='licenses']").forEach(cb => {
      cb.checked = licenses.includes(cb.value);
    });

    if (pilot.specialization_ids?.length) {
  const sel = pilot.specialization_ids.map(String);
  [...document.getElementById("specialization").options].forEach(opt => {
    opt.selected = sel.includes(opt.value);
  });
}

    if (pilot.volunteer === "ANO") {
      document.getElementById("volunteer").checked = true;
    }

    document.getElementById("available").value = pilot.available || "";
  });


    document.getElementById("account-form").addEventListener("submit", async e => {
      e.preventDefault();


	const regNumberInput = document.getElementById("registrationnumber");
  if (!regNumberInput.checkValidity()) {
    // Zobraz√≠ chybu, pokud je pole neplatn√©
    regNumberInput.focus(); // Scrolluje na probl√©mov√© pole
    document.getElementById("status").textContent = "‚ùå Chyba: Zadejte platn√© registraƒçn√≠ ƒç√≠slo (form√°t CZE + 10 znak≈Ø).";
    document.getElementById("status").classList.add("text-danger");
    return; // Zastav√≠ odesl√°n√≠
  }

const specSelect = document.getElementById("specialization");
const specialization_ids = [...specSelect.selectedOptions].map(o => Number(o.value)).filter(n => Number.isInteger(n) && n > 0);
const specialization = [...specSelect.selectedOptions].map(o => o.textContent).join(", ");

      const data = {
        id: document.getElementById("id").value,
        email: document.getElementById("email").value,
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        website: document.getElementById("website").value,
        registrationnumber: regNumberInput.value.trim(),
        street: document.getElementById("street").value,
        city: document.getElementById("city").value,
        zip: document.getElementById("zip").value,
        region: document.getElementById("region").value,
        drones: Array.from(document.getElementsByName("drones[]")).map(i => i.value.trim()).filter(v => v).join(", "),
        note: document.getElementById("note").value,
        travel: document.getElementById("travel").value,
        licenses: Array.from(document.querySelectorAll("input[name='licenses']:checked")).map(cb => cb.value).join(", "),
        specialization,          // text pro kompatibilitu (m≈Ø≈æe b√Ωt i null)
  specialization_ids,      // hlavn√≠ zdroj pravdy (ID),
        volunteer: document.getElementById("volunteer").checked ? "ANO" : "NE",
        available: document.getElementById("available").value,
      visible: currentPilot?.visible,
      visible_valid: currentPilot?.visible_valid,
      visible_payment: currentPilot?.visible_payment
      };

console.log("Odes√≠lan√° data:", data);
      const res = await fetch("/update", {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8"  },
        body: JSON.stringify(data)
      });

      const text = await res.text();
      status.textContent = text;
      status.classList.remove("text-danger", "text-success");
      status.classList.add(res.ok ? "text-success" : "text-danger");
	status.classList.toggle("text-success", res.ok);
  status.classList.toggle("text-danger", !res.ok);
    });
</script>


<script>
// --- Skript pro poƒç√≠tadlo znak≈Ø a dynamick√© listenery ---
document.addEventListener("DOMContentLoaded", () => {
  const noteInput = document.getElementById("note");
  const counter = document.getElementById("noteCounter");
  const maxLength = noteInput.getAttribute("maxlength");

  function updateCounter() {
    counter.textContent = `${noteInput.value.length} / ${maxLength} znak≈Ø`;
  }

  noteInput.addEventListener("input", updateCounter);
  updateCounter(); // inicializace p≈ôi naƒçten√≠ str√°nky
  
  // P≈ôid√°n√≠ listener≈Ø pro dynamick√Ω n√°hled
  const form = document.getElementById("account-form");
  if (form) {
      // 'input' reaguje na psan√≠ (text, textarea)
      form.addEventListener('input', renderMapPreview); 
      // 'change' reaguje na zmƒõnu (select, checkbox)
      form.addEventListener('change', renderMapPreview); 
  }

  // --- ‚¨áÔ∏è P≈òID√ÅNO ‚¨áÔ∏è ---
  // Listenery pro p≈ôep√≠naƒç n√°hledu
  document.getElementById('preview-advertiser').addEventListener('change', renderMapPreview);
  document.getElementById('preview-public').addEventListener('change', renderMapPreview);
  // --- ‚¨ÜÔ∏è KONEC P≈òID√ÅN√ç ‚¨ÜÔ∏è ---
});
</script>


<script>
// --- Skript pro Quickbar a Popt√°vky ---
document.addEventListener('DOMContentLoaded', () => {
  const loggedEmail = localStorage.getItem('loggedEmail');
  const loggedAs = document.getElementById('loggedAs');
  if (loggedEmail && loggedAs) {
    loggedAs.textContent = `P≈ôihl√°≈°en: ${loggedEmail}`;
  }

   // üü¢ Naƒçti data pilota podle e-mailu z localStorage
  fetch(`/get-my-pilot?email=${encodeURIComponent(loggedEmail)}`, { cache: 'no-store' })
    .then(res => res.ok ? res.json() : null)
    .then(pilot => {
      if (!pilot) return;

      // ‚úÖ Zobraz "Popt√°vky" pro Basic a Premium √∫ƒçty
      const type = (pilot.type_account || '').toLowerCase();
      if (type === 'basic' || type === 'premium') {
        document.getElementById('poptavkyBtn')?.classList.remove('d-none');
      }
    })
    .catch(err => console.warn('Chyba p≈ôi naƒç√≠t√°n√≠ pilota:', err));
});
</script>


<script>
// --- Skript pro Referral k√≥d ---
document.addEventListener('DOMContentLoaded', async () => {
  const loggedEmail = localStorage.getItem('loggedEmail');
  const codeEl = document.getElementById('ref-code');
  const urlEl  = document.getElementById('ref-url');
  const copyBtn = document.getElementById('copy-btn');

  if (!loggedEmail || !codeEl || !urlEl || !copyBtn) return;

  try {
    const r = await fetch(`/ref-code?email=${encodeURIComponent(loggedEmail)}`, { credentials: 'include' });
    if (!r.ok) throw new Error('Nepoda≈ôilo se naƒç√≠st k√≥d.');
    const { code, url } = await r.json();

    codeEl.textContent = code;  // zobraz√≠me jen k√≥d
    urlEl.textContent  = url;   // cel√° URL pro kop√≠rov√°n√≠ (skryt√°)

    copyBtn.addEventListener('click', () => {
      const toCopy = urlEl.textContent.trim(); // kop√≠ruje se cel√° URL s k√≥dem
      const ta = document.createElement('textarea');
      ta.value = toCopy;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      copyBtn.textContent = 'Zkop√≠rov√°no!';
      setTimeout(() => (copyBtn.textContent = 'Kop√≠rovat pozv√°nku'), 2000);
    });
  } catch (e) {
    codeEl.textContent = '‚Äî';
    copyBtn.disabled = true;
    copyBtn.title = 'K√≥d se nepoda≈ôilo naƒç√≠st';
    console.warn(e);
  }
});
</script>


<script>
// --- Skript pro Unread Badge ---
  // badge do quickbaru (account.html)
  function renderUnreadBadgeIntoAccount(count) {
    const btn = document.querySelector('#account-quickbar a[href="/moje-zpravy.html"]');
    if (!btn) return;

    let badge = btn.querySelector('#unread-badge-account');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'unread-badge-account';
      badge.className = 'badge rounded-pill bg-danger ms-2';
      btn.appendChild(badge);
    }
    if (count > 0) {
      badge.textContent = String(count);
      badge.style.display = '';
    } else {
      badge.style.display = 'none';
    }
  }

  async function refreshUnreadAccountBadge() {
    const email = localStorage.getItem('loggedEmail');
    if (!email) return;
    try {
      const r = await fetch('/unread-count?pilotEmail=' + encodeURIComponent(email));
      const data = await r.json();
      renderUnreadBadgeIntoAccount(data.count || 0);
    } catch {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    const loggedEmail = localStorage.getItem('loggedEmail');
    if (loggedEmail) {
      refreshUnreadAccountBadge();
      setInterval(refreshUnreadAccountBadge, 60000);
    }
  });
</script>


<script>
// --- Z√°vislosti zkop√≠rovan√© z onlymap.html ---
const fakeNames = [
    "Rychl√Ω Sysel", "L√©taj√≠c√≠ Brambor", "Dronislav Nebe≈°≈•√°k", "Turbo R√°kosn√≠k", "Bezpilotn√≠ Emil", "P√≠skaj√≠c√≠ P√°v", "Pilotka Haluz", "Franti≈°ek Vrtuln√≠k", "Lev√Ω Joystick", "Kapit√°n St√≠n", "Dr. Rotor", "Pan Toƒçiv√Ω", "Letu≈°ka Landov√°", "St≈ôemhlav√Ω Franta", "Nadzvukov√Ω Je≈æek", "L√©taj√≠c√≠ ƒåenda", "Rotorov√° R√≥za", "≈†um√≠c√≠ Fanda", "Bezpeƒçn√Ω B√©ƒèa", "Maj√°k z Oblak", "Dron√Ω Karel", "Letec ≈†matla", "Start√©r Stan√≠k", "P≈ôist√°vac√≠ Pepa", "Helikopt√©rn√≠k Honza", "Navig√°tor Nov√°k", "Senzorov√° So≈àa", "P√°n Mrak≈Ø", "Let√≠c√≠ Lojza", "Kamera Kamil", "Rotor R√≠≈°a", "V√Ω≈°komƒõr Va≈°ek", "Vzdu≈°n√Ω Vojta", "Tich√Ω ≈†um√°k", "Drnƒçiv√Ω Dan", "Mlha Milda", "Optika Otakar", "Ztracen√Ω Sign√°l", "Mistr Gimbal", "Ant√©na Aniƒçka", "Vrtulka Vƒõrka", "Letmo L√≠da", "Flyboy Felix", "Vzdu≈°n√° V√≠la", "Navigaƒçn√≠ Norbert", "Modr√° Letka", "K≈ô√≠dlat√Ω Karel", "Poln√≠ P≈ô√≠zrak", "Mapov√Ω Mirek", "Kliƒçkuj√≠c√≠ Kuba"
];

function normalizeConsent(v) {
    if (typeof v === 'boolean') return v;
    const s = String(v ?? '').trim().toLowerCase();
    return s === 'true' || s === 't' || s === '1' || s === 'ano' || s === 'yes';
}

/**
 * Zkop√≠rovan√° a upraven√° funkce z onlymap.html pro generov√°n√≠ HTML n√°hledu.
 */
function createPreviewPopup(p, loggedIn) { // 'loggedIn' je nyn√≠ parametr
  if (!p) return '<div class="p-3 text-center text-muted">Data pilota zat√≠m nejsou naƒçtena.</div>';

  const popupContent = document.createElement('div');
  popupContent.className = 'pilot-card p-3'; // P≈ôid√°na t≈ô√≠da p-3 pro vnit≈ôn√≠ odsazen√≠

  const isAvailable = p.available === "ANO";
  const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
  const hasBuildBadge = p.id && Number(p.id) <= 80;
  const buildBadge = hasBuildBadge
    ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
    : "";
  const pilotNameWithBadge = `${p.name || 'Pilot bez jm√©na'}${buildBadge}`;
  const fakeNameWithBadge = `${fakeName}${buildBadge}`;
  
  const hasPublicConsent = normalizeConsent(p.hasPublicConsent ?? false); 
  
  const isVerified =
    p.registrationnumber &&
    p.registrationnumber.startsWith("CZE") &&
    p.registrationnumber.length === 16;

  let html = '';

  // --- GDPR nesouhlas ---
  if (!hasPublicConsent) {
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0" style="font-size: 1.25rem;"><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
      </div>
      <div class="d-flex flex-wrap gap-2 mb-2">
        ${p.volunteer === 'ANO' ? `<span class="badge-volunteer" style="background-color: #0d6efd; color: #fff; padding: .35em .65em; font-size: .75em; font-weight: 700; border-radius: .25rem;">Dobrovoln√≠k</span>` : ''}
        <span class="badge-gdpr" style="background-color: #dc3545; color: white; padding: .35em .65em; font-size: .75em; font-weight: 700; border-radius: .25rem;">Bez GDPR souhlasu ‚Äì kontakt p≈ôes administr√°tora</span>
      </div>
      ${p.specialization ? `<p class="mb-1"><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    `;
  }

  // --- Nedostupn√Ω pilot ---
  else if (!isAvailable) {
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0" style="font-size: 1.25rem;"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
        ${isVerified ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer" style="background-color: #0d6efd; color: #fff; padding: .35em .65em; font-size: .75em; font-weight: 700; border-radius: .25rem;">Dobrovoln√≠k</span></div>` : ''}
      <p class="text-danger mb-1"><i class="bi bi-exclamation-triangle-fill me-1"></i>Tento pilot moment√°lnƒõ nen√≠ k dispozici</p>
      ${p.specialization ? `<p class="mb-1"><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    `;
  }

  // --- P≈ôihl√°≈°en√Ω inzerent (hlavn√≠ logika) ---
  else if (loggedIn) { 
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0" style="font-size: 1.25rem;"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
        ${isVerified ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer" style="background-color: #0d6efd; color: #fff; padding: .35em .65em; font-size: .75em; font-weight: 700; border-radius: .25rem;">Dobrovoln√≠k</span></div>` : ''}
    `;

    // === BASIC √∫ƒçet ===
    if (p.type_account === "Basic") {
      if (p.drones) html += `<p class="mb-1"><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.note) html += `<p class="mb-1"><i class="bi bi-chat-left-text me-1"></i><strong>O mnƒõ:</strong> ${p.note}</p>`;
      if (p.travel) html += `<p class="mb-1"><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>`;
      if (p.licenses) html += `<p class="mb-1"><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
      if (p.specialization) html += `<p class="mb-1"><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;

      html += `
        <div class="mt-3">
          <button class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" disabled title="Toto je pouze n√°hled">
            ‚úâÔ∏è Napsat pilotovi (N√°hled)
          </button>
        </div>
      `;
    }

    // === PREMIUM √∫ƒçet ===
    else if (p.type_account === "Premium") {
      html += `
        ${p.email ? `<p class="mb-1"><i class="bi bi-envelope-at me-1"></i><a href="#" onclick="return false;">${p.email}</a></p>` : ''}
        ${p.phone ? `<p class="mb-1"><i class="bi bi-telephone-fill me-1"></i><a href="#" onclick="return false;">${p.phone}</a></p>` : ''}
        ${p.drones ? `<p class="mb-1"><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>` : ''}
        ${p.specialization ? `<p class="mb-1"><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
        ${p.note ? `<p class="mb-1"><i class="bi bi-chat-left-text me-1"></i><strong>O mnƒõ:</strong> ${p.note}</p>` : ''}
        ${p.travel ? `<p class="mb-1"><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>` : ''}
        ${p.licenses ? `<p class="mb-1"><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>` : ''}
      `;
    }
        
    // === FREE √∫ƒçet ===
    else {
      html += `
        ${p.specialization ? `<p class="mb-1"><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
        ${p.drones ? `<p class="mb-1"><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>` : ''}
        
        <p class="text-muted small mt-3 mb-2">
        Pilot m√° Free √∫ƒçet, komunikace je nedostupn√°. 
        <br>
        Odpovƒõƒè nen√≠ garantov√°na.
        </p>
        <button class="btn btn-sm btn-outline-success w-100" 
            style="font-size: 13px; padding: 4px 8px; border-color: #28a745; color: #28a745;" 
            disabled title="Toto je pouze n√°hled">
            üéÅ Darovat 3 dny Basic √∫ƒçtu pro kontakt (N√°hled)
        </button>
      `;
    }
  }
  
  // --- Ve≈ôejn√Ω n√°v≈°tƒõvn√≠k (NEP≈òIHL√Å≈†EN) ---
  else { 
    
    // 1. Kontaktn√≠ ≈ô√°dky (pouze pro Premium)
    let contactInfoHtml = ''; 
    if (p.type_account === 'Premium') {
        contactInfoHtml = `
            <p class="mb-1"><i class="bi bi-envelope-at me-1"></i><span class="text-muted">[e-mail po p≈ôihl√°≈°en√≠]</span></p>
            ${p.phone ? `<p class="mb-1"><i class="bi bi-telephone-fill me-1"></i><span class="text-muted">[telefon skryt]</span></p>` : ''}
        `;
    }
    // Pro Basic a Free z≈Østane pr√°zdn√Ω

    // 2. Patiƒçka (jin√° pro Basic)
    let footerHtml = '';
    if (p.type_account === 'Basic') {
        // Speci√°ln√≠ text pro Basic
        footerHtml = `
        <p class="text-muted small mt-3">
          <em><i class="bi bi-chat-dots-fill me-1"></i>Pro kontaktov√°n√≠ pilota se p≈ôihlaste jako inzerent.</em>
        </p>
        `;
    } else {
        // Standardn√≠ text pro Free a Premium
        footerHtml = `
        <p class="text-muted small mt-3">
          <em>P≈ôihlaste se jako inzerent pro zobrazen√≠ kontakt≈Ø a v√≠ce informac√≠.</em>
        </p>
        `;
    }

    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0" style="font-size: 1.25rem;"><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
        ${isVerified ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer" style="background-color: #0d6efd; color: #fff; padding: .35em .65em; font-size: .75em; font-weight: 700; border-radius: .25rem;">Dobrovoln√≠k</span></div>` : ''}
      
      ${contactInfoHtml} ${p.specialization ? `<p class="mb-1"><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
      ${p.travel ? `<p class="mb-1"><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>` : ''}
      
      ${footerHtml} `;
  }

  popupContent.innerHTML = html;
  return popupContent.outerHTML;
}
/**
 * Shrom√°≈æd√≠ data z formul√°≈ôe a zkombinuje je s daty z DB (nap≈ô. type_account).
 */
function getPilotDataFromForm() {
    // Pokud 'currentPilot' (z DB) je≈°tƒõ nen√≠ naƒçten√Ω, nem≈Ø≈æeme nic dƒõlat
    if (!currentPilot) return null; 

    const specSelect = document.getElementById("specialization");
    const specializationText = [...specSelect.selectedOptions].map(o => o.textContent).join(", ");
    
    // Vr√°t√≠me objekt, kter√Ω vypad√° jako pilot, ale bere hodnoty z formul√°≈ôe
    return {
        ...currentPilot, // Z√°klad z DB (id, type_account, a hlavnƒõ hasPublicConsent)
        
        // P≈ôep√≠≈°eme hodnotami z formul√°≈ôe
        name: document.getElementById("name").value,
        email: document.getElementById("email").value, // pro Premium
        phone: document.getElementById("phone").value, // pro Premium
        website: document.getElementById("website").value,
        drones: Array.from(document.getElementsByName("drones[]")).map(i => i.value.trim()).filter(v => v).join(", "),
        note: document.getElementById("note").value,
        travel: document.getElementById("travel").value,
        licenses: Array.from(document.querySelectorAll("input[name='licenses']:checked")).map(cb => cb.value).join(", "),
        specialization: specializationText,
        volunteer: document.getElementById("volunteer").checked ? "ANO" : "NE",
        available: document.getElementById("available").value,
        registrationnumber: document.getElementById("registrationnumber").value
    };
}

/**
 * Hlavn√≠ funkce, kter√° p≈ôekresl√≠ n√°hled.
 */
function renderMapPreview() {
    // Mal√© zpo≈ædƒõn√≠ (1ms) zajist√≠, ≈æe se funkce spust√≠ a≈æ pot√©, co prohl√≠≈æeƒç
    // stihne zaregistrovat zmƒõnu hodnoty v selectu nebo checkboxu.
    setTimeout(() => {
        const container = document.getElementById("map-preview-content");
        if (!container) return;
        
        const pilotData = getPilotDataFromForm(); // Z√≠sk√° ƒçerstv√° data z formul√°≈ôe

        if (!pilotData) {
            container.innerHTML = '<div class="p-3 text-center text-muted">Naƒç√≠t√°m data pilota...</div>';
            return;
        }

        // --- TATO ƒå√ÅST JE NOV√Å ---
        // Zjist√≠ stav p≈ôep√≠naƒçe
        const isLoggedIn = document.getElementById('preview-advertiser').checked;
        // --- KONEC NOV√â ƒå√ÅSTI ---
        
        // Vygeneruje a vlo≈æ√≠ HTML n√°hled
        container.innerHTML = createPreviewPopup(pilotData, isLoggedIn); // <-- P≈ôed√° stav do funkce
    }, 1);
}
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
// --- Skript pro Tooltipy (mus√≠ b√Ωt a≈æ po Bootstrap JS) ---
  document.addEventListener('DOMContentLoaded', () => {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
  });
</script>

<script>
// --- Bezpeƒçn√© smaz√°n√≠ √∫ƒçtu ---
document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
    const email = localStorage.getItem("loggedEmail");
    if (!email) {
        alert("Chyba: nejsi p≈ôihl√°≈°en.");
        return;
    }

    // 1) prvn√≠ potvrzen√≠
    if (!confirm("Opravdu chce≈° smazat sv≈Øj √∫ƒçet? Tato akce je nevratn√°.")) {
        return;
    }

    // 2) druh√© potvrzen√≠ ‚Äî zad√°n√≠ e-mailu
    const verify = prompt(
        "Pro potvrzen√≠ napi≈° sv≈Øj e-mail:\n\n" + email + "\n\nBez shody se √∫ƒçet nesma≈æe."
    );

    if (!verify || verify.trim().toLowerCase() !== email.toLowerCase()) {
        alert("‚ùå E-mail nesouhlas√≠. Maz√°n√≠ zru≈°eno.");
        return;
    }

    // 3) odesl√°n√≠ mazac√≠ho po≈æadavku
    try {
        const res = await fetch("/delete-my-account", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
        });

        if (!res.ok) {
            const msg = await res.text();
            alert("‚ùå Chyba: " + msg);
            return;
        }

        // Odhl√°≈°en√≠ a p≈ôesmƒõrov√°n√≠
        localStorage.removeItem("loggedEmail");

        alert("‚úÖ Tv≈Øj √∫ƒçet byl √∫spƒõ≈°nƒõ smaz√°n.");
        window.location.href = "/index.html";

    } catch (e) {
        alert("Nastala chyba p≈ôi maz√°n√≠ √∫ƒçtu.");
        console.error(e);
    }
});
</script>



 
</body>
</html>