<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NajdiPilota.cz â€“ Admin rozesÃ­lka</title>
<style>
  :root { --brand:#0077B6; --bg:#F8F9FA; --card:#fff; --muted:#6c757d; }
  body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:#222; }
  header { background:var(--brand); color:#fff; padding:16px 20px; }
  h1 { margin:0; font-size:20px; font-weight:600; }
  .wrap { max-width:1200px; margin:20px auto; padding:0 16px; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  .card { background:var(--card); border-radius:12px; box-shadow:0 1px 4px rgba(0,0,0,.06); padding:16px; }
  .card h2 { margin:.2rem 0 1rem; font-size:18px; }
  label { display:block; font-size:13px; color:#333; margin:.5rem 0 .25rem; }
  input[type="text"], input[type="email"], textarea, select {
    width:100%; padding:10px; border:1px solid #e1e5ea; border-radius:8px; font-size:14px; background:#fff;
  }
  textarea { min-height:96px; resize:vertical; }
  button, .btn {
    background:var(--brand); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600;
  }
  button.secondary { background:#e9ecef; color:#222; }
  .muted { color:var(--muted); font-size:12px; }
  table { width:100%; border-collapse:collapse; font-size:14px; }
  th, td { padding:8px 10px; border-bottom:1px solid #f0f2f4; vertical-align:top; }
  th { text-align:left; background:#fafbfc; position:sticky; top:0; }
  .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .row { display:flex; gap:8px; align-items:center; }
  .row > * { flex:1; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef6ff; color:#1158c7; font-size:12px; }
  .status { font-size:12px; }
  .ok { color:#198754; }
  .err { color:#d63384; }
  .warn { color:#856404; }
  .badge { font-size:11px; padding:2px 6px; border-radius:6px; background:#f1f3f5; }
  .right { text-align:right; }
  .danger { background:#d6336c; }
  .ghost { background:transparent; color:#222; border:1px solid #e1e5ea; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; }
</style>
</head>
<body>
<header><h1>NajdiPilota.cz â€“ Admin rozesÃ­lka</h1></header>

<div class="wrap">

  <div class="grid">
    <!-- KONTAKTY -->
    <section class="card">
      <h2>Kontakty</h2>
      <div class="flex">
        <input id="newName" type="text" placeholder="NÃ¡zev firmy">
        <input id="newEmail" type="email" placeholder="E-mail">
        <input id="newCategory" type="text" placeholder="Kategorie (obecnÃ½ / reality / logistika)">
        <button id="btnAdd">PÅ™idat</button>
      </div>
      <div class="flex" style="margin-top:8px;">
        <input id="csvFile" type="file" accept=".csv" />
        <button id="btnImport" class="ghost">Import CSV</button>
        <span class="muted">CSV formÃ¡t: <span class="mono">NÃ¡zev;Email;Kategorie;PoznÃ¡mka</span></span>
        <div style="flex:1"></div>
        <button id="btnClear" class="danger">VyÄistit seznam</button>
      </div>

      <div style="margin-top:12px; max-height:320px; overflow:auto; border:1px solid #edf0f2; border-radius:8px;">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:28px;"><input type="checkbox" id="checkAll"></th>
              <th>Firma</th>
              <th>Email</th>
              <th>Kategorie</th>
              <th>PoznÃ¡mka</th>
              <th class="right">Akce</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:6px;"><span id="count">0</span> kontaktÅ¯</div>
    </section>

    <!-- Å ABLONA + NÃHLED + ODESLÃNÃ -->
    <section class="card">
      <h2>Å ablona e-mailu</h2>
      <label for="template">Vyber Å¡ablonu</label>
      <select id="template">
        <option value="general">ObecnÃ½ â€” NajdiPilota.cz</option>
        <option value="realty">Reality â€” RK / developeÅ™i</option>
        <option value="logistics">Logistika â€” kurÃ½Å™i/depA/sklady</option>
      </select>

      <label for="subject">PÅ™edmÄ›t</label>
      <input id="subject" type="text" placeholder="PÅ™edmÄ›t e-mailu" />

      <label for="customNote">VlastnÃ­ poznÃ¡mka (nepovinnÃ©, vloÅ¾Ã­ se do tÄ›la)</label>
      <textarea id="customNote" placeholder="DoplÅˆ osobnÃ­ vzkaz, call-to-action, konkrÃ©tnÃ­ termÃ­n apod."></textarea>

      <div class="flex" style="margin-top:8px;">
        <button id="btnPreview" class="secondary">NÃ¡hled</button>
        <button id="btnSend">Odeslat vybranÃ©</button>
        <span class="muted">Rate limit: 1 e-mail / 3 s</span>
      </div>

      <div id="preview" class="card" style="margin-top:14px; background:#fafafa;">
        <div class="muted">NÃ¡hled se zobrazÃ­ zdeâ€¦</div>
      </div>

      <div id="log" class="mono" style="margin-top:12px; white-space:pre-wrap;"></div>
    </section>
  </div>

</div>

<script>
/* ======= PomocnÃ© funkce ======= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

const state = {
  rows: [],   // {id, name, email, category, note, selected}
  seq: 1,
  sending: false,
  rateMs: 3000,
};

function rid() { return state.seq++; }

function renderTable(){
  const tb = $('#tbody');
  tb.innerHTML = '';
  state.rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${r.id}" ${r.selected?'checked':''}></td>
      <td>${escapeHtml(r.name||'')}</td>
      <td>${escapeHtml(r.email||'')}</td>
      <td><span class="badge">${escapeHtml(r.category||'')}</span></td>
      <td>${escapeHtml(r.note||'')}</td>
      <td class="right">
        <button class="ghost" data-edit="${r.id}">Upravit</button>
        <button class="danger" data-del="${r.id}">Smazat</button>
      </td>`;
    tb.appendChild(tr);
  });
  $('#count').textContent = String(state.rows.length);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;');
}

/* ======= CSV Import ======= */
function parseCsv(text){
  // oÄekÃ¡vÃ¡no: NÃ¡zev;Email;Kategorie;PoznÃ¡mka
  const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  const out = [];
  for (const line of lines){
    const parts = line.split(';');
    if (parts.length < 2) continue;
    out.push({
      id: rid(),
      name: parts[0]?.trim() || '',
      email: parts[1]?.trim() || '',
      category: parts[2]?.trim() || '',
      note: parts[3]?.trim() || '',
      selected: true
    });
  }
  return out;
}

/* ======= Å ablony (HTML jako v onboarding stylu) ======= */
function wrapEmailContent(innerHtml, title = "NajdiPilota.cz"){
  return `
  <div style="font-family:'Poppins','Segoe UI',sans-serif;background:#F8F9FA;padding:0;margin:0;">
    <div style="background:#0077B6;color:#fff;padding:16px 20px;text-align:center;">
      <h1 style="margin:0;font-size:20px;font-weight:600;">${title}</h1>
    </div>
    <div style="background:#fff;padding:20px;color:#495057;font-size:15px;line-height:1.6;">
      ${innerHtml}
    </div>
    <div style="background:#F1F1F1;color:#6c757d;font-size:12px;padding:12px;text-align:center;">
      Â© ${new Date().getFullYear()} NajdiPilota.cz â€“ AutomatickÃ¡ notifikace
    </div>
  </div>`;
}

function tplGeneral(company){
  const note = ($('#customNote').value||'').trim();
  return wrapEmailContent(`
    <h2>ğŸš€ PotÅ™ebujete nafotit nebo natoÄit nÄ›co z vÃ½Å¡ky?</h2>
    <p>Drony uÅ¾ dÃ¡vno nejsou jen hraÄky â€” jsou to oÄi z nebe pro marketing, dokumentaci i inspekce.</p>
    <p>Na <strong>NajdiPilota.cz</strong> najdete <strong>ovÄ›Å™enÃ© dronnÃ­ piloty po celÃ© ÄŒR</strong>, pÅ™ipravenÃ© do 24 h vyrazit do terÃ©nu.</p>
    <p>StaÄÃ­ vloÅ¾it krÃ¡tkou poptÃ¡vku, my ji rozeÅ¡leme pilotÅ¯m ve vaÅ¡em okolÃ­ a do nÄ›kolika hodin mÃ¡te nabÃ­dky.</p>
    ${note ? `<p><em>${escapeHtml(note)}</em></p>` : ``}
    <p><a href="https://www.najdipilota.cz/poptavky.html"
      style="background:#0077B6;color:#fff;text-decoration:none;
      padding:10px 18px;border-radius:6px;font-size:14px;font-weight:500;">
      VloÅ¾it poptÃ¡vku zdarma
    </a></p>
    <p>S pozdravem,<br><strong>Bohuslav z NajdiPilota.cz</strong></p>
  `, 'NajdiPilota.cz â€“ Rychle najdÄ›te pilota');
}

function tplRealty(company){
  const note = ($('#customNote').value||'').trim();
  return wrapEmailContent(`
    <h2>ğŸ¡ DronnÃ­ zÃ¡bÄ›ry, kterÃ© prodÃ¡vajÃ­</h2>
    <p>DobrÃ½ den${company?.name?`, ${escapeHtml(company.name)}`:''},</p>
    <p>mÃ¡me sÃ­Å¥ vÃ­ce neÅ¾ <strong>70 ovÄ›Å™enÃ½ch pilotÅ¯ po celÃ© ÄŒR</strong>, kteÅ™Ã­ pomÃ¡hajÃ­ realitkÃ¡m a developerÅ¯m prezentovat
       nemovitosti atraktivnÄ›ji â€” a rychleji prodÃ¡vat.</p>
    <ul>
      <li>8â€“12 leteckÃ½ch fotek + 60â€“90s video</li>
      <li>krÃ¡tkÃ© vertikÃ¡ly pro Reels/Stories</li>
      <li>inspekce stÅ™ech/fasÃ¡d (i termÃ¡l) u staveb</li>
    </ul>
    ${note ? `<p><em>${escapeHtml(note)}</em></p>` : ``}
    <p><a href="https://www.najdipilota.cz/poptavky.html"
      style="background:#0077B6;color:#fff;text-decoration:none;
      padding:10px 18px;border-radius:6px;font-size:14px;font-weight:500;">
      VloÅ¾it poptÃ¡vku â€“ zdarma bÄ›hem 1 minuty
    </a></p>
    <p>S pozdravem,<br><strong>Bohuslav z NajdiPilota.cz</strong></p>
  `, 'NajdiPilota.cz â€“ Pro realitnÃ­ kancelÃ¡Å™e');
}

function tplLogistics(company){
  const note = ($('#customNote').value||'').trim();
  return wrapEmailContent(`
    <h2>ğŸšš ZÃ¡bÄ›ry a inspekce vaÅ¡ich dep a skladÅ¯ z ptaÄÃ­ perspektivy</h2>
    <p>DobrÃ½ den${company?.name?`, ${escapeHtml(company.name)}`:''},</p>
    <p>mÃ¡te depo, sklad nebo flotilu, kterou chcete <strong>prezentovat nebo zkontrolovat z vÃ½Å¡ky</strong>?</p>
    <ul>
      <li>ğŸ“¸ PR/brandovÃ© video areÃ¡lu (Wolt, RohlÃ­k, PPL, ZÃ¡silkovna typovÄ›)</li>
      <li>ğŸ” inspekce stÅ™ech, solÃ¡rÅ¯, logistickÃ½ch tras</li>
      <li>ğŸ¬ dokumentace provozu a BOZP</li>
    </ul>
    ${note ? `<p><em>${escapeHtml(note)}</em></p>` : ``}
    <p><a href="https://www.najdipilota.cz/poptavky.html"
      style="background:#0077B6;color:#fff;text-decoration:none;
      padding:10px 18px;border-radius:6px;font-size:14px;font-weight:500;">
      VloÅ¾it poptÃ¡vku pro vaÅ¡i firmu
    </a></p>
    <p>S pozdravem,<br><strong>Bohuslav z NajdiPilota.cz</strong></p>
  `, 'NajdiPilota.cz â€“ Pro logistiku a kurÃ½ry');
}

function buildHtml(company){
  const t = $('#template').value;
  if (t === 'realty') return tplRealty(company);
  if (t === 'logistics') return tplLogistics(company);
  return tplGeneral(company);
}

/* ======= UI Handlery ======= */
$('#btnAdd').addEventListener('click', () => {
  const name = $('#newName').value.trim();
  const email = $('#newEmail').value.trim();
  const cat = $('#newCategory').value.trim();
  if(!email){ alert('Zadej e-mail'); return; }
  state.rows.unshift({ id:rid(), name, email, category:cat, note:'', selected:true });
  $('#newName').value = ''; $('#newEmail').value=''; $('#newCategory').value='';
  renderTable();
});

$('#btnClear').addEventListener('click', () => {
  if(confirm('Opravdu vyÄistit seznam?')) { state.rows = []; renderTable(); }
});

$('#csvFile').addEventListener('change', async (e) => {
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await f.text();
  const parsed = parseCsv(txt);
  state.rows.push(...parsed);
  renderTable();
});

$('#btnImport').addEventListener('click', () => $('#csvFile').click());

$('#tbody').addEventListener('change', (e) => {
  const id = e.target.dataset.id;
  if(e.target.type === 'checkbox' && id){
    const row = state.rows.find(r => String(r.id) === String(id));
    if(row) row.selected = e.target.checked;
  }
});

$('#tbody').addEventListener('click', (e) => {
  const del = e.target.dataset.del;
  const edit = e.target.dataset.edit;
  if (del){
    state.rows = state.rows.filter(r => String(r.id)!==String(del));
    renderTable(); return;
  }
  if (edit){
    const row = state.rows.find(r => String(r.id)===String(edit));
    if(!row) return;
    const name = prompt('NÃ¡zev firmy:', row.name||'') ?? row.name;
    const email = prompt('E-mail:', row.email||'') ?? row.email;
    const cat = prompt('Kategorie:', row.category||'') ?? row.category;
    const note = prompt('PoznÃ¡mka:', row.note||'') ?? row.note;
    Object.assign(row, {name, email, category:cat, note});
    renderTable(); return;
  }
});

$('#checkAll').addEventListener('change', (e) => {
  const v = e.target.checked;
  state.rows.forEach(r => r.selected = v);
  renderTable();
});

$('#btnPreview').addEventListener('click', () => {
  const sample = state.rows.find(r => r.selected) || {name:'VaÅ¡e spoleÄnost'};
  const html = buildHtml(sample);
  $('#preview').innerHTML = html;
  if(!$('#subject').value.trim()){
    const subj = ({
      general:'NajdiPilota.cz â€“ rychle najdÄ›te pilota pro vaÅ¡i zakÃ¡zku',
      realty:'NajdiPilota.cz â€“ leteckÃ© zÃ¡bÄ›ry, kterÃ© prodÃ¡vajÃ­',
      logistics:'NajdiPilota.cz â€“ drony pro logistiku a kurÃ½ry'
    })[$('#template').value] || 'NajdiPilota.cz â€“ dronnÃ­ sluÅ¾by';
    $('#subject').value = subj;
  }
});

/* ======= OdesÃ­lÃ¡nÃ­ ======= */
/* Implementuj na backendu BUÄ /send-outreach (batch)
   NEBO fallback /send-direct (single). NÃ­Å¾e je klientskÃ¡ logika, kterÃ¡ nejprve zkusÃ­ batch. */

async function sendBatch(payload){
  // oÄekÃ¡vanÃ½ backend: POST /send-outreach  { emails:[], template:"general|realty|logistics", subject:"", customNote:"" }
  const res = await fetch('/send-outreach', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('send-outreach HTTP '+res.status);
  return res.json();
}

async function sendDirect(one){
  // fallback: POST /send-direct  { to:"a@b.cz", html:"<html...>", subject:"..." }
  const res = await fetch('/send-direct', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(one)
  });
  if(!res.ok) throw new Error('send-direct HTTP '+res.status);
  return res.json();
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

$('#btnSend').addEventListener('click', async () => {
  if(state.sending) return;
  const selected = state.rows.filter(r => r.selected && r.email);
  if(selected.length===0){ alert('Vyber aspoÅˆ jeden kontakt'); return; }

  const template = $('#template').value;
  const subject  = $('#subject').value.trim() || 'NajdiPilota.cz â€“ dronnÃ­ sluÅ¾by';
  const customNote = $('#customNote').value || '';

  state.sending = true;
  $('#log').textContent = `OdesÃ­lÃ¡m ${selected.length} e-mailÅ¯â€¦\n`;

  // 1) zkuste batch endpoint
  try{
    const emails = selected.map(r => ({ email:r.email, name:r.name||'', category:r.category||'' }));
    const result = await sendBatch({ emails, template, subject, customNote });
    $('#log').textContent += `âœ“ Batch odeslÃ¡n (${selected.length}) â€“ server odpovÄ›dÄ›l OK\n`;
    state.sending = false;
    return;
  }catch(e){
    $('#log').textContent += `âš ï¸ Batch endpoint nedostupnÃ½ â€“ pÅ™echÃ¡zÃ­m na postupnÃ© odesÃ­lÃ¡nÃ­.\n`;
  }

  // 2) fallback â€“ posÃ­lej po jednom s rate-limitem
  for (let i=0;i<selected.length;i++){
    const r = selected[i];
    const html = buildHtml(r);
    try{
      await sendDirect({ to:r.email, subject, html });
      $('#log').textContent += `âœ“ ${r.email}\n`;
    }catch(err){
      $('#log').textContent += `âœ— ${r.email} â€“ CHYBA: ${err.message}\n`;
    }
    await sleep(state.rateMs);
  }
  state.sending = false;
});
</script>
</body>
</html>
