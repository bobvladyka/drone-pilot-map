<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat - NajdiPilota.cz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <meta name="robots" content="index, follow">
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>

  <style>
    #chat-container {
      height: 80vh;
      display: flex;
      flex-direction: column;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;          /* hlavní fix */

    }

    .message {
      margin: 8px 0;
      max-width: 80%;
      display: flex;
    }

    .my-message {
      align-self: flex-end;
      margin-left: auto;
    }

    .their-message {
      align-self: flex-start;
      margin-right: auto;
    }

    .message-content {
      padding: 10px 15px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      #messages .message {
  min-width: 0;                /* důležité pro flex! */
}
    }

    .my-message .message-content {
  background-color: rgba(13, 110, 253, 0.5); /* #0d6efd → 50 % průhledná modrá */
  border-bottom-right-radius: 4px;
}

.their-message .message-content {
  background-color: rgba(253, 126, 20, 0.5); /* #fd7e14 → 50 % průhledná oranžová */
  border-bottom-left-radius: 4px;
}


/* extrémně dlouhé odkazy */
.message-content a {
  word-break: break-all;
}

    .message-time {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 4px;
    }

    .my-message .message-time {
      text-align: right;
    }

    .their-message .message-time {
      text-align: left;
    }

    #message-input {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    #message-input input {
      flex: 1;
      border-radius: 20px;
      padding: 10px 15px;
    }

    #send-message-btn {
      border-radius: 20px;
      padding: 0 20px;
    }

    .email-display {
      direction: rtl;
      unicode-bidi: bidi-override;
      overflow: hidden;
      text-overflow: ellipsis;
    }
     :root{
    --pilot-bg:#E8F4FF;      /* světle modrá */
    --pilot-text:#0A3D62;    /* tmavě modrá */
    --adv-bg:#F6F6F6;        /* světle šedá */
    --adv-text:#333333;      /* grafitová */
    --me-ring:#38B000;       /* zelený proužek u „mých“ zpráv (volitelné) */
  }

  .msg{
    max-width: 72%;
    padding: .6rem .8rem;
    border-radius: 14px;
    margin: .25rem 0;
    line-height: 1.35;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
    position: relative;
    word-wrap: break-word;
  }
  .msg--pilot{
    background: var(--pilot-bg);
    color: var(--pilot-text);
    border-top-left-radius: 6px;
  }
  .msg--adv{
    background: var(--adv-bg);
    color: var(--adv-text);
    border-top-right-radius: 6px;
  }
  /* zarovnání podle toho, kdo píše */
  .msg--left{ align-self: flex-start; }
  .msg--right{ align-self: flex-end; }

  /* jemný proužek pro „moje“ zprávy (ten, kdo je přihlášený) */
  .msg--me::after{
    content:"";
    position:absolute;
    inset:auto -4px auto auto;
    width:4px; height:60%;
    background:var(--me-ring);
    border-radius:2px;
  }

  .msg-meta{
    font-size:.75rem; opacity:.7; margin-top:.25rem;
    display:flex; gap:.5rem; align-items:center;
  }
  .badge{
    font-size:.65rem; padding:.12rem .4rem; border-radius:999px;
    background:#00000010;
  }
  .badge--pilot{ background:#0077B620; color:#0A3D62; }
  .badge--adv{ background:#00000014; color:#333; }
  
  /* kontejner se zprávami musí být flex-column */
  #messages{
    display:flex; flex-direction:column; gap:.25rem;
  }
   #new-message {
  min-height: 42px;
  max-height: 200px;
  resize: none;
  overflow-y: auto;
}
 
#messages .message {
  min-width: 0;                /* důležité pro flex! */
}

img.emoji {
  height: 1em;
  width: 1em;
  margin: 0 .05em;
  vertical-align: -0.1em;
}


   
  </style>
</head>

<body>
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <button onclick="window.history.back()" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Zpět
      </button>
      <h4 class="mb-0">Konverzace s <span id="pilot-name"></span></h4>
      <div class="text-muted small">Přihlášen: <span id="advertiser-name" class="email-display"></span></div>
    </div>

    <div id="chat-container">
      <div id="messages">
        <!-- Messages will be displayed here -->
      </div>

      <div id="message-input">
        <textarea id="new-message" class="form-control" placeholder="Napište zprávu..." rows="1"></textarea>

        <button id="send-message-btn" class="btn btn-primary">
          <i class="bi bi-send"></i> Odeslat
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", function() {
  const urlParams = new URLSearchParams(window.location.search);
  const conversationId = urlParams.get('conversationId');
  const pilotEmail = urlParams.get('pilotEmail');
  const advertiserEmail = urlParams.get('inzerentEmail');

const textarea = document.getElementById('new-message');
textarea.addEventListener('input', () => {
  textarea.style.height = 'auto';
  textarea.style.height = textarea.scrollHeight + 'px';
});
 

  if (!conversationId || !pilotEmail || !advertiserEmail) {
    alert("Chyba: Chybí parametry konverzace.");
    window.location.href = '/index.html';
    return;
  }

  // Získání přihlášeného e-mailu z localStorage
const loggedEmail = localStorage.getItem('inzerentEmail') || localStorage.getItem('loggedEmail');


// Pokud máme userId v localStorage, označíme konverzaci jako přečtenou
const loggedUserId = localStorage.getItem("pilotId") || localStorage.getItem("inzerentId");

if (conversationId && loggedUserId) {
  fetch('/mark-as-seen', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      conversationId,
      userId: loggedUserId
    })
  }).catch(err => console.error("Chyba při označení jako přečtené:", err));
}

  
  if (!loggedEmail) {
    alert("Chyba: Uživatel není přihlášen.");
    window.location.href = '/login.html'; // Přesměrování na přihlašovací stránku
    return;
  }

  // Logování pro kontrolu správnosti parametrů
  console.log('conversationId:', conversationId);
  console.log('pilotEmail:', pilotEmail);
  console.log('advertiserEmail:', advertiserEmail);
  console.log('loggedEmail:', loggedEmail); // Log pro ověření, že e-mail je uložený v localStorage

  // Ověření, zda je správný uživatel podle URL parametrů a přihlášeného e-mailu
  const isPilot = loggedEmail === pilotEmail;
  const isAdvertiser = loggedEmail === advertiserEmail;

  console.log('isPilot:', isPilot);
  console.log('isAdvertiser:', isAdvertiser);

  if (!isPilot && !isAdvertiser) {
    alert("Chyba: Neznámý typ uživatele nebo špatná stránka.");
    window.location.href = '/index.html';
    return;
  }

  // Fetch pilot's name from the database, pokud je pilot
  fetch(`/get-pilot-name?email=${encodeURIComponent(pilotEmail)}`)
    .then(res => res.json())
    .then(data => {
      if (data.success && data.name) {
        document.getElementById('pilot-name').textContent = data.name;
      } else {
        document.getElementById('pilot-name').textContent = obfuscateEmail(pilotEmail);
      }
    })
    .catch(err => {
      console.error("Chyba při načítání jména pilota:", err);
      document.getElementById('pilot-name').textContent = obfuscateEmail(pilotEmail);
    });

  // Obfuscate advertiser email display
  document.getElementById('advertiser-name').textContent = obfuscateEmail(advertiserEmail);

  // Funkce pro obfuscation emailu
  function obfuscateEmail(email) {
    if (!email) return '';
    const [name, domain] = email.split('@');
    return `${name.substring(0, 2)}•••@${domain.substring(0, 2)}•••${domain.substring(domain.lastIndexOf('.'))}`;
  }

  // Fetch messages for the conversation
  function loadMessages() {
    fetch(`/get-messages?conversationId=${conversationId}`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          displayMessages(data.messages);
        } else {
          console.error("Chyba při načítání zpráv:", data.message);
        }
      })
      .catch(err => {
        console.error("Chyba při načítání zpráv:", err);
      });
  }

  // Enter = odeslat, Shift+Enter = nový řádek
document.getElementById('send-message-btn').addEventListener('click', sendMessageHandler);
document.getElementById('new-message').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault(); // zabrání zalomení řádku
    sendMessageHandler();
  }
});


  function sendMessageHandler() {
    const messageContent = document.getElementById('new-message').value.trim();
    if (messageContent) {
      sendMessage(messageContent);
    }
  }

  // Send message to the backend and update the chat
  function sendMessage(messageContent) {
    const sendBtn = document.getElementById('send-message-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Odesílám...';

    fetch('/send-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        conversationId,
        senderEmail: localStorage.getItem('inzerentEmail') || localStorage.getItem('loggedEmail'), // ✅
        message: messageContent
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('new-message').value = '';
        const ta = document.getElementById('new-message');
ta.style.height = 'auto';
ta.style.height = ta.scrollHeight + 'px';

        loadMessages(); // Reload all messages to maintain order
      } else {
        alert("Chyba při odesílání zprávy: " + (data.message || 'Neznámá chyba'));
      }
    })
    .catch(err => {
      console.error("Chyba při odesílání zprávy:", err);
      alert("Došlo k chybě při odesílání zprávy.");
    })
    .finally(() => {
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send"></i> Odeslat';
    });
  }

  function formatDateTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  
  // Vytvoříme objekt Intl.DateTimeFormat pro časové pásmo Praha
  const formatter = new Intl.DateTimeFormat('cs-CZ', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    timeZone: 'Europe/Prague'
  });
  
  // Formátujeme datum a čas
  const parts = formatter.formatToParts(date);
  const day = parts.find(p => p.type === 'day').value;
  const month = parts.find(p => p.type === 'month').value;
  const year = parts.find(p => p.type === 'year').value;
  const hours = parts.find(p => p.type === 'hour').value;
  const minutes = parts.find(p => p.type === 'minute').value;
  
  return `${day}.${month}.${year} ${hours}:${minutes}`;
}

  function escapeHTML(str) {
  return String(str).replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
  }[s]));
}

function renderMessageHTML(raw) {
  if (!raw) return '';
  let s = raw;

  // GIF odkazy
  const gifRegex = /(https?:\/\/[^\s<]+\.gif)/gi;
  s = s.replace(gifRegex, '<img src="$1" alt="GIF" style="max-width:220px;border-radius:10px;">');

  // Ostatní odkazy (https://...) → klikací link
  const urlRegex = /(https?:\/\/[^\s<]+)/gi;
  s = s.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

  // Nové řádky zachovat
  s = s.replace(/\n/g, '<br>');

  // Emoji shortcody
  s = s.replace(/:smile:/g, '😄')
       .replace(/:thumbsup:/g, '👍')
       .replace(/:drone:/g, '🚁');

  return s;
}


  // Function to display messages
  function displayMessages(messages) {
  const messagesDiv = document.getElementById('messages');
  messagesDiv.innerHTML = '';

  if (!messages || messages.length === 0) {
    messagesDiv.innerHTML = '<div class="text-center text-muted">Žádné zprávy v této konverzaci</div>';
    return;
  }

  messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

  messages.forEach(message => {
    const messageDiv = document.createElement('div');

    const isPilotSender = message.sender_email === pilotEmail;
    const isMyMessage = message.sender_email === (isPilot ? pilotEmail : advertiserEmail);

    messageDiv.classList.add(
      'message',
      isMyMessage ? 'my-message' : 'their-message',
      isPilotSender ? 'pilot-message' : 'advertiser-message'
    );

    const formattedTime = formatDateTime(message.created_at);
    const contentHTML = renderMessageHTML(message.message);

messageDiv.innerHTML = `
  <div class="message-content">
    <div class="message-role">${isPilotSender ? 'Pilot' : 'Inzerent'}</div>
    <div class="message-body">${contentHTML}</div>
    <div class="message-time">${formattedTime}</div>
  </div>
`;


    messagesDiv.appendChild(messageDiv);
  });

  // ⬇️ Vykreslení emoji (Twemoji)
  if (window.twemoji && typeof twemoji.parse === 'function') {
    twemoji.parse(messagesDiv, { folder: 'svg', ext: '.svg' });
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}


  // Load messages initially and set up periodic refresh
  loadMessages();
  twemoji.parse(document.getElementById('messages'));

  setInterval(loadMessages, 10000); // Refresh every 10 seconds
});


  </script>
</body>
</html>
