<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
<title>Dronová mapa pilotů v Česku – Najdi nebo se přidej | Spojujeme piloty a zákazníky</title>

    <meta name="description" content="Hledáš pilota dronu nebo chceš být vidět na mapě? Najdi pilota podle lokality, specializace, vybavení a připoj se k ověřené komunitě." />

  <meta name="robots" content="index, follow" />
<link rel="canonical" href="https://www.najdipilota.cz/" />

  <!-- Open Graph pro Facebook a další sítě -->
  <meta property="og:title" content="Dronová mapa pilotů v Česku" />
  <meta property="og:description" content="Spojujeme zákazníky s piloty dronů. Zobraz se na mapě nebo si najdi pilota ve svém okolí." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.najdipilota.cz/" />
  <meta property="og:image" content="icons/logo.png" />
  <meta name="google-site-verification" content="yxzi02d6ahPBVtx31lx_Mwg07khOFlY_fWUFdkyrsUE" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Vlastní styl -->
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet a MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- Favicony -->
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="manifest" href="/icons/site.webmanifest">
<link rel="icon" href="/icons/favicon.ico" type="image/x-icon">


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3KQTXQ496Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3KQTXQ496Y');
</script>


</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="/index.html">
  <img src="/icons/logo.png" alt="Logo NajdiPilota.cz" height="60" class="me-2" loading="lazy" aria-hidden="true" />
  <span class="fs-4">NajdiPilota.cz</span>
</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    
    <div class="collapse navbar-collapse" id="mainNavbar">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
	<li class="nav-item" id="inzerent-nav-item" style="display:none;">
  <a class="nav-link text-warning fw-bold" href="#" data-bs-toggle="modal" data-bs-target="#inzerentModal">
    <i class="bi bi-megaphone-fill me-1"></i>Pro inzerenty
  </a>
</li>
        <li class="nav-item">
          <a class="nav-link" href="/index.html">Mapa</a>
        </li>

         <li class="nav-item" id="messages-nav-item" style="display:none;">
          <a class="nav-link" href="/moje-zpravy.html">
            <i class="bi bi-envelope me-1"></i>Moje zprávy
          </a>
        </li>
        
        <li class="nav-item" id="poptavky-nav-item" style="display:none;">
  <a class="nav-link" href="/poptavky.html">
    <i class="bi bi-briefcase-fill me-1"></i>Poptávky
  </a>
</li>

        <li class="nav-item">
          <a class="nav-link" href="/o-projektu.html">O projektu</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/kontakt.html">Kontakt</a>
        </li>
          
<li class="nav-item">

</li>
      </ul>
<button id="login-button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2">
  <i class="bi bi-person-badge me-2"></i>
  <span id="login-toggle">Přihlásit se jako pilot</span>
</button>
    </div>
  </div>
</nav>

  <div class="container py-4">
    <h1 class="text-center">
  <i class="bi bi-map-fill me-2" aria-hidden="true"></i>
  Dronová mapa pilotů v Česku</h1>
    <p id="user-status" class="text-center fw-bold mb-3"></p>
<!-- Tlačítka přihlášení -->
<div id="pilot-login-wrapper" class="d-flex flex-wrap align-items-center gap-2 justify-content-center" >

  


<!-- Modal pro inzerenty -->
<div class="modal fade" id="inzerentModal" tabindex="-1" aria-labelledby="inzerentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="inzerentModalLabel">
          <i class="bi bi-building me-2"></i>Pro firmy a inzerenty
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
      </div>
      <div class="modal-body">
        <p>Hledáte pilota pro natáčení, inspekci nebo mapování? Vyberte si z ověřených pilotů podle regionu a specializace.</p>
      </div>
      <div class="modal-footer">
        <a href="/inzerent.html" class="btn btn-outline-warning">
          <i class="bi bi-person-badge-fill me-1"></i> Přihlásit se jako inzerent
        </a>
      </div>
    </div>
  </div>
</div>


  <span id="logged-info" class="fw-bold small"></span>
  <button id="edit-profile-btn" style="display:none;" class="pilot-login-btn w-100">
    <i class="bi bi-pencil-square me-1"></i>Upravit
  </button>
</div>
    

    <section class="mb-5">
<p class="visually-hidden">
  Najdi ověřené piloty dronů v Česku. Interaktivní mapa pilotů dronů – podle lokality, vybavení a specializace. Rychlý kontakt a přímé propojení se zákazníky.
</p>
      <p><strong>Hledáš pilota dronu ve svém okolí?</strong> Nebo sám létáš a chceš být vidět?</p>
      <p>Tato mapa spojuje zákazníky a piloty. Najdi si spolehlivého pilota podle místa, vybavení nebo specializace – nebo se sám zaregistruj a získej nové příležitosti k létání i výdělku.</p>
      <ul>
  <li><strong>Rychlé spojení</strong> bez zbytečných formulářů</li>
  <li><strong>Ověření piloti</strong> s profilem a kontaktem</li>
  <li><strong>Možnost přivýdělku</strong> pro každého pilota</li>
</ul>
      <p><strong>Začni kliknutím na pilota na mapě nebo se rovnou přihlas a přidej se!</strong></p>
    </section>

    <h2>
  <i class="bi bi-geo-alt-fill text-danger me-2" aria-hidden="true"></i>
  Seznam pilotů na mapě
</h2>

    <p>Na mapě níže vidíš všechny dostupné piloty. Klikni na ikonu a zobraz si jejich profil, vybavení a kontakt. Přihlášení uživatelé uvidí i další detaily jako specializaci, drony nebo rozsah dojíždění.</p>

    <div id="login-modal-backdrop"></div>

    <!-- Přihlašovací modal -->
    <div id="login-box" style="display: "display: none; position: relative;">
<button type="button" class="btn-close close-btn" aria-label="Zavřít"
        onclick="document.getElementById('login-box').style.display='none';"></button>
   <h3>Přihlášení pilota</h3>


      <form id="login-form" onsubmit="pilotLogin(event)">
        <div class="mb-3">
          <label for="email" class="form-label">E-mail:</label>
          <input type="email" id="email" name="email" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Heslo:</label>
          <input type="password" id="password" name="password" class="form-control" required />
        </div>
        <button type="submit" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100"><i class="bi bi-box-arrow-in-right me-2"></i>Přihlásit se</button>
      </form>
      <p id="login-status" class="mt-3"></p>
      <a href="/register.html" class="link">Nejsem ještě registrován – chci se zaregistrovat</a>
      <a href="/forgot.html" class="link">Zapomenuté heslo?</a>
    </div>
    
    <div id="map" class="mt-4"></div>

  </div>

  <!-- Leaflet & Cluster -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Skript -->
  <script>
    const map = L.map('map').setView([49.8, 15.5], 7);
const fakeNames = [
  "Rychlý Sysel",
  "Létající Brambor",
  "Dronislav Nebešťák",
  "Turbo Rákosník",
  "Bezpilotní Emil",
  "Pískající Páv",
  "Pilotka Haluz",
  "František Vrtulník",
  "Levý Joystick",
  "Kapitán Stín",
  "Dr. Rotor",
  "Pan Točivý",
  "Letuška Landová",
  "Střemhlavý Franta",
  "Nadzvukový Ježek",
  "Létající Čenda",
  "Rotorová Róza",
  "Šumící Fanda",
  "Bezpečný Béďa",
  "Maják z Oblak",
  "Droný Karel",
  "Letec Šmatla",
  "Startér Staník",
  "Přistávací Pepa",
  "Helikoptérník Honza",
  "Navigátor Novák",
  "Senzorová Soňa",
  "Pán Mraků",
  "Letící Lojza",
  "Kamera Kamil",
  "Rotor Ríša",
  "Výškoměr Vašek",
  "Vzdušný Vojta",
  "Tichý Šumák",
  "Drnčivý Dan",
  "Mlha Milda",
  "Optika Otakar",
  "Ztracený Signál",
  "Mistr Gimbal",
  "Anténa Anička",
  "Vrtulka Věrka",
  "Letmo Lída",
  "Flyboy Felix",
  "Vzdušná Víla",
  "Navigační Norbert",
  "Modrá Letka",
  "Křídlatý Karel",
  "Polní Přízrak",
  "Mapový Mirek",
  "Kličkující Kuba"
];


    
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18
    }).addTo(map);

    const markers = L.markerClusterGroup();
    const pilotCircles = [];
    fetch('/pilots')
      .then(res => res.json())
      .then(data => {
        data.forEach(p => {

        
  if (p.visible !== "ANO") return; // Skryj neviditelné piloty

  if (p.latitude != null && p.longitude != null) {

            let circleOptions = {
      radius: 2000, // Výchozí rádius
      fillOpacity: 0.2, // Výchozí opacity pro Free
      color: p.available === "ANO" ? 'green' : 'gray',
      fillColor: p.available === "ANO" ? '#4CAF50' : '#CCCCCC',
      weight: 1
    };

    // Změna pro různé typy účtů
    if (p.type_account === "Free") {
      circleOptions.color = 'lightgreen';
      circleOptions.fillOpacity = 0.2;
    } else if (p.type_account === "Basic") {
      circleOptions.color = 'darkgreen';
      circleOptions.fillOpacity = 0.5;
    } else if (p.type_account === "Premium") {
  circleOptions.color = 'purple';         // Barva obrysu
  circleOptions.fillColor = 'purple';     // Barva výplně
  circleOptions.fillOpacity = 0.8;        // Opacity výplně
  circleOptions.radius = 10000;           // Dvojnásobně větší rádius než Free a Basic
  circleOptions.weight = 3;               // Tloušťka linie (nastavena na 3)
}

            const circle = L.circle([p.latitude, p.longitude], circleOptions)


            .bindPopup(() => {
  const loggedIn = localStorage.getItem("loggedEmail") || localStorage.getItem("inzerentEmail");
  const isAvailable = p.available === "ANO";
  const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
  const hasBuildBadge = p.id && Number(p.id) <= 80;
const buildBadge = hasBuildBadge 
  ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
  : "";
  // Volitelné: jméno s odznakem (pro re-use)
const pilotNameWithBadge = `${p.name || ''}${buildBadge}`;
const fakeNameWithBadge  = `${fakeName}${buildBadge}`;
  // Nové: čti souhlas z backendu (preferuj p.hasPublicConsent), ošetři i "t"/"f"
const hasPublicConsent = (() => {
  const v = (p.hasPublicConsent ?? p.granted ?? false);
  if (typeof v === 'boolean') return v;
  const s = String(v).trim().toLowerCase();
  return s === 'true' || s === 't' || s === '1' || s === 'ano' || s === 'yes';
})();

if (!hasPublicConsent) {
  return `
    <div class="pilot-card">
      <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>

      <div class="d-flex flex-wrap gap-2 mb-2">
        ${p.volunteer === 'ANO' ? `<span class="badge-volunteer">Dobrovolník</span>` : ''}
        <span class="badge-gdpr">Bez GDPR souhlasu – kontakt přes administrátora</span>
      </div>

      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    </div>
  `;
}



 

  let html = `<div class="pilot-card">`;
 
  if (isAvailable && loggedIn) {
  if (p.type_account === "Free") {
      // Free účet - omezené informace
     html += `
  <div class="d-flex justify-content-between align-items-center mb-1">
    <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${p.name}</h3>
    ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
      ? `<img src="/icons/approved_4.png" alt="Ověřený provozovatel" width="60" class="me-2">` 
      : ''}
    ${p.id && Number(p.id) <= 80
      ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
      : ''}
  </div>
`;
  
      if (p.volunteer === 'ANO') {
        html += `<div class="mb-2"><span class="badge-volunteer">Dobrovolník</span></div>`;
      }

      if (p.drones) html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;

      html += `</div>`;
    } else if (p.type_account === "Basic") {
  // Basic účet - více informací
 html += `
  <div class="d-flex justify-content-between align-items-center mb-1">
    <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${p.name}</h3>
    ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
      ? `<img src="/icons/approved_4.png" alt="Ověřený provozovatel" width="60" class="me-2">` 
      : ''}
    ${p.id && Number(p.id) <= 80
      ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
      : ''}
  </div>
`;
  
  
  
 if (p.volunteer === 'ANO') {
        html += `<div class="mb-2"><span class="badge-volunteer">Dobrovolník</span></div>`;
      }
  if (p.drones) html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
  if (p.note) html += `<p><i class="bi bi-chat-left-text me-1"></i><strong>O mně:</strong> ${p.note}</p>`;
  if (p.travel) html += `<p><i class="bi bi-signpost me-1"></i><strong>Dojíždění:</strong> ${p.travel}</p>`;
  if (p.licenses) html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
  if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;

  // Tlačítko pro napsání pilotovi
  html += `
    <div class="mt-3">
      <button class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" onclick="contactPilot('${p.email}')">
        ✉️ Napsat pilotovi
      </button>
    </div>
  `;
}
 else if (p.type_account === "Premium") {
      // Premium účet - všechny informace
      html += `
  <div class="d-flex justify-content-between align-items-center mb-1">
    <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${p.name}</h3>
    ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
      ? `<img src="/icons/approved_4.png" alt="Ověřený provozovatel" width="60" class="me-2">` 
      : ''}
    ${p.id && Number(p.id) <= 80
      ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
      : ''}
  </div>
`;
  
  
      if (p.volunteer === 'ANO') {
        html += `<div class="mb-2"><span class="badge-volunteer">Dobrovolník</span></div>`;
      }

      // Kontakty pro Premium účty
      if (p.email) html += `<p><i class="bi bi-envelope-at me-1"></i><a href="mailto:${p.email}">${p.email}</a></p>`;
      if (p.phone) html += `<p><i class="bi bi-telephone-fill me-1"></i><a href="tel:${p.phone}">${p.phone}</a></p>`;

      html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
      if (p.travel) html += `<p><i class="bi bi-signpost me-1"></i><strong>Dojíždění:</strong> ${p.travel}</p>`;
      if (p.licenses) html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
    }
  } else if (!isAvailable) {
    // Pilot není k dispozici
    html += `
      <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>

      <br>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovolník</span></div>` : ''}
      <p class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Tento pilot momentálně není k dispozici</p>
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    `;
  } else {
    // Nepřihlášený uživatel
    html += `
      <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
      
      <br>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovolník</span></div>` : ''}
      <p><i class="bi bi-envelope-at me-1"></i><span class="text-muted">[e-mail po přihlášení]</span></p>
      ${p.phone ? `<p><i class="bi bi-telephone-fill me-1"></i><span class="text-muted">[telefon skryt]</span></p>` : ''}
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
      ${p.travel ? `<p><i class="bi bi-signpost me-1"></i><strong>Dojíždění:</strong> ${p.travel}</p>` : ''}
      <p class="text-muted"><em>Přihlaste se jako inzerent a navažte pro více informací o pilotovi.</em></p>
    `;
  }

  html += `</div>`;
  return html;
})

            markers.addLayer(circle);
            pilotCircles.push(circle);
          }
        });
        map.addLayer(markers);
        if (markers.getBounds().isValid()) {
          map.fitBounds(markers.getBounds(), { padding: [30, 30] });
        }
      });

    map.on('zoomend', () => {
  const zoom = map.getZoom();
  pilotCircles.forEach(circle => {
    const maxZoom = 14;
    const minZoom = 7;
    const minRadius = 100;
    const maxRadius = 2000;

    // Nastavení rádiusu pro různé typy účtů
    let accountMinRadius = minRadius;
    let accountMaxRadius = maxRadius;

    if (circle.options.fillColor === 'darkgreen') { // Basic účet (tmavě zelený)
      accountMinRadius = 100;   // Min rádius pro Basic
      accountMaxRadius = 4000;  // Max rádius pro Basic
    } else if (circle.options.fillColor === 'purple') { // Premium účet (fialový)
      accountMinRadius = 100;  // Min rádius pro Premium
      accountMaxRadius = 10000; // Max rádius pro Premium
    }

    const ratio = (zoom - minZoom) / (maxZoom - minZoom);
    const radius = Math.max(accountMinRadius, accountMaxRadius - (accountMaxRadius - accountMinRadius) * ratio);
    circle.setRadius(radius);

    const opacity = 0.2 + 0.2 * (1 - ratio);
    circle.setStyle({ fillOpacity: opacity });
  });
});

    document.addEventListener("DOMContentLoaded", () => {
      const loginBox = document.getElementById("login-box");
      const toggle = document.getElementById("login-toggle");
      const status = document.getElementById("user-status");
      const loggedEmail = localStorage.getItem("loggedEmail");
      const editBtn = document.getElementById("edit-profile-btn");
      const messagesNavItem = document.getElementById("messages-nav-item");

const inzerentNavItem = document.getElementById("inzerent-nav-item");
  if (!loggedEmail && inzerentNavItem) {
  inzerentNavItem.style.display = "block";
}

if (loggedEmail) {
  loginBox.style.display = "none";
  editBtn.style.display = "inline-block";
  toggle.textContent = "Odhlásit";
  status.textContent = "Přihlášen jako: " + loggedEmail;
  
  // Zobrazení "Moje zprávy" pro přihlášené uživatele
  const messagesNavItem = document.getElementById("messages-nav-item");
  if (messagesNavItem) {
    messagesNavItem.style.display = "block";
  }

  // Zobrazení "Poptávky" jen pro účty Basic/Premium
  const poptavkyNavItem = document.getElementById("poptavky-nav-item");
  if (poptavkyNavItem && loggedEmail) {
    fetch('/get-my-pilot', { credentials: 'include' })
      .then(r => r.ok ? r.json() : null)
      .then(me => {
        const t = (me?.type_account || '').toLowerCase();
        if (t === 'basic' || t === 'premium') {
          poptavkyNavItem.style.display = "block";
        } else {
          poptavkyNavItem.style.display = "none";
        }
      })
      .catch(() => { poptavkyNavItem.style.display = "none"; });
  }

  toggle.addEventListener("click", () => {
    localStorage.removeItem("loggedEmail");
    window.location.reload();
  });
} else {
  toggle.addEventListener("click", () => {
    loginBox.style.display = loginBox.style.display === "none" ? "block" : "none";
  });
}

if (loggedEmail && editBtn) {
  editBtn.style.display = "inline-block";
  editBtn.addEventListener("click", () => {
    window.location.href = "/account.html?email=" + encodeURIComponent(loggedEmail);
  });
}


      window.pilotLogin = function(event) {
        event.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const statusBox = document.getElementById("login-status");

        fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        })
        .then(res => {
          if (!res.ok) throw new Error("Neplatný e-mail nebo heslo.");
          return res.text();
        })
        .then(msg => {
          localStorage.setItem("loggedEmail", email);
          statusBox.style.color = "green";
          statusBox.textContent = msg;
          window.location.href = "/account.html?email=" + encodeURIComponent(email);
        })
        .catch(err => {
          statusBox.style.color = "red";
          statusBox.textContent = err.message;
        });
      };
    });

function contactPilot(pilotEmail) {
  const currentUserEmail = localStorage.getItem('loggedEmail') || localStorage.getItem('inzerentEmail');
  const currentUserType  = localStorage.getItem('loggedEmail') ? 'pilot' : 'inzerent';
  
  if (!currentUserEmail) {
    alert("Pro komunikaci s piloty se musíte přihlásit.");
    return;
  }

  Promise.all([
    fetch(`/get-user-id?email=${encodeURIComponent(currentUserEmail)}&type=${currentUserType}`).then(res => res.json()),
    fetch(`/get-user-id?email=${encodeURIComponent(pilotEmail)}&type=pilot`).then(res => res.json())
  ])
  .then(([currentUser, partner]) => {
    return fetch('/create-conversation', {   // ← správný endpoint
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pilotEmail: pilotEmail,
        advertiserEmail: currentUserType === 'inzerent' ? currentUserEmail : null
      })
    }).then(res => res.json());
  })
  .then(({ success, conversationId }) => {   // ← server vrací conversationId
    if (!success) throw new Error("Nepodařilo se vytvořit konverzaci.");
    window.location.href = `/chat.html?conversationId=${conversationId}`;
  })
  .catch(err => {
    console.error("Chyba při vytváření konverzace:", err);
    alert("Pro navázání konverzace se přihlašte jako inzerent.");
  });
}document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("sendContactMessage").addEventListener("click", () => {
    const pilotEmail = document.getElementById("contactPilotEmail").value;
    const message = document.getElementById("contactMessage").value.trim();

    if (!message) {
      alert("Prosím napište zprávu.");
      return;
    }

    fetch('/contact-pilot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to: pilotEmail, message })
    })
    .then(res => {
      if (!res.ok) throw new Error("Nepodařilo se odeslat zprávu.");
      return res.text();
    })
    .then(response => {
      alert(response);
      bootstrap.Modal.getInstance(document.getElementById('contactPilotModal')).hide();
    })
    .catch(err => alert("❌ Chyba: " + err.message));
  });
});
  </script>
<script>

  const advertiserEmail = localStorage.getItem("inzerentEmail");

  if (advertiserEmail) {
    const banner = document.createElement("div");
    banner.className = "alert alert-warning text-center m-3 d-flex justify-content-center align-items-center";
    banner.innerHTML = `
      <div>
        <strong>Přihlášen inzerent:</strong> ${advertiserEmail}
      </div>
    `;

    const logoutBtn = document.createElement("button");
    logoutBtn.className = "btn btn-sm btn-outline-dark ms-3";
    logoutBtn.textContent = "Odhlásit se";
    logoutBtn.onclick = () => {
      localStorage.removeItem("inzerentEmail");
      window.location.reload();
    };

    banner.appendChild(logoutBtn);
    document.body.prepend(banner);
  }


fetch(`/get-conversations?pilotEmail=${encodeURIComponent(pilotEmail)}&inzerentEmail=${encodeURIComponent(advertiserEmail)}`)

        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("conversations-list");
          container.innerHTML = "";

          if (data.success && data.conversations.length > 0) {
            data.conversations.forEach(conv => {
              const conversationCard = document.createElement("a");
              conversationCard.href = `/chat.html?conversationId=${conv.id}&pilotEmail=${encodeURIComponent(pilotEmail)}&inzerentEmail=${encodeURIComponent(conv.advertiser_email)}`;
              conversationCard.className = `conversation-card d-block p-3 border-bottom ${conv.unread ? 'unread' : ''}`;
              
              conversationCard.innerHTML = `
                <div class="d-flex justify-content-between">
                  <div>
                    <h5 class="mb-1">${conv.advertiser_name || conv.advertiser_email}</h5>
                    <p class="mb-1 last-message">${conv.last_message || 'Žádné zprávy'}</p>
                  </div>
                  <div class="text-end">
                    <span class="time-ago">${formatTimeAgo(conv.last_message_time)}</span>
                    ${conv.unread ? '<span class="badge bg-primary ms-2">Nové</span>' : ''}
                  </div>
                </div>
              `;
              container.appendChild(conversationCard);
            });
          } else {
            container.innerHTML = `
              <div class="text-center py-5">
                <i class="bi bi-envelope-open display-5 text-muted"></i>
                <p class="mt-3">Zatím nemáte žádné zprávy</p>
                <a href="/index.html" class="btn btn-primary mt-2">Najít zakázky</a>
              </div>
            `;
          }
        })
        .catch(err => {
          console.error("Chyba při načítání konverzací:", err);
          document.getElementById("conversations-list").innerHTML = `
            <div class="text-center py-5 text-danger">
              <i class="bi bi-exclamation-triangle display-5"></i>
              <p class="mt-3">Nepodařilo se načíst konverzace</p>
              <button onclick="window.location.reload()" class="btn btn-outline-primary mt-2">
                <i class="bi bi-arrow-repeat"></i> Zkusit znovu
              </button>
            </div>
          `;
        });

      // Helper function to format time ago
      function formatTimeAgo(timestamp) {
        if (!timestamp) return "";
        const now = new Date();
        const msgDate = new Date(timestamp);
        const diff = Math.floor((now - msgDate) / 1000); // difference in seconds
        
        if (diff < 60) return "právě teď";
        if (diff < 3600) return `${Math.floor(diff/60)} min`;
        if (diff < 86400) return `${Math.floor(diff/3600)} h`;
        return `${Math.floor(diff/86400)} d`;
      }
    });
</script>



<script>
  document.addEventListener("DOMContentLoaded", () => {
    const inzerentEmail = localStorage.getItem("inzerentEmail");
    const loginWrapper = document.getElementById("pilot-login-wrapper");

    if (inzerentEmail && loginWrapper) {
      loginWrapper.style.display = "none";
    }
  });
</script>



<div class="modal fade" id="contactPilotModal" tabindex="-1" aria-labelledby="contactPilotModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="contactPilotModalLabel">Napsat pilotovi</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="contactMessage" class="form-label">Vaše zpráva</label>
          <textarea id="contactMessage" class="form-control" rows="5" placeholder="Napište zde svou zprávu..."></textarea>
        </div>
        <input type="hidden" id="contactPilotEmail">
      </div>

<!-- Modal pro souhlas se zveřejněním kontaktů -->
<div class="modal fade" id="publicContactConsentModal" tabindex="-1" aria-labelledby="publicContactConsentLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="publicContactConsentLabel">Souhlas se zveřejněním kontaktů</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
      </div>
      <div class="modal-body">
        Souhlasím, aby můj e‑mail a telefon byly veřejně zobrazeny na mém profilu.
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="premiumConsentCheck">
          <label class="form-check-label" for="premiumConsentCheck">
            Souhlasím se zveřejněním kontaktních údajů
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zrušit</button>
        <button type="button" class="btn btn-warning" id="confirmPremiumConsent">Potvrdit</button>
      </div>
    </div>
  </div>
</div>


<script>
document.getElementById('confirmPremiumConsent').addEventListener('click', function() {
  if (!document.getElementById('premiumConsentCheck').checked) {
    alert("Musíte potvrdit souhlas se zveřejněním kontaktů.");
    return;
  }

  fetch('/save-consent', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      consent_type: 'public_contact',
      consent_text: 'Souhlas se zveřejněním e-mailu a telefonu na veřejném profilu.',
      timestamp: new Date().toISOString()
    })
  })
  .then(res => {
    if (!res.ok) throw new Error("Nepodařilo se uložit souhlas.");
    alert("Souhlas byl uložen. Vaše kontakty budou nyní viditelné.");
    location.reload();
  })
  .catch(err => alert(err.message));
});
</script>

      <div class="modal-footer">
        <button type="button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" data-bs-dismiss="modal">Zavřít</button>
        <button type="button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" id="sendContactMessage">Odeslat</button>
      </div>
    </div>
  </div>
</div>

<footer class="footer mt-5 pt-4 pb-4 bg-light border-top">
  <div class="container">
    <div class="row gy-3 justify-content-between">
      
      <!-- Logo a popis -->
      <div class="col-md-4">
        <a href="/" class="d-flex align-items-center mb-2 text-decoration-none text-dark">
          <img src="/icons/logo.png" alt="Logo NajdiPilota" height="40" class="me-2" />
          <span class="fw-bold fs-5">NajdiPilota.cz</span>
        </a>
        <p class="small text-muted">Spojujeme zákazníky s ověřenými piloty dronů po celé ČR. Rychlé spojení bez prostředníků.</p>
      </div>

      <!-- Navigace -->
      <div display="no" class="col-md-2">
        <h6 class="fw-bold">Navigace</h6>
        <ul class="list-unstyled">
          <li><a href="/index.html" class="text-decoration-none text-muted">Mapa pilotů</a></li>
          <li><a href="/o-projektu.html" class="text-decoration-none text-muted">O projektu</a></li>
          <li><a href="/kontakt.html" class="text-decoration-none text-muted">Kontakt</a></li>
        <li><a href="/v-procesu.html" class="text-decoration-none text-muted">Blog</a></li>
        </ul>
      </div>

      <!-- Právní -->
      <div class="col-md-3">
        <h6 class="fw-bold">Informace</h6>
        <ul class="list-unstyled">
          <li><a href="/gdpr.html" class="text-decoration-none text-muted">Zpracování osobních údajů</a></li>
          <li><a href="/v-procesu.html" class="text-decoration-none text-muted">Cookies</a></li>
          <li><a href="/v-procesu.html" class="text-decoration-none text-muted">Obchodní podmínky</a></li>
          <li><a href="mailto:dronadmin@seznam.cz?subject=Chyba na webu" class="text-decoration-none text-muted">Nahlásit chybu</a></li>
        </ul>
      </div>

      <!-- Kontakt -->
      <div class="col-md-3">
        <h6 class="fw-bold">Provozovatel</h6>
        <p class="small text-muted mb-1">Ing. Bohuslav Vladyka<br>IČO: 08578591<br>Praha, Česká republika</p>
        <p class="small text-muted mb-0">📧 <a href="mailto:dronadmin@seznam.cz" class="text-muted">dronadmin@seznam.cz</a></p>
      </div>

    </div>

    <hr class="my-4">

    <div class="d-flex justify-content-between align-items-center small text-muted">
      <span>&copy; <span id="year"></span> NajdiPilota.cz</span>
      <div>
        <a href="/v-procesu.html" class="text-muted me-3"><i class="bi bi-facebook"></i></a>
        <a href="/v-procesu.html" class="text-muted me-3"><i class="bi bi-instagram"></i></a>
        <a href="/v-procesu.html" class="text-muted"><i class="bi bi-linkedin"></i></a>
      </div>
    </div>
  </div>
</footer>

<script>
  // Vloží aktuální rok do copyrightu
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("year").textContent = new Date().getFullYear();
  });
</script>

<script>
  // Pokud není stránka určena pro inzerenta, odhlásíme ho
  document.addEventListener("DOMContentLoaded", () => {
    if (localStorage.getItem("inzerentEmail")) {
      localStorage.removeItem("inzerentEmail");
    }
  });
</script>

<script>
  // Automatické přidání třídy 'active' na aktuální stránku v menu
  document.addEventListener("DOMContentLoaded", () => {
    const currentPage = window.location.pathname;
    const navLinks = document.querySelectorAll('.navbar-nav .nav-item .nav-link');
    
    navLinks.forEach(link => {
      if (link.getAttribute('href') === currentPage) {
        link.parentElement.classList.add('active');
      }
    });
  });
</script>

<script>
  // badge do horní navigace (index.html)
  function renderUnreadBadgeIntoNav(count) {
    const li = document.getElementById('messages-nav-item');
    if (!li) return;
    const a = li.querySelector('a.nav-link');
    if (!a) return;

    let badge = a.querySelector('#unread-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'unread-badge';
      badge.className = 'badge rounded-pill bg-danger ms-2';
      a.appendChild(badge);
    }
    if (count > 0) {
      badge.textContent = String(count);
      badge.style.display = '';
    } else {
      badge.style.display = 'none';
    }
  }

  async function refreshUnreadNavBadge() {
    const email = localStorage.getItem('loggedEmail');
    if (!email) return;
    try {
      const r = await fetch('/unread-count?pilotEmail=' + encodeURIComponent(email));
      const data = await r.json();
      renderUnreadBadgeIntoNav(data.count || 0);
    } catch {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    const loggedEmail = localStorage.getItem('loggedEmail');
    if (loggedEmail) {
      // jen pro přihlášené piloty
      refreshUnreadNavBadge();
      setInterval(refreshUnreadNavBadge, 60000); // refresh každou minutu
    }
  });
</script>




</body>
</html>
