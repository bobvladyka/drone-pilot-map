<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dronov√° mapa pilot≈Ø v ƒåesku ‚Äì Najdi nebo se p≈ôidej | Spojujeme piloty a z√°kazn√≠ky</title>
  <meta name="description" content="Hled√°≈° pilota dronu nebo chce≈° b√Ωt vidƒõt na mapƒõ? Najdi pilota podle lokality, specializace, vybaven√≠ a p≈ôipoj se k ovƒõ≈ôen√© komunitƒõ." />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.najdipilota.cz/" />

  <!-- Open Graph -->
  <meta property="og:title" content="Dronov√° mapa pilot≈Ø v ƒåesku" />
  <meta property="og:description" content="Spojujeme z√°kazn√≠ky s piloty dron≈Ø. Zobraz se na mapƒõ nebo si najdi pilota ve sv√©m okol√≠." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.najdipilota.cz/" />
  <meta property="og:image" content="icons/logo.png" />

  <!-- Google verify + GA -->
  <meta name="google-site-verification" content="yxzi02d6ahPBVtx31lx_Mwg07khOFlY_fWUFdkyrsUE" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3KQTXQ496Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3KQTXQ496Y');
  </script>

  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css">

  <!-- Leaflet & Cluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- Favicony -->
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/icons/site.webmanifest">
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">

  <!-- Vlastn√≠ styl -->
  <link rel="stylesheet" href="style.css" />

  <!-- Lehk√° parallax animace pro hero sekci (v√Ωkonovƒõ nen√°roƒçn√°) -->
  <style>
    .hero-landing {
      position: relative;
      min-height: 80vh;
      display: flex;
      align-items: center;
      padding: 64px 0;
      overflow: hidden;
      background:
        linear-gradient(rgba(255,255,255,.7), rgba(255,255,255,.7)),
        url('/icons/bg-map.png');
      background-size: cover;
      background-position: center;
      will-change: background-position;
      animation: heroPan 30s linear infinite alternate;
    }
    @keyframes heroPan {
      0%   { background-position: 50% 45%; }
      100% { background-position: 48% 55%; }
    }
    .hero-landing::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(600px 200px at 20% 80%, rgba(0,119,182,.08), transparent 70%),
        radial-gradient(600px 200px at 80% 20%, rgba(255,167,81,.08), transparent 70%);
      pointer-events:none;
    }
    .hero-title {
      font-size: clamp(2rem, 4vw, 3.5rem);
      font-weight: 800;
      line-height: 1.1;
      color: var(--secondary);
      margin-bottom: 1rem;
      text-align: center;
    }
    .hero-subtitle {
      font-size: clamp(1.05rem, 1.8vw, 1.35rem);
      max-width: 900px;
      margin: 0 auto 1.5rem;
      text-align: center;
    }
    .hero-ctas {
      display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
    }
    .section-spaced { padding: 64px 0; }
    .section-muted { background: var(--background-light); }
    .map-section .section-title {
      display:flex; align-items:center; gap:.5rem;
      color: var(--secondary);
    }
    
    .btn-tool {
      background: #fff; border: 1px solid var(--neutral);
      border-radius: 8px; padding: 8px 12px; box-shadow: var(--shadow);
    }
    .fade-in {
      animation: fadeIn .6s ease both;
    }
    @keyframes fadeIn { from{opacity:0; transform: translateY(8px)} to{opacity:1; transform:none} }
  </style>
</head>

<body>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand fw-bold d-flex align-items-center" href="/index.html">
        <img src="/icons/logo.png" alt="Logo NajdiPilota.cz" height="60" class="me-2" loading="lazy" aria-hidden="true" />
        <span class="fs-4">NajdiPilota.cz</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end align-items-center" id="mainNavbar">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item" id="inzerent-nav-item" style="display:none;">
            <a class="nav-link text-warning fw-bold" href="#" data-bs-toggle="modal" data-bs-target="#inzerentModal">
              <i class="bi bi-megaphone-fill me-1"></i>Pro inzerenty
            </a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/index_new.html">Mapa</a></li>
          <li class="nav-item" id="messages-nav-item" style="display:none;">
            <a class="nav-link" href="/moje-zpravy.html"><i class="bi bi-envelope me-1"></i>Moje zpr√°vy</a>
          </li>
          <li class="nav-item"><a class="nav-link" href="/o-projektu.html">O projektu</a></li>
          <li class="nav-item"><a class="nav-link" href="/kontakt.html">Kontakt</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              üåê Jazyk
            </a>
            <ul class="dropdown-menu" aria-labelledby="langDropdown">
              <li><a class="dropdown-item" href="/index.html"><span class="fi fi-cz me-2"></span>ƒåesky</a></li>
              <li><a class="dropdown-item" href="/index_en.html"><span class="fi fi-gb me-2"></span>English</a></li>
            </ul>
          </li>
        </ul>

        <div class="account-buttons ms-lg-3">
          <span id="logged-info" class="fw-bold small"></span>
          <button id="edit-profile-btn" style="display:none;" class="pilot-login-btn">
            <i class="bi bi-pencil-square me-1"></i> <span>M≈Øj √∫ƒçet</span>
          </button>
          <button id="login-button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2">
            <i class="bi bi-person-badge me-2"></i>
            <span id="login-toggle">P≈ôihl√°sit se jako pilot</span>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="landing-hero">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="hero-content text-center">
          <h1 class="hero-title">Najdi pilota dronu ve sv√©m okol√≠.<br>Nebo se p≈ôidej a buƒè vidƒõt.</h1>
          <p class="hero-subtitle">Komunitn√≠ mapa ovƒõ≈ôen√Ωch pilot≈Ø po cel√© ƒåR. Rychl√Ω kontakt bez prost≈ôedn√≠k≈Ø, profily s v√Ωbavou a specializac√≠, popt√°vky pro Basic/Premium √∫ƒçty.</p>
          <div class="text-center mt-4">
            <img src="/icons/logo.png" alt="Ikona dronu" class="img-fluid" style="max-height: 220px;">
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


  <!-- BENEFITY -->
  <section class="section-spaced">
    <div class="container">
      <div class="row text-center mb-4">
        <div class="col">
          <h2 class="display-6 fw-bold">Proƒç vyu≈æ√≠vat NajdiPilota.cz?</h2>
          <p class="lead">Jednoduch√© a efektivn√≠ propojen√≠ pilot≈Ø dron≈Ø a z√°kazn√≠k≈Ø.</p>
        </div>
      </div>
      <div class="row g-4 justify-content-center">
        <div class="col-md-4 text-center">
          <div class="benefit-icon" style="font-size:2.5rem;"><i class="bi bi-geo-alt"></i></div>
          <h3 class="benefit-title">Lok√°ln√≠ vyhled√°v√°n√≠</h3>
          <p>Najdi piloty ve sv√©m okol√≠ pomoc√≠ interaktivn√≠ mapy. Filtruj podle specializace a vybaven√≠.</p>
        </div>
        <div class="col-md-4 text-center">
          <div class="benefit-icon" style="font-size:2.5rem;"><i class="bi bi-cash-coin"></i></div>
          <h3 class="benefit-title">≈Ω√°dn√© provize</h3>
          <p>Komunikuj p≈ô√≠mo s piloty bez zbyteƒçn√Ωch proviz√≠. U≈°et≈ôi ƒças i pen√≠ze.</p>
        </div>
        <div class="col-md-4 text-center">
          <div class="benefit-icon" style="font-size:2.5rem;"><i class="bi bi-shield-check"></i></div>
          <h3 class="benefit-title">Ovƒõ≈ôen√≠ piloti</h3>
          <p>V≈°echny profily pilot≈Ø jsou ovƒõ≈ôen√©. M≈Ø≈æe≈° si b√Ωt jist√Ω kvalitou slu≈æeb.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MAPA -->
  <section id="mapa" class="map-section section-spaced section-muted">
    <div class="container">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="section-title"><i class="bi bi-map-fill me-2" aria-hidden="true"></i> Dronov√° mapa pilot≈Ø v ƒåesku</h2>
        <p id="user-status" class="fw-bold mb-0"></p>
      </div>

      <!-- Login box (zachov√°no) -->
      <div id="login-modal-backdrop"></div>
      <div id="login-box" style="display: none; position: fixed;">
        <button type="button" class="btn-close close-btn" aria-label="Zav≈ô√≠t"
                onclick="document.getElementById('login-box').style.display='none';"></button>
        <h3>P≈ôihl√°≈°en√≠ pilota</h3>
        <form id="login-form" onsubmit="pilotLogin(event)">
          <div class="mb-3">
            <label for="email" class="form-label">E-mail:</label>
            <input type="email" id="email" name="email" class="form-control" required />
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Heslo:</label>
            <input type="password" id="password" name="password" class="form-control" required />
          </div>
          <button type="submit" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100">
            <i class="bi bi-box-arrow-in-right me-2"></i>P≈ôihl√°sit se
          </button>
        </form>
        <p id="login-status" class="mt-3"></p>
        <a href="/register.html" class="link">Nejsem je≈°tƒõ registrov√°n ‚Äì chci se zaregistrovat</a>
        <a href="/forgot.html" class="link">Zapomenut√© heslo?</a>
      </div>

      
      <div id="map" class="mt-2"></div>
    </div>
  </section>

<!-- CTA SEKCE: PILOT / INZERENT -->
<section class="cta-section py-5">
  <div class="container">
    <div class="row g-4">
      <!-- PILOT -->
      <div class="col-lg-6">
        <div class="cta-card pilot h-100">
          <div class="cta-header text-center">
            <div class="cta-icon">
              <i class="bi bi-person-badge"></i>
            </div>
            <h3 class="cta-title">Jsem pilot</h3>
            <p class="cta-subtitle">Vytvo≈ô si profil a zaƒçni p≈ôij√≠mat popt√°vky</p>
          </div>
          <div class="cta-body">
            <ul class="cta-features">
              <li>Zobrazen√≠ na mapƒõ pilot≈Ø</li>
              <li>Specifikace vybaven√≠ a specializace</li>
              <li>P≈ôij√≠mej popt√°vky od inzerent≈Ø</li>
              <li>Sta≈à se ovƒõ≈ôen√Ωm provozovatelem dronu</li>
              <li>R≈Øzn√© typy √∫ƒçt≈Ø (Free, Basic, Premium)</li>
            </ul>
          </div>
          <div class="cta-footer text-center">
            <a href="/register.html" class="btn btn-landing btn-pilot">
              <i class="bi bi-person-plus me-1"></i> Vytvo≈ôit profil pilota
            </a>
          </div>
        </div>
      </div>

      <!-- INZERENT -->
      <div class="col-lg-6">
        <div class="cta-card inzerent h-100">
          <div class="cta-header text-center">
            <div class="cta-icon">
              <i class="bi bi-megaphone"></i>
            </div>
            <h3 class="cta-title">Jsem inzerent</h3>
            <p class="cta-subtitle">Najdi ide√°ln√≠ho pilota pro sv≈Øj projekt</p>
          </div>
          <div class="cta-body">
            <ul class="cta-features">
              <li>Prohl√≠≈æej mapu ovƒõ≈ôen√Ωch pilot≈Ø</li>
              <li>Filtruj podle specializace a lokality</li>
              <li>Kontaktuj piloty nap≈ô√≠mo</li>
              <li>U≈°et≈ôi ƒças a pen√≠ze</li>
              <li>Jednoduch√° registrace</li>
            </ul>
          </div>
          <div class="cta-footer text-center">
            <a href="/inzerent.html" class="btn btn-landing btn-inzerent">
              <i class="bi bi-building me-1"></i> Registrovat jako inzerent
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


  <!-- Inzerent modal (zachov√°n) -->
  <div class="modal fade" id="inzerentModal" tabindex="-1" aria-labelledby="inzerentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="inzerentModalLabel">
            <i class="bi bi-building me-2"></i>Pro firmy a inzerenty
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body">
          <p>Hled√°te pilota pro nat√°ƒçen√≠, inspekci nebo mapov√°n√≠? Vyberte si z ovƒõ≈ôen√Ωch pilot≈Ø podle regionu a specializace.</p>
        </div>
        <div class="modal-footer">
          <a href="/inzerent.html" class="btn btn-outline-warning">
            <i class="bi bi-person-badge-fill me-1"></i> P≈ôihl√°sit se jako inzerent
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Kontakt pilota modal (zachov√°n) -->
  <div class="modal fade" id="contactPilotModal" tabindex="-1" aria-labelledby="contactPilotModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactPilotModalLabel">Napsat pilotovi</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="contactMessage" class="form-label">Va≈°e zpr√°va</label>
            <textarea id="contactMessage" class="form-control" rows="5" placeholder="Napi≈°te zde svou zpr√°vu..."></textarea>
          </div>
          <input type="hidden" id="contactPilotEmail">
        </div>
        <div class="modal-footer">
          <button type="button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" data-bs-dismiss="modal">Zav≈ô√≠t</button>
          <button type="button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" id="sendContactMessage">Odeslat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Souhlas se zve≈ôejnƒõn√≠m kontakt≈Ø (zachov√°n) -->
  <div class="modal fade" id="publicContactConsentModal" tabindex="-1" aria-labelledby="publicContactConsentLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="publicContactConsentLabel">Souhlas se zve≈ôejnƒõn√≠m kontakt≈Ø</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zav≈ô√≠t"></button>
        </div>
        <div class="modal-body">
          Souhlas√≠m, aby m≈Øj e-mail a telefon byly ve≈ôejnƒõ zobrazeny na m√©m profilu.
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="premiumConsentCheck">
            <label class="form-check-label" for="premiumConsentCheck">
              Souhlas√≠m se zve≈ôejnƒõn√≠m kontaktn√≠ch √∫daj≈Ø
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Zru≈°it</button>
          <button type="button" class="btn btn-warning" id="confirmPremiumConsent">Potvrdit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER (zachov√°n) -->
  <footer class="footer mt-5 pt-4 pb-4 bg-light border-top">
    <div class="container">
      <div class="row gy-3 justify-content-between">
        <div class="col-md-4">
          <a href="/" class="d-flex align-items-center mb-2 text-decoration-none text-dark">
            <img src="/icons/logo.png" alt="Logo NajdiPilota" height="40" class="me-2" />
            <span class="fw-bold fs-5">NajdiPilota.cz</span>
          </a>
          <p class="small text-muted">Spojujeme z√°kazn√≠ky s ovƒõ≈ôen√Ωmi piloty dron≈Ø po cel√© ƒåR. Rychl√© spojen√≠ bez prost≈ôedn√≠k≈Ø.</p>
        </div>
        <div class="col-md-2">
          <h6 class="fw-bold">Navigace</h6>
          <ul class="list-unstyled">
            <li><a href="/index.html" class="text-decoration-none text-muted">Mapa pilot≈Ø</a></li>
            <li><a href="/o-projektu.html" class="text-decoration-none text-muted">O projektu</a></li>
            <li><a href="/kontakt.html" class="text-decoration-none text-muted">Kontakt</a></li>
            <li><a href="/v-procesu.html" class="text-decoration-none text-muted">Blog</a></li>
          </ul>
        </div>
        <div class="col-md-3">
          <h6 class="fw-bold">Informace</h6>
          <ul class="list-unstyled">
            <li><a href="/gdpr.html" class="text-decoration-none text-muted">Zpracov√°n√≠ osobn√≠ch √∫daj≈Ø</a></li>
            <li><a href="/obchodni-podminky.html" class="text-decoration-none text-muted">Obchodn√≠ podm√≠nky</a></li>
            <li><a href="mailto:dronadmin@seznam.cz?subject=Chyba na webu" class="text-decoration-none text-muted">Nahl√°sit chybu</a></li>
          </ul>
        </div>
        <div class="col-md-3">
          <h6 class="fw-bold">Provozovatel</h6>
          <p class="small text-muted mb-1">Ing. Bohuslav Vladyka<br>IƒåO: 08578591<br>Praha, ƒåesk√° republika</p>
          <p class="small text-muted mb-0">üìß <a href="mailto:dronadmin@seznam.cz" class="text-muted">dronadmin@seznam.cz</a></p>
        </div>
      </div>
      <hr class="my-4">
      <div class="d-flex justify-content-between align-items-center small text-muted">
        <span>&copy; <span id="year"></span> NajdiPilota.cz</span>
        <div>
          <a href="/v-procesu.html" class="text-muted me-3"><i class="bi bi-facebook"></i></a>
          <a href="/v-procesu.html" class="text-muted me-3"><i class="bi bi-instagram"></i></a>
          <a href="/v-procesu.html" class="text-muted"><i class="bi bi-linkedin"></i></a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Leaflet & Cluster JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- APLIKAƒåN√ç LOGIKA: p≈ôevzato a zrefaktorov√°no z p≈Øvodn√≠ho index.html (beze zmƒõny funkc√≠ a endpoint≈Ø) -->
  <script>
    const map = L.map('map').setView([49.8, 15.5], 7);
    const fakeNames = [
      "Rychl√Ω Sysel","L√©taj√≠c√≠ Brambor","Dronislav Nebe≈°≈•√°k","Turbo R√°kosn√≠k","Bezpilotn√≠ Emil","P√≠skaj√≠c√≠ P√°v",
      "Pilotka Haluz","Franti≈°ek Vrtuln√≠k","Lev√Ω Joystick","Kapit√°n St√≠n","Dr. Rotor","Pan Toƒçiv√Ω","Letu≈°ka Landov√°",
      "St≈ôemhlav√Ω Franta","Nadzvukov√Ω Je≈æek","L√©taj√≠c√≠ ƒåenda","Rotorov√° R√≥za","≈†um√≠c√≠ Fanda","Bezpeƒçn√Ω B√©ƒèa","Maj√°k z Oblak",
      "Dron√Ω Karel","Letec ≈†matla","Start√©r Stan√≠k","P≈ôist√°vac√≠ Pepa","Helikopt√©rn√≠k Honza","Navig√°tor Nov√°k","Senzorov√° So≈àa",
      "P√°n Mrak≈Ø","Let√≠c√≠ Lojza","Kamera Kamil","Rotor R√≠≈°a","V√Ω≈°komƒõr Va≈°ek","Vzdu≈°n√Ω Vojta","Tich√Ω ≈†um√°k","Drnƒçiv√Ω Dan",
      "Mlha Milda","Optika Otakar","Ztracen√Ω Sign√°l","Mistr Gimbal","Ant√©na Aniƒçka","Vrtulka Vƒõrka","Letmo L√≠da",
      "Flyboy Felix","Vzdu≈°n√° V√≠la","Navigaƒçn√≠ Norbert","Modr√° Letka","K≈ô√≠dlat√Ω Karel","Poln√≠ P≈ô√≠zrak","Mapov√Ω Mirek","Kliƒçkuj√≠c√≠ Kuba"
    ];

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18
    }).addTo(map);

    const markers = L.markerClusterGroup();
    const pilotCircles = [];

    // Naƒçten√≠ pilot≈Ø
    fetch('/pilots')
      .then(res => res.json())
      .then(data => {
        data.forEach(p => {
          if (p.visible !== "ANO") return;
          if (p.latitude != null && p.longitude != null) {
            let circleOptions = {
              radius: 2000,
              fillOpacity: 0.2,
              color: p.available === "ANO" ? 'green' : 'gray',
              fillColor: p.available === "ANO" ? '#4CAF50' : '#CCCCCC',
              weight: 1
            };

            if (p.type_account === "Free") {
              circleOptions.color = 'lightgreen';
              circleOptions.fillOpacity = 0.2;
            } else if (p.type_account === "Basic") {
              circleOptions.color = 'darkgreen';
              circleOptions.fillOpacity = 0.5;
            } else if (p.type_account === "Premium") {
              circleOptions.color = 'purple';
              circleOptions.fillColor = 'purple';
              circleOptions.fillOpacity = 0.8;
              circleOptions.radius = 10000;
              circleOptions.weight = 3;
            }

            const circle = L.circle([p.latitude, p.longitude], circleOptions).bindPopup(() => {
              const loggedIn = localStorage.getItem("loggedEmail") || localStorage.getItem("inzerentEmail");
              const isAvailable = p.available === "ANO";
              const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
              const hasBuildBadge = p.id && Number(p.id) <= 80;
              const buildBadge = hasBuildBadge ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">` : "";
              const pilotNameWithBadge = `${p.name || ''}${buildBadge}`;
              const fakeNameWithBadge  = `${fakeName}${buildBadge}`;
              const hasPublicConsent = (() => {
                const v = (p.hasPublicConsent ?? p.granted ?? false);
                if (typeof v === 'boolean') return v;
                const s = String(v).trim().toLowerCase();
                return s === 'true' || s === 't' || s === '1' || s === 'ano' || s === 'yes';
              })();

              if (!hasPublicConsent) {
                return `
                  <div class="pilot-card">
                    <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      ${p.volunteer === 'ANO' ? `<span class="badge-volunteer">Dobrovoln√≠k</span>` : ''}
                      <span class="badge-gdpr">Bez GDPR souhlasu ‚Äì kontakt p≈ôes administr√°tora</span>
                    </div>
                    ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
                  </div>
                `;
              }

              let html = `<div class="pilot-card">`;
              if (isAvailable && loggedIn) {
                if (p.type_account === "Free") {
                  html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${p.name}</h3>
                      ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
                      ${hasBuildBadge ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">` : ''}
                    </div>`;
                  if (p.volunteer === 'ANO') html += `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>`;
                  if (p.drones) html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
                  if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
                  html += `</div>`;
                } else if (p.type_account === "Basic") {
                  html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${p.name}</h3>
                      ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
                      ${hasBuildBadge ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">` : ''}
                    </div>`;
                  if (p.volunteer === 'ANO') html += `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>`;
                  if (p.drones) html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
                  if (p.note) html += `<p><i class="bi bi-chat-left-text me-1"></i><strong>O mnƒõ:</strong> ${p.note}</p>`;
                  if (p.travel) html += `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>`;
                  if (p.licenses) html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
                  if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
                  html += `<div class="mt-3">
                      <button class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" onclick="contactPilot('${p.email}')">‚úâÔ∏è Napsat pilotovi</button>
                    </div>`;
                } else if (p.type_account === "Premium") {
                  html += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${p.name}</h3>
                      ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
                      ${hasBuildBadge ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">` : ''}
                    </div>`;
                  if (p.volunteer === 'ANO') html += `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>`;
                  if (p.email) html += `<p><i class="bi bi-envelope-at me-1"></i><a href="mailto:${p.email}">${p.email}</a></p>`;
                  if (p.phone) html += `<p><i class="bi bi-telephone-fill me-1"></i><a href="tel:${p.phone}">${p.phone}</a></p>`;
                  html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
                  if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
                  if (p.travel) html += `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>`;
                  if (p.licenses) html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
                }
              } else if (!isAvailable) {
                html += `
                  <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
                  <br>
                  ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
                  <p class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Tento pilot moment√°lnƒõ nen√≠ k dispozici</p>
                  ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
                `;
              } else {
                html += `
                  <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
                  <br>
                  ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
                  <p><i class="bi bi-envelope-at me-1"></i><span class="text-muted">[e-mail po p≈ôihl√°≈°en√≠]</span></p>
                  ${p.phone ? `<p><i class="bi bi-telephone-fill me-1"></i><span class="text-muted">[telefon skryt]</span></p>` : ''}
                  ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
                  ${p.travel ? `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>` : ''}
                  <p class="text-muted"><em>P≈ôihlaste se jako inzerent a nava≈æte pro v√≠ce informac√≠ o pilotovi.</em></p>
                `;
              }
              html += `</div>`;
              return html;
            });

            markers.addLayer(circle);
            pilotCircles.push(circle);
          }
        });
        map.addLayer(markers);
        if (markers.getBounds().isValid()) {
          map.fitBounds(markers.getBounds(), { padding: [30, 30] });
        }
      });

    // Responsivn√≠ zmƒõna polomƒõru a opacity kruh≈Ø dle zoomu
    map.on('zoomend', () => {
      const zoom = map.getZoom();
      pilotCircles.forEach(circle => {
        const maxZoom = 14;
        const minZoom = 7;
        const minRadius = 100;
        const maxRadius = 2000;

        let accountMinRadius = minRadius;
        let accountMaxRadius = maxRadius;

        if (circle.options.fillColor === 'darkgreen') {
          accountMinRadius = 100;
          accountMaxRadius = 4000;
        } else if (circle.options.fillColor === 'purple') {
          accountMinRadius = 100;
          accountMaxRadius = 10000;
        }
        const ratio = (zoom - minZoom) / (maxZoom - minZoom);
        const radius = Math.max(accountMinRadius, accountMaxRadius - (accountMaxRadius - accountMinRadius) * ratio);
        circle.setRadius(radius);
        const opacity = 0.2 + 0.2 * (1 - ratio);
        circle.setStyle({ fillOpacity: opacity });
      });
    });

    // Ovl√°dac√≠ prvky mapy
    document.getElementById('locateMe').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolokace nen√≠ podporov√°na.');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 12);
      }, () => alert('Nepoda≈ôilo se zjistit polohu.'));
    });
    document.getElementById('resetView').addEventListener('click', () => {
      if (markers.getBounds().isValid()) {
        map.fitBounds(markers.getBounds(), { padding: [30, 30] });
      } else {
        map.setView([49.8, 15.5], 7);
      }
    });

    // P≈ôihl√°≈°en√≠ & UI logika (zachov√°no)
    document.addEventListener("DOMContentLoaded", () => {
      const loginBox = document.getElementById("login-box");
      const toggle = document.getElementById("login-toggle");
      const status = document.getElementById("user-status");
      const loggedEmail = localStorage.getItem("loggedEmail");
      const editBtn = document.getElementById("edit-profile-btn");
      const messagesNavItem = document.getElementById("messages-nav-item");
      const inzerentNavItem = document.getElementById("inzerent-nav-item");

      if (!loggedEmail && inzerentNavItem) inzerentNavItem.style.display = "block";

      if (loggedEmail) {
        loginBox.style.display = "none";
        editBtn.style.display = "inline-block";
        toggle.textContent = "Odhl√°sit";

        if (messagesNavItem) messagesNavItem.style.display = "block";

        const poptavkyNavItem = document.getElementById("poptavky-nav-item");
        if (poptavkyNavItem && loggedEmail) {
          fetch('/get-my-pilot', { credentials: 'include' })
            .then(r => r.ok ? r.json() : null)
            .then(me => {
              const t = (me?.type_account || '').toLowerCase();
              poptavkyNavItem.style.display = (t === 'basic' || t === 'premium') ? "block" : "none";
            })
            .catch(() => { if (poptavkyNavItem) poptavkyNavItem.style.display = "none"; });
        }

        toggle.addEventListener("click", () => {
          localStorage.removeItem("loggedEmail");
          window.location.reload();
        });
      } else {
        toggle.addEventListener("click", () => {
          loginBox.style.display = (loginBox.style.display === "none" || !loginBox.style.display) ? "block" : "none";
        });
      }

      if (loggedEmail && editBtn) {
        editBtn.style.display = "inline-block";
        editBtn.addEventListener("click", () => {
          window.location.href = "/account.html?email=" + encodeURIComponent(loggedEmail);
        });
      }

            window.pilotLogin = function(event) {
        event.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const statusBox = document.getElementById("login-status");

        fetch("/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        })
        .then(res => { if (!res.ok) throw new Error("Neplatn√Ω e-mail nebo heslo."); return res.text(); })
        .then(async msg => {
          const res = await fetch(`/get-user-id?email=${encodeURIComponent(email)}&type=pilot`);
          const data = await res.json();
          if (data.success) {
            localStorage.setItem("pilotId", data.id);
            localStorage.setItem("pilotEmail", data.email);
          }
          localStorage.setItem("loggedEmail", email);
          statusBox.style.color = "green";
          statusBox.textContent = msg;
          window.location.href = "/account.html?email=" + encodeURIComponent(email);
        })
        .catch(err => {
          statusBox.style.color = "red";
          statusBox.textContent = err.message;
        });
      };
    });


    function contactPilot(pilotEmail) {
      const currentUserEmail = localStorage.getItem('loggedEmail') || localStorage.getItem('inzerentEmail');
      const currentUserType  = localStorage.getItem('loggedEmail') ? 'pilot' : 'inzerent';

      if (!currentUserEmail) {
        alert("Pro komunikaci s piloty se mus√≠te p≈ôihl√°sit.");
        return;
      }

      Promise.all([
        fetch(`/get-user-id?email=${encodeURIComponent(currentUserEmail)}&type=${currentUserType}`).then(res => res.json()),
        fetch(`/get-user-id?email=${encodeURIComponent(pilotEmail)}&type=pilot`).then(res => res.json())
      ])
      .then(([currentUser, partner]) => {
        return fetch('/create-conversation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pilotEmail: pilotEmail,
            advertiserEmail: currentUserType === 'inzerent' ? currentUserEmail : null
          })
        }).then(res => res.json());
      })
      .then(({ success, conversationId }) => {
        if (!success) throw new Error("Nepoda≈ôilo se vytvo≈ôit konverzaci.");
        window.location.href = `/chat.html?conversationId=${conversationId}`;
      })
      .catch(err => {
        console.error("Chyba p≈ôi vytv√°≈ôen√≠ konverzace:", err);
        alert("Pro nav√°z√°n√≠ konverzace se p≈ôihla≈°te jako inzerent.");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const advertiserEmail = localStorage.getItem("inzerentEmail");
      if (advertiserEmail) {
        const banner = document.createElement("div");
        banner.className = "alert alert-warning text-center m-3 d-flex justify-content-center align-items-center";
        banner.innerHTML = `<div><strong>P≈ôihl√°≈°en inzerent:</strong> ${advertiserEmail}</div>`;
        const logoutBtn = document.createElement("button");
        logoutBtn.className = "btn btn-sm btn-outline-dark ms-3";
        logoutBtn.textContent = "Odhl√°sit se";
        logoutBtn.onclick = () => { localStorage.removeItem("inzerentEmail"); window.location.reload(); };
        banner.appendChild(logoutBtn);
        document.body.prepend(banner);
      }

      // Odesl√°n√≠ zpr√°vy pilotovi
      const sendBtn = document.getElementById("sendContactMessage");
      if (sendBtn) {
        sendBtn.addEventListener("click", () => {
          const pilotEmail = document.getElementById("contactPilotEmail").value;
          const message = document.getElementById("contactMessage").value.trim();
          if (!message) return alert("Pros√≠m napi≈°te zpr√°vu.");
          fetch('/contact-pilot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ to: pilotEmail, message })
          })
          .then(res => { if (!res.ok) throw new Error("Nepoda≈ôilo se odeslat zpr√°vu."); return res.text(); })
          .then(response => {
            alert(response);
            bootstrap.Modal.getInstance(document.getElementById('contactPilotModal')).hide();
          })
          .catch(err => alert("‚ùå Chyba: " + err.message));
        });
      }
    });

    // Ulo≈æen√≠ ve≈ôejn√©ho souhlasu s kontakty
    document.getElementById('confirmPremiumConsent')?.addEventListener('click', function() {
      if (!document.getElementById('premiumConsentCheck').checked) {
        alert("Mus√≠te potvrdit souhlas se zve≈ôejnƒõn√≠m kontakt≈Ø.");
        return;
      }
      fetch('/save-consent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          consent_type: 'public_contact',
          consent_text: 'Souhlas se zve≈ôejnƒõn√≠m e-mailu a telefonu na ve≈ôejn√©m profilu.',
          timestamp: new Date().toISOString()
        })
      })
      .then(res => { if (!res.ok) throw new Error("Nepoda≈ôilo se ulo≈æit souhlas."); alert("Souhlas byl ulo≈æen. Va≈°e kontakty budou nyn√≠ viditeln√©."); location.reload(); })
      .catch(err => alert(err.message));
    });

    // Zobrazen√≠/skr√Ωv√°n√≠ wrapperu pro pilot login p≈ôi p≈ôihl√°≈°en√©m inzerentovi
    document.addEventListener("DOMContentLoaded", () => {
      const inzerentEmail = localStorage.getItem("inzerentEmail");
      const loginWrapper = document.getElementById("pilot-login-wrapper");
      if (inzerentEmail && loginWrapper) loginWrapper.style.display = "none";
    });

    // Dynamick√Ω rok
    document.addEventListener("DOMContentLoaded", () => {
      const y = document.getElementById("year");
      if (y) y.textContent = new Date().getFullYear();
    });

    // Odhl√°≈°en√≠ inzerenta mimo jeho str√°nku
    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("inzerentEmail")) {
        // Zachov√°no z p≈Øvodn√≠ho: odhl√°≈°en√≠ jinde ne≈æ na inzerent str√°nce
        // -> ponech√°no, ale neodhla≈°uji automaticky, aby inzerent vidƒõl banner a mohl ruƒçnƒõ odhl√°sit.
      }
    });

    // Aktivn√≠ polo≈æka v menu
    document.addEventListener("DOMContentLoaded", () => {
      const currentPage = window.location.pathname;
      const navLinks = document.querySelectorAll('.navbar-nav .nav-item .nav-link');
      navLinks.forEach(link => {
        if (link.getAttribute('href') === currentPage) {
          link.parentElement.classList.add('active');
        }
      });
    });

    // Badge s nep≈ôeƒçten√Ωmi zpr√°vami
    function renderUnreadBadgeIntoNav(count) {
    const li = document.getElementById('messages-nav-item');
    if (!li) return;
    const a = li.querySelector('a.nav-link');
    if (!a) return;

    let badge = a.querySelector('#unread-badge');
    if (!badge) {
      badge = document.createElement('span');
      badge.id = 'unread-badge';
      badge.className = 'badge rounded-pill bg-danger ms-2';
      a.appendChild(badge);
    }
    if (count > 0) {
      badge.textContent = String(count);
      badge.style.display = '';
    } else {
      badge.style.display = 'none';
    }
  }

  async function refreshUnreadNavBadge() {
    const email = localStorage.getItem('loggedEmail');
    if (!email) return;
    try {
      const r = await fetch('/unread-count?pilotEmail=' + encodeURIComponent(email));
      const data = await r.json();
      renderUnreadBadgeIntoNav(data.count || 0);
    } catch {}
  }

  document.addEventListener('DOMContentLoaded', () => {
    const loggedEmail = localStorage.getItem('loggedEmail');
    if (loggedEmail) {
      refreshUnreadNavBadge();
      setInterval(refreshUnreadNavBadge, 60000);
    }
  });
  </script>

</body>
</html>