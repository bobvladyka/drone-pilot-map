<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dronov√° mapa pilot≈Ø v ƒåesku ‚Äì Najdi nebo se p≈ôidej</title>
  <meta name="description" content="Hled√°≈° pilota dronu nebo chce≈° b√Ωt vidƒõt? Dronov√° mapa spojuje piloty a z√°kazn√≠ky. Rychl√© spojen√≠, ovƒõ≈ôen√≠ u≈æivatel√© a mo≈ænost p≈ôiv√Ωdƒõlku." />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://www.najdipilota.cz/" />
  <meta property="og:title" content="Dronov√° mapa pilot≈Ø v ƒåesku" />
  <meta property="og:description" content="Spojujeme z√°kazn√≠ky s piloty dron≈Ø. Zobraz se na mapƒõ nebo si najdi pilota ve sv√©m okol√≠." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.najdipilota.cz/" />
  <meta property="og:image" content="https://www.najdipilota.cz/og-image.jpg" />
  <meta name="google-site-verification" content="yxzi02d6ahPBVtx31lx_Mwg07khOFlY_fWUFdkyrsUE" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <link rel="manifest" href="/icons/site.webmanifest">
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
  <style>
    html { scroll-behavior: smooth; }
    .navbar .btn + .btn { margin-left: .5rem; }

#scroll-up-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background-color: #f8f9fa;
  border: 1px solid #ccc;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  transition: opacity 0.3s ease, transform 0.3s ease;
  opacity: 0;
  visibility: hidden;
  z-index: 9999;
}
#scroll-up-btn i {
  font-size: 20px;
  color: #333;
}
#scroll-up-btn.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}
#scroll-up-btn:hover {
  background-color: #ffc107;
  border-color: #ffc107;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center">
      <img src="/icons/logo.png" alt="" height="60" class="me-2" loading="lazy" aria-hidden="true" />
      <span class="fs-4">NajdiPilota.cz | Sekce pro inzerenty</span>
      <div class="ms-auto d-none d-md-flex">
        <a href="onlymap.html" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-map me-1"></i>Mapa
        </a>
        <a href="moje-zpravy-inzerent.html" class="btn btn-outline-secondary btn-sm ms-2">
          <i class="bi bi-envelope me-1"></i>Moje zpr√°vy
        </a>
        <a href="poptavky.html" class="btn btn-outline-secondary btn-sm ms-2">
          <i class="bi bi-clipboard-plus me-1"></i>Popt√°vky
        </a>
      </div>
    </a>
  </div>
</nav>

<div id="advertiser-banner" class="alert alert-warning text-center m-3 d-flex justify-content-center align-items-center" style="display: none;">
  <div class="me-3 fw-semibold"><strong id="advertiser-text"></strong></div>
  <div id="credit-display" class="badge bg-success me-3 p-2 fw-bold" style="font-size:1.0em;">Kredit: 0.00 Kƒç</div>
  <button id="logout-btn" class="btn btn-warning">Odhl√°sit se</button>
</div>

<div id="filter-section" class="filter-section bg-light p-3 rounded-3 mb-4 shadow-sm">
  <div class="row g-3">
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-puzzle-fill me-2"></i>Specializace
        </h6>
        <select id="filter-specialization" class="form-select form-select-sm">
          <option value="">V≈°echny specializace</option>
        </select>
      </div>
    </div>
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-geo-alt-fill me-2"></i>Kraj
        </h6>
        <select id="filter-region" class="form-select form-select-sm">
          <option value="">V≈°echny kraje</option>
          <option value="Hlavn√≠ mƒõsto Praha">Hlavn√≠ mƒõsto Praha</option>
          <option value="St≈ôedoƒçesk√Ω kraj">St≈ôedoƒçesk√Ω kraj</option>
          <option value="Jihoƒçesk√Ω kraj">Jihoƒçesk√Ω kraj</option>
          <option value="Plze≈àsk√Ω kraj">Plze≈àsk√Ω kraj</option>
          <option value="Karlovarsk√Ω kraj">Karlovarsk√Ω kraj</option>
          <option value="√östeck√Ω kraj">√östeck√Ω kraj</option>
          <option value="Libereck√Ω kraj">Libereck√Ω kraj</option>
          <option value="Kr√°lov√©hradeck√Ω kraj">Kr√°lov√©hradeck√Ω kraj</option>
          <option value="Pardubick√Ω kraj">Pardubick√Ω kraj</option>
          <option value="Vysoƒçina">Vysoƒçina</option>
          <option value="Jihomoravsk√Ω kraj">Jihomoravsk√Ω kraj</option>
          <option value="Olomouck√Ω kraj">Olomouck√Ω kraj</option>
          <option value="Zl√≠nsk√Ω kraj">Zl√≠nsk√Ω kraj</option>
          <option value="Moravskoslezsk√Ω kraj">Moravskoslezsk√Ω kraj</option>
        </select>
      </div>
    </div>
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-check-circle-fill me-2"></i>Dostupnost
        </h6>
        <select id="filter-availability" class="form-select form-select-sm">
          <option value="">V≈°ichni piloti</option>
          <option value="ANO">Dostupn√≠ piloti</option>
          <option value="NE">Nedostupn√≠ piloti</option>
        </select>
      </div>
    </div>
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-heart-fill me-2"></i>Dobrovoln√≠ci
        </h6>
        <select id="filter-volunteer" class="form-select form-select-sm">
          <option value="">V≈°ichni piloti</option>
          <option value="ANO">Pouze dobrovoln√≠ci</option>
          <option value="NE">Pouze profesion√°lov√©</option>
        </select>
      </div>
    </div>
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-patch-check-fill me-2"></i>Ovƒõ≈ôen√Ω pilot
        </h6>
        <select id="filter-verified" class="form-select form-select-sm">
          <option value="">V≈°ichni</option>
          <option value="YES">Pouze ovƒõ≈ôen√≠</option>
          <option value="NO">Pouze neovƒõ≈ôen√≠</option>
        </select>
      </div>
    </div>
    <div class="col-md-6 d-flex flex-column justify-content-end">
      <button id="reset-filters-btn" class="btn-sm btn-outline-secondary mb-2">
        <i class="bi bi-x-circle me-1"></i> Vymazat filtry
      </button>
      <button id="center-map-btn" class="btn-sm btn-outline-secondary mb-2">
        <i class="bi bi-map me-1"></i> Vycentrovat mapu
      </button>
    </div>
  </div>
</div>

<p id="user-status" class="text-center fw-bold mb-3"></p>
<span id="logged-info" class="fw-bold small"></span>
</div>
<div id="sekce-mapa" class="mt-4" style="height: 100vh;">
  <div id="map" style="height: 100%; width: 100%; opacity: 1; transform: translateY(0);"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function () {
    const map = L.map('map').setView([49.8, 15.5], 7);
    const fakeNames = [
        "Rychl√Ω Sysel", "L√©taj√≠c√≠ Brambor", "Dronislav Nebe≈°≈•√°k", "Turbo R√°kosn√≠k", "Bezpilotn√≠ Emil", "P√≠skaj√≠c√≠ P√°v", "Pilotka Haluz", "Franti≈°ek Vrtuln√≠k", "Lev√Ω Joystick", "Kapit√°n St√≠n", "Dr. Rotor", "Pan Toƒçiv√Ω", "Letu≈°ka Landov√°", "St≈ôemhlav√Ω Franta", "Nadzvukov√Ω Je≈æek", "L√©taj√≠c√≠ ƒåenda", "Rotorov√° R√≥za", "≈†um√≠c√≠ Fanda", "Bezpeƒçn√Ω B√©ƒèa", "Maj√°k z Oblak", "Dron√Ω Karel", "Letec ≈†matla", "Start√©r Stan√≠k", "P≈ôist√°vac√≠ Pepa", "Helikopt√©rn√≠k Honza", "Navig√°tor Nov√°k", "Senzorov√° So≈àa", "P√°n Mrak≈Ø", "Let√≠c√≠ Lojza", "Kamera Kamil", "Rotor R√≠≈°a", "V√Ω≈°komƒõr Va≈°ek", "Vzdu≈°n√Ω Vojta", "Tich√Ω ≈†um√°k", "Drnƒçiv√Ω Dan", "Mlha Milda", "Optika Otakar", "Ztracen√Ω Sign√°l", "Mistr Gimbal", "Ant√©na Aniƒçka", "Vrtulka Vƒõrka", "Letmo L√≠da", "Flyboy Felix", "Vzdu≈°n√° V√≠la", "Navigaƒçn√≠ Norbert", "Modr√° Letka", "K≈ô√≠dlat√Ω Karel", "Poln√≠ P≈ô√≠zrak", "Mapov√Ω Mirek", "Kliƒçkuj√≠c√≠ Kuba"
    ];

    function normalizeConsent(v) {
        if (typeof v === 'boolean') return v;
        const s = String(v ?? '').trim().toLowerCase();
        return s === 'true' || s === 't' || s === '1' || s === 'ano' || s === 'yes';
    }

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 18
    }).addTo(map);

    let allPilots = [];
    const markers = L.markerClusterGroup();
    let pilotCircles = [];
    let loggedInzerentId = null;

    const filterSpecialization = document.getElementById('filter-specialization');
    const filterRegion = document.getElementById('filter-region');
    const filterAvailability = document.getElementById('filter-availability');
    const filterVolunteer = document.getElementById('filter-volunteer');
    const filterVerified = document.getElementById('filter-verified');
    const resetFiltersBtn = document.getElementById('reset-filters-btn');
    const centerMapBtn = document.getElementById('center-map-btn');

    async function getAdvertiserIdAndLoadMap() {
        const advertiserEmail = localStorage.getItem("inzerentEmail");
        if (advertiserEmail) {
            try {
                const response = await fetch('/get-my-advertiser', { credentials: 'include' });
                if (response.ok) {
                    const inzerentData = await response.json();
                    loggedInzerentId = inzerentData.id;
                    localStorage.setItem('advertiserId', loggedInzerentId);
                    loadCredit(advertiserEmail);
                } else {
                    console.warn("Inzerent nen√≠ p≈ôihl√°≈°en. Mo≈æn√° vypr≈°ela session.");
                    localStorage.removeItem("inzerentEmail");
                    localStorage.removeItem("advertiserId");
                    window.location.href = '/index.html';
                    return;
                }
            } catch (e) {
                console.error("Chyba p≈ôi ovƒõ≈ôov√°n√≠ p≈ôihl√°≈°en√©ho inzerenta:", e);
                localStorage.removeItem("inzerentEmail");
                localStorage.removeItem("advertiserId");
                window.location.href = '/index.html';
                return;
            }
        }
        await loadPilots();
    }

    async function loadPilots() {
        try {
            const res = await fetch('/pilots');
            allPilots = await res.json();
            populateSpecializations();
            applyFilters();
        } catch (error) {
            console.error("Chyba p≈ôi naƒç√≠t√°n√≠ pilot≈Ø:", error);
            alert('Nepoda≈ôilo se naƒç√≠st data pilot≈Ø.');
        }
    }

    function populateSpecializations() {
  const select = document.getElementById('filter-specialization');
  if (!select) return;

  const specsSet = new Set();
  allPilots.forEach(p => {
    if (Array.isArray(p.specializations)) {
      p.specializations.forEach(s => s && specsSet.add(s.trim()));
    } else if (typeof p.specialization === 'string' && p.specialization.trim() !== '') {
      p.specialization.split(',').forEach(s => specsSet.add(s.trim()));
    }
  });

  const specs = Array.from(specsSet).sort((a, b) => a.localeCompare(b, 'cs'));
  select.innerHTML = '<option value="">V≈°echny specializace</option>';
  specs.forEach(spec => {
    const opt = document.createElement('option');
    opt.value = spec;
    opt.textContent = spec;
    select.appendChild(opt);
  });
}


    function applyFilters() {
  const selectedSpec = filterSpecialization.value;
  const selectedRegion = filterRegion.value;
  const selectedAvailability = filterAvailability.value;
  const selectedVolunteer = filterVolunteer.value;
  const selectedVerified = filterVerified.value;

  const filteredPilots = allPilots.filter(p => {
    // ‚úÖ logika specializac√≠
    let pilotSpecs = [];
    if (Array.isArray(p.specializations)) {
      pilotSpecs = p.specializations.map(s => s.trim());
    } else if (typeof p.specialization === 'string') {
      pilotSpecs = p.specialization.split(',').map(s => s.trim());
    }

    const matchesSpec = !selectedSpec || pilotSpecs.includes(selectedSpec);

    const matchesRegion = !selectedRegion || p.region === selectedRegion;
    const matchesAvailability = !selectedAvailability || p.available === selectedAvailability;
    const matchesVolunteer = !selectedVolunteer || p.volunteer === selectedVolunteer;
    const isVerified = p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16;
    const matchesVerified = !selectedVerified ||
      (selectedVerified === 'YES' && isVerified) ||
      (selectedVerified === 'NO' && !isVerified);

    return matchesSpec && matchesRegion && matchesAvailability && matchesVolunteer && matchesVerified;
  });

  drawPilots(filteredPilots);
}


    function drawPilots(pilots) {
        markers.clearLayers();
        pilotCircles = [];

        pilots.forEach(p => {
            if (p.visible !== "ANO" || !p.latitude || !p.longitude) return;

            let circleOptions = {
                radius: 2000,
                fillOpacity: 0.2,
                color: p.available === "ANO" ? 'green' : 'gray',
                fillColor: p.available === "ANO" ? '#4CAF50' : '#CCCCCC',
                weight: 1
            };

            if (p.type_account === "Free") {
                circleOptions.color = 'lightgreen';
                circleOptions.fillOpacity = 0.2;
            } else if (p.type_account === "Basic") {
                circleOptions.color = 'darkgreen';
                circleOptions.fillOpacity = 0.5;
            } else if (p.type_account === "Premium") {
                circleOptions.color = 'purple';
                circleOptions.fillColor = 'purple';
                circleOptions.fillOpacity = 0.8;
                circleOptions.radius = 10000;
                circleOptions.weight = 3;
            }

            const circle = L.circle([p.latitude, p.longitude], circleOptions);
            const popupContent = createPopupContent(p);
            
            circle.bindPopup(popupContent);
            markers.addLayer(circle);
            pilotCircles.push(circle);
        });

        map.addLayer(markers);
        if (markers.getBounds().isValid()) {
            map.fitBounds(markers.getBounds(), { padding: [30, 30] });
        } else {
            map.setView([49.8, 15.5], 7); // Default view if no pilots are found
        }
    }

   function createPopupContent(p) {
  const popupContent = document.createElement('div');
  popupContent.className = 'pilot-card';

  const loggedIn = localStorage.getItem("inzerentEmail");
  const isAvailable = p.available === "ANO";
  const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)];
  const hasBuildBadge = p.id && Number(p.id) <= 80;
  const buildBadge = hasBuildBadge
    ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
    : "";
  const pilotNameWithBadge = `${p.name || 'Pilot bez jm√©na'}${buildBadge}`;
  const fakeNameWithBadge = `${fakeName}${buildBadge}`;
  const hasPublicConsent = normalizeConsent(p.hasPublicConsent ?? p.granted ?? false);
  const isVerified =
    p.registrationnumber &&
    p.registrationnumber.startsWith("CZE") &&
    p.registrationnumber.length === 16;

  let html = '';

  // --- GDPR nesouhlas ---
  if (!hasPublicConsent) {
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
      </div>
      <div class="d-flex flex-wrap gap-2 mb-2">
        ${p.volunteer === 'ANO' ? `<span class="badge-volunteer">Dobrovoln√≠k</span>` : ''}
        <span class="badge-gdpr">Bez GDPR souhlasu ‚Äì kontakt p≈ôes administr√°tora</span>
      </div>
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    `;
  }

  // --- Nedostupn√Ω pilot ---
  else if (!isAvailable) {
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
        ${isVerified ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
      <p class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Tento pilot moment√°lnƒõ nen√≠ k dispozici</p>
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    `;
  }

  // --- P≈ôihl√°≈°en√Ω inzerent (hlavn√≠ logika) ---
  else if (loggedIn) {
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
        ${isVerified ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
    `;

    // === BASIC √∫ƒçet ===
    if (p.type_account === "Basic") {
      if (p.drones) html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.note) html += `<p><i class="bi bi-chat-left-text me-1"></i><strong>O mnƒõ:</strong> ${p.note}</p>`;
      if (p.travel) html += `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>`;
      if (p.licenses) html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
      if (p.specialization) html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;

      html += `
        <div class="mt-3">
          <button class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" onclick="contactPilot('${p.id}')">
            ‚úâÔ∏è Napsat pilotovi
          </button>
        </div>
      `;
    }

    // === PREMIUM √∫ƒçet ===
    else if (p.type_account === "Premium") {
      html += `
        ${p.email ? `<p><i class="bi bi-envelope-at me-1"></i><a href="mailto:${p.email}">${p.email}</a></p>` : ''}
        ${p.phone ? `<p><i class="bi bi-telephone-fill me-1"></i><a href="tel:${p.phone}">${p.phone}</a></p>` : ''}
        ${p.drones ? `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>` : ''}
        ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
        ${p.note ? `<p><i class="bi bi-chat-left-text me-1"></i><strong>O mnƒõ:</strong> ${p.note}</p>` : ''}
        ${p.travel ? `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>` : ''}
        ${p.licenses ? `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>` : ''}
      `;
    }

// === FREE √∫ƒçet ‚Äì jen struƒçn√© info + DECENTN√ç TLAƒå√çTKO SPONZORSTV√ç ===
else {
  html += `
    ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    ${p.drones ? `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>` : ''}
    
    <p class="text-muted small mt-3 mb-2">
    Pilot m√° Free √∫ƒçet, komunikace je nedostupn√°. 
    <br>
    Odpovƒõƒè nen√≠ garantov√°na.
</p>
<button class="btn btn-sm btn-outline-success w-100" 
        style="font-size: 13px;
               padding: 4px 8px;
               border-color: #28a745; 
               color: #28a745;" 
        onmouseover="this.style.backgroundColor='#e6ffe9'" 
        onmouseout="this.style.backgroundColor='transparent'"
        onclick="sponsorPilotUpgrade('${p.id}', '${p.name.replace(/'/g, "\\'")}', 3, 40.00)">
    üéÅ Darovat 3 dny Basic √∫ƒçtu pro kontakt
</button>
  `;
}
  }

  // --- Nep≈ôihl√°≈°en√Ω inzerent ---
  else {
    html = `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
        ${isVerified ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
      <p><i class="bi bi-envelope-at me-1"></i><span class="text-muted">[e-mail po p≈ôihl√°≈°en√≠]</span></p>
      ${p.phone ? `<p><i class="bi bi-telephone-fill me-1"></i><span class="text-muted">[telefon skryt]</span></p>` : ''}
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
      ${p.travel ? `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>` : ''}
      <p class="text-muted"><em>P≈ôihlaste se jako inzerent pro v√≠ce informac√≠ o pilotovi.</em></p>
    `;
  }

  popupContent.innerHTML = html;
  return popupContent;
}


    // Event Listeners for all filters
    document.querySelectorAll('.filter-section select').forEach(select => {
        select.addEventListener('change', applyFilters);
    });

    resetFiltersBtn.addEventListener('click', () => {
        document.querySelectorAll('.filter-section select').forEach(select => select.value = '');
        applyFilters();
    });

    centerMapBtn.addEventListener('click', () => {
  // ‚úÖ Nejprve vycentruj mapu podle pilot≈Ø
  if (markers.getBounds().isValid()) {
    map.fitBounds(markers.getBounds(), { padding: [30, 30] });
  } else {
    map.setView([49.8, 15.5], 7);
  }


  // ‚úÖ Potom plynule "nascrolluj" dol≈Ø na mapu
  const mapSection = document.getElementById('sekce-mapa');
  if (mapSection) {
    mapSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
});

// === ≈†IPKA NAHORU ===
const scrollUpBtn = document.getElementById('scroll-up-btn');

window.addEventListener('scroll', () => {
  const mapSection = document.getElementById('sekce-mapa');
  if (!mapSection) return;

  const rect = mapSection.getBoundingClientRect();
  const isMapVisible = rect.top < window.innerHeight * 0.8 && rect.bottom > 100;

  if (isMapVisible) {
    scrollUpBtn.classList.add('show');
  } else {
    scrollUpBtn.classList.remove('show');
  }
});

scrollUpBtn.addEventListener('click', () => {
  // Plynul√Ω n√°vrat nahoru (nad mapu)
  window.scrollTo({ top: 0, behavior: 'smooth' });
});



    map.on('zoomend', () => {
        const zoom = map.getZoom();
        const maxZoom = 14;
        const minZoom = 7;
        
        pilotCircles.forEach(circle => {
            let accountMinRadius = 100;
            let accountMaxRadius = 2000;

            if (circle.options.fillColor === 'darkgreen') {
                accountMaxRadius = 4000;
            } else if (circle.options.fillColor === 'purple') {
                accountMaxRadius = 10000;
            }

            const ratio = Math.min(1, Math.max(0, (zoom - minZoom) / (maxZoom - minZoom)));
            const radius = accountMaxRadius - (accountMaxRadius - accountMinRadius) * ratio;
            circle.setRadius(radius);
            
            const opacity = 0.2 + 0.2 * (1 - ratio);
            circle.setStyle({ fillOpacity: opacity });
        });
    });

    getAdvertiserIdAndLoadMap();

    // Inzerent login a banner
    const advertiserEmail = localStorage.getItem("inzerentEmail");
    const advertiserId = localStorage.getItem("advertiserId"); // Corrected to use 'advertiserId'
    const banner = document.getElementById("advertiser-banner");

    if (advertiserEmail && advertiserId && banner) {
        document.getElementById("advertiser-text").innerHTML = `P≈ôihl√°≈°en jako: <strong>${advertiserEmail}</strong>`;
        banner.style.display = "flex";
        const logoutBtn = document.getElementById("logout-btn");
        logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("inzerentId");
            localStorage.removeItem("inzerentEmail");
            localStorage.removeItem("advertiserId"); // Clear advertiserId too
            window.location.href = "/index.html";
        });
    } else {
        console.log("‚ùå Inzerent nen√≠ p≈ôihl√°≈°en nebo chyb√≠ ID");
        if(banner) banner.style.display = "none";
    }
});

async function contactPilot(pilotId) {
  const advertiserId = localStorage.getItem('advertiserId');
  const advertiserEmail = localStorage.getItem('inzerentEmail');

  if (!advertiserEmail || !advertiserId) {
    alert("Mus√≠te b√Ωt p≈ôihl√°≈°en jako inzerent.");
    return;
  }

  try {
    const createConvRes = await fetch('/api/v2/create-conversation', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pilotId: pilotId,
        advertiserId: advertiserId,
        advertiserTable: 'advertisers'
      }),
      credentials: 'include'
    });

    const createConvData = await createConvRes.json();

    if (createConvData.success && createConvData.conversationId) {
      const chatUrl = `chat.html?conversationId=${createConvData.conversationId}&pilotId=${pilotId}&advertiserId=${advertiserId}`;
      window.location.href = chatUrl;
    } else {
      alert('Nepoda≈ôilo se vytvo≈ôit konverzaci: ' + (createConvData.message || 'Nezn√°m√° chyba.'));
    }
  } catch (error) {
    console.error("Chyba p≈ôi vytv√°≈ôen√≠ konverzace:", error);
    alert('Do≈°lo k chybƒõ p≈ôi vytv√°≈ôen√≠ konverzace.');
  }
}


/**
 * Spust√≠ proces sponzorstv√≠. P≈ôij√≠m√° dynamick√© dny a ƒç√°stku.
 */
async function sponsorPilotUpgrade(pilotId, pilotName, days, amount) {
  const advertiserId = localStorage.getItem('advertiserId');
  const advertiserEmail = localStorage.getItem('inzerentEmail');

  if (!advertiserEmail || !advertiserId) {
    alert("Mus√≠te b√Ωt p≈ôihl√°≈°en jako inzerent.");
    return;
  }

  const confirmation = confirm(`
    Opravdu chcete darovat pilotovi "${pilotName}" ${days} dn√≠ Basic √∫ƒçtu?
    
    Cena: ${amount.toFixed(2)} Kƒç bude odeƒçtena z Va≈°eho kreditu.
    POZOR: Odpovƒõƒè pilota nen√≠ garantov√°na.
  `);
  if (!confirmation) return;
  
  try {
    const upgradeRes = await fetch('/api/sponsor-upgrade', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        pilotId: pilotId,
        sponsorEmail: advertiserEmail,
        days: days, // P≈òED√ÅV√ÅME DYNAMICKY (nyn√≠ 3)
        type: 'Basic', 
        amount: amount // P≈òED√ÅV√ÅME DYNAMICKY (nyn√≠ 40.00)
      }),
      credentials: 'include'
    });

    const upgradeData = await upgradeRes.json();

    if (!upgradeData.success) {
      alert('‚ùå Transakce selhala: ' + (upgradeData.message || 'Nedostateƒçn√Ω kredit nebo nezn√°m√° chyba.'));
      return;
    }

    alert(`‚úÖ Transakce √∫spƒõ≈°n√°. Pilot ${pilotName} m√° nyn√≠ ${days} dn√≠ Basic √∫ƒçtu. Budete p≈ôesmƒõrov√°n do chatu.`);

    // Znovu naƒç√≠st a zobrazit nov√Ω kredit
    loadCredit(advertiserEmail);
    
    // Vytvo≈ôit konverzaci
    contactPilot(pilotId); 
    
  } catch (error) {
    console.error("Chyba p≈ôi sponzorov√°n√≠ pilota:", error);
    alert('Do≈°lo k chybƒõ p≈ôi komunikaci se serverem.');
  }
}

async function loadCredit(advertiserEmail) {
    try {
        const res = await fetch(`/api/advertiser-credit?email=${advertiserEmail}`);
        const data = await res.json();
        const creditDisplay = document.getElementById('credit-display');

        if (res.ok) {
            creditDisplay.textContent = `Kredit: ${data.credit} Kƒç`;
        } else {
            creditDisplay.textContent = `Kredit: Chyba`;
        }
    } catch (e) {
        console.error('Nelze naƒç√≠st kredit:', e);
    }
}

</script>
<footer class="footer mt-5 pt-4 pb-4 bg-light border-top">
  <div class="container">
    <div class="row gy-3 justify-content-between">
      <div class="col-md-4">
        <a href="/" class="d-flex align-items-center mb-2 text-decoration-none text-dark">
          <img src="/icons/logo.png" alt="Logo NajdiPilota" height="40" class="me-2" />
          <span class="fw-bold fs-5">NajdiPilota.cz</span>
        </a>
        <p class="small text-muted">Spojujeme z√°kazn√≠ky s ovƒõ≈ôen√Ωmi piloty dron≈Ø po cel√© ƒåR. Rychl√© spojen√≠ bez prost≈ôedn√≠k≈Ø.</p>
      </div>
      <div display="no" class="col-md-2">
        <h6 class="fw-bold">Navigace</h6>
        <ul class="list-unstyled">
          <li><a href="/index.html?inzerent=1" class="text-decoration-none text-muted">Mapa pilot≈Ø</a></li>
          <li><a href="/o-projektu.html?inzerent=1" class="text-decoration-none text-muted">O projektu</a></li>
          <li><a href="/kontakt.html?inzerent=1" class="text-decoration-none text-muted">Kontakt</a></li>
          <li><a href="/v-procesu.html" class="text-decoration-none text-muted">Blog</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <h6 class="fw-bold">Informace</h6>
        <ul class="list-unstyled">
          <li><a href="/gdpr.html" class="text-decoration-none text-muted">Zpracov√°n√≠ osobn√≠ch √∫daj≈Ø</a></li>
          <li><a href="mailto:dronadmin@seznam.cz?subject=Chyba na webu" class="text-decoration-none text-muted">Nahl√°sit chybu</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <h6 class="fw-bold">Provozovatel</h6>
        <p class="small text-muted mb-1">Ing. Bohuslav Vladyka<br>IƒåO: 08578591<br>Praha, ƒåesk√° republika</p>
        <p class="small text-muted mb-0">üìß <a href="mailto:dronadmin@seznam.cz" class="text-muted">dronadmin@seznam.cz</a></p>
      </div>
    </div>
    <hr class="my-4">
    <div class="d-flex justify-content-between align-items-center small text-muted">
      <span>&copy; <span id="year"></span> NajdiPilota.cz</span>
      <div>
        <a href="/v-procesu.html" class="text-muted me-3"><i class="bi bi-facebook"></i></a>
        <a href="https://www.instagram.com/najdipilota/" class="text-muted me-3"><i class="bi bi-instagram"></i></a>
        <a href="/v-procesu.html" class="text-muted"><i class="bi bi-linkedin"></i></a>
      </div>
    </div>
  </div>
</footer>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("year").textContent = new Date().getFullYear();
  });
</script>

<button id="scroll-up-btn" title="Zpƒõt nahoru">
  <i class="bi bi-arrow-up"></i>
</button>

</body>
</html>




