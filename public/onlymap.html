<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Dronov√° mapa pilot≈Ø v ƒåesku ‚Äì Najdi nebo se p≈ôidej</title>

    <meta name="description" content="Hled√°≈° pilota dronu nebo chce≈° b√Ωt vidƒõt? Dronov√° mapa spojuje piloty a z√°kazn√≠ky. Rychl√© spojen√≠, ovƒõ≈ôen√≠ u≈æivatel√© a mo≈ænost p≈ôiv√Ωdƒõlku." />
  <meta name="robots" content="index, follow" />
<link rel="canonical" href="https://www.najdipilota.cz/" />

  <!-- Open Graph pro Facebook a dal≈°√≠ s√≠tƒõ -->
  <meta property="og:title" content="Dronov√° mapa pilot≈Ø v ƒåesku" />
  <meta property="og:description" content="Spojujeme z√°kazn√≠ky s piloty dron≈Ø. Zobraz se na mapƒõ nebo si najdi pilota ve sv√©m okol√≠." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.najdipilota.cz/" />
  <meta property="og:image" content="https://www.najdipilota.cz/og-image.jpg" />
  <!-- Nahraƒè re√°lnou URL obr√°zku -->
  <meta name="google-site-verification" content="yxzi02d6ahPBVtx31lx_Mwg07khOFlY_fWUFdkyrsUE" />

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Vlastn√≠ styl -->
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet a MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- Favicony -->
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="manifest" href="/icons/site.webmanifest">
<link rel="icon" href="/icons/favicon.ico" type="image/x-icon">
<style>

html {
  scroll-behavior: smooth;
}

.navbar .btn + .btn { margin-left: .5rem; } /* mal√Ω odstup mezi sousedn√≠mi btn */
</style>


</head>
<body>


<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center">
  <img src="/icons/logo.png" alt="" height="60" class="me-2" loading="lazy" aria-hidden="true" />
  <span class="fs-4">NajdiPilota.cz | Sekce pro inzerenty</span>

  <div class="ms-auto d-none d-md-flex">
      <a href="onlymap.html" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-map me-1"></i>Mapa
      </a>
      <a href="moje-zpravy-inzerent.html" class="btn btn-outline-secondary btn-sm ms-2">
        <i class="bi bi-envelope me-1"></i>Moje zpr√°vy
      </a>
      <a href="poptavky.html" class="btn btn-outline-secondary btn-sm ms-2">
        <i class="bi bi-clipboard-plus me-1"></i>Popt√°vky
      </a>
</div>

</nav>


<div id="advertiser-banner" class="alert alert-warning text-center m-3 d-flex justify-content-center align-items-center" style="display: none;">
  <div id="advertiser-text" class="me-3 fw-semibold"></div>
  <button id="logout-btn" class="btn btn-warning w-100">Odhl√°sit se</button>
</div>


	<div id="filter-section" class="filter-section bg-light p-3 rounded-3 mb-4 shadow-sm">
  <div class="row g-3">
    <!-- Specializace -->
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-puzzle-fill me-2"></i>Specializace
        </h6>
        <select id="filter-specialization" class="form-select form-select-sm">
          <option value="">V≈°echny specializace</option>
        </select>
      </div>
    </div>

  <!-- Kraj -->
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-geo-alt-fill me-2"></i>Kraj
        </h6>
        <select id="filter-region" class="form-select form-select-sm">
          <option value="">V≈°echny kraje</option>
      <option value="Hlavn√≠ mƒõsto Praha">Hlavn√≠ mƒõsto Praha</option>
      <option value="St≈ôedoƒçesk√Ω kraj">St≈ôedoƒçesk√Ω kraj</option>
      <option value="Jihoƒçesk√Ω kraj">Jihoƒçesk√Ω kraj</option>
      <option value="Plze≈àsk√Ω kraj">Plze≈àsk√Ω kraj</option>
      <option value="Karlovarsk√Ω kraj">Karlovarsk√Ω kraj</option>
      <option value="√östeck√Ω kraj">√östeck√Ω kraj</option>
      <option value="Libereck√Ω kraj">Libereck√Ω kraj</option>
      <option value="Kr√°lov√©hradeck√Ω kraj">Kr√°lov√©hradeck√Ω kraj</option>
      <option value="Pardubick√Ω kraj">Pardubick√Ω kraj</option>
      <option value="Vysoƒçina">Vysoƒçina</option>
      <option value="Jihomoravsk√Ω kraj">Jihomoravsk√Ω kraj</option>
      <option value="Olomouck√Ω kraj">Olomouck√Ω kraj</option>
      <option value="Zl√≠nsk√Ω kraj">Zl√≠nsk√Ω kraj</option>
      <option value="Moravskoslezsk√Ω kraj">Moravskoslezsk√Ω kraj</option>
      </select>
      </div>
    </div>

<!-- Dostupnost -->
    <div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-check-circle-fill me-2"></i>Dostupnost
        </h6>
        <select id="filter-availability" class="form-select form-select-sm">
          <option value="">V≈°ichni piloti</option>
          <option value="ANO">Dostupn√≠ piloti</option>
          <option value="NE">Nedostupn√≠ piloti</option>
        </select>
      </div>
    </div>

<div class="col-md-4">
      <div class="filter-card h-100 p-3 bg-white rounded-3">
        <h6 class="filter-title fw-bold mb-3 text-primary">
          <i class="bi bi-heart-fill me-2"></i>Dobrovoln√≠ci
        </h6>
        <select id="filter-volunteer" class="form-select form-select-sm">
          <option value="">V≈°ichni piloti</option>
          <option value="ANO">Pouze dobrovoln√≠ci</option>
          <option value="NE">Pouze profesion√°lov√©</option>
        </select>
      </div>
    </div>

<!-- Ovƒõ≈ôen√Ω pilot (registrationnumber) -->
<div class="col-md-4">
  <div class="filter-card h-100 p-3 bg-white rounded-3">
    <h6 class="filter-title fw-bold mb-3 text-primary">
      <i class="bi bi-patch-check-fill me-2"></i>Ovƒõ≈ôen√Ω pilot
    </h6>
    <select id="filter-verified" class="form-select form-select-sm">
      <option value="">V≈°ichni</option>
      <option value="YES">Pouze ovƒõ≈ôen√≠</option>
      <option value="NO">Pouze neovƒõ≈ôen√≠</option>
    </select>
  </div>
</div>


<!-- Akƒçn√≠ tlaƒç√≠tka -->
    <div class="col-md-6 d-flex flex-column justify-content-end">
          <button id="reset-filters-btn" class="btn-sm btn-outline-secondary mb-2">
  <i class="bi bi-x-circle me-1"></i> Vymazat filtry
</button>
           <button id="center-map-btn" class="btn-sm btn-outline-secondary mb-2">
    <i class="bi bi-map me-1"></i> Vycentrovat mapu
  </button>
        </div>
      </div>
    </div>
  </div>
</div>


    
    <p id="user-status" class="text-center fw-bold mb-3"></p>

  <span id="logged-info" class="fw-bold small"></span>
 
</div>



    

    

    <div id="sekce-mapa" class="mt-4" style="height: 100vh;">
  <div id="map" style="height: 100%; width: 100%;"></div>
</div>


  </div>

  <!-- Leaflet & Cluster -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>



  <!-- Skript -->
 <script>
  const map = L.map('map').setView([49.8, 15.5], 7);
  const fakeNames = [
    "Rychl√Ω Sysel", "L√©taj√≠c√≠ Brambor", "Dronislav Nebe≈°≈•√°k", "Turbo R√°kosn√≠k", "Bezpilotn√≠ Emil", "P√≠skaj√≠c√≠ P√°v", "Pilotka Haluz", "Franti≈°ek Vrtuln√≠k", "Lev√Ω Joystick", "Kapit√°n St√≠n", "Dr. Rotor", "Pan Toƒçiv√Ω", "Letu≈°ka Landov√°", "St≈ôemhlav√Ω Franta", "Nadzvukov√Ω Je≈æek", "L√©taj√≠c√≠ ƒåenda", "Rotorov√° R√≥za", "≈†um√≠c√≠ Fanda", "Bezpeƒçn√Ω B√©ƒèa", "Maj√°k z Oblak", "Dron√Ω Karel", "Letec ≈†matla", "Start√©r Stan√≠k", "P≈ôist√°vac√≠ Pepa", "Helikopt√©rn√≠k Honza", "Navig√°tor Nov√°k", "Senzorov√° So≈àa", "P√°n Mrak≈Ø", "Let√≠c√≠ Lojza", "Kamera Kamil", "Rotor R√≠≈°a", "V√Ω≈°komƒõr Va≈°ek", "Vzdu≈°n√Ω Vojta", "Tich√Ω ≈†um√°k", "Drnƒçiv√Ω Dan", "Mlha Milda", "Optika Otakar", "Ztracen√Ω Sign√°l", "Mistr Gimbal", "Ant√©na Aniƒçka", "Vrtulka Vƒõrka", "Letmo L√≠da", "Flyboy Felix", "Vzdu≈°n√° V√≠la", "Navigaƒçn√≠ Norbert", "Modr√° Letka", "K≈ô√≠dlat√Ω Karel", "Poln√≠ P≈ô√≠zrak", "Mapov√Ω Mirek", "Kliƒçkuj√≠c√≠ Kuba"
  ];

function normalizeConsent(v) {
    if (typeof v === 'boolean') return v;
    const s = String(v ?? '').trim().toLowerCase();
    return s === 'true' || s === 't' || s === '1' || s === 'ano' || s === 'yes';
  }

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap',
    maxZoom: 18
  }).addTo(map);
  let allPilots = [];
  const markers = L.markerClusterGroup();
    const pilotCircles = [];
    fetch('/pilots')
      .then(res => res.json())
      .then(data => {
        data.forEach(p => {
  if (p.visible !== "ANO") return; // Skryj neviditeln√© piloty

  if (p.latitude != null && p.longitude != null) {

            let circleOptions = {
      radius: 2000, // V√Ωchoz√≠ r√°dius
      fillOpacity: 0.2, // V√Ωchoz√≠ opacity pro Free
      color: p.available === "ANO" ? 'green' : 'gray',
      fillColor: p.available === "ANO" ? '#4CAF50' : '#CCCCCC',
      weight: 1
    };

 // Zmƒõna pro r≈Øzn√© typy √∫ƒçt≈Ø
    if (p.type_account === "Free") {
      circleOptions.color = 'lightgreen';
      circleOptions.fillOpacity = 0.2;
    } else if (p.type_account === "Basic") {
      circleOptions.color = 'darkgreen';
      circleOptions.fillOpacity = 0.5;
    } else if (p.type_account === "Premium") {
  circleOptions.color = 'purple';         // Barva obrysu
  circleOptions.fillColor = 'purple';     // Barva v√Ωplnƒõ
  circleOptions.fillOpacity = 0.8;        // Opacity v√Ωplnƒõ
  circleOptions.radius = 10000;           // Dvojn√°sobnƒõ vƒõt≈°√≠ r√°dius ne≈æ Free a Basic
  circleOptions.weight = 3;               // Tlou≈°≈•ka linie (nastavena na 3)
}

            const circle = L.circle([p.latitude, p.longitude], circleOptions)

        .bindPopup(() => {
  const loggedIn = localStorage.getItem("loggedEmail") || localStorage.getItem("inzerentEmail");
  const isAvailable = p.available === "ANO";
  const fakeName = fakeNames[Math.floor(Math.random() * fakeNames.length)];

  // stejn√© odznaky jako na indexu
  const hasBuildBadge = p.id && Number(p.id) <= 80;
  const buildBadge = hasBuildBadge 
    ? `<img src="/icons/build50_v1.png" alt="Build 50" width="64" height="64" class="ms-2 align-middle" title="Build 50">`
    : "";

  const pilotNameWithBadge = `${p.name || ''}${buildBadge}`;
  const fakeNameWithBadge  = `${fakeName}${buildBadge}`;

  // stejn√© vyhodnocen√≠ GDPR souhlasu
  const hasPublicConsent = normalizeConsent(p.hasPublicConsent ?? p.granted ?? false);

  let html = `<div class="pilot-card">`;

  // Pokud pilot nem√° souhlas, nikdy nezobraz√≠me re√°ln√© kontakty/jm√©no ‚Äì pou≈æijeme ‚Äûfake‚Äú kartu
  if (!hasPublicConsent) {
    return `
      <div class="pilot-card">
        <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
        <div class="d-flex flex-wrap gap-2 mb-2">
          ${p.volunteer === 'ANO' ? `<span class="badge-volunteer">Dobrovoln√≠k</span>` : ''}
          <span class="badge-gdpr">Bez GDPR souhlasu ‚Äì kontakt p≈ôes administr√°tora</span>
        </div>
        ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
      </div>
    `;
  }

  // M√° souhlas ‚Üí pokraƒçujeme jako na indexu
  if (isAvailable && loggedIn) {
    if (p.type_account === "Free") {
      html += `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
          ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
            ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` 
            : ''}
        </div>
      `;
      if (p.volunteer === 'ANO') html += `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>`;
      if (p.drones)        html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.specialization)html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
      html += `</div>`;
    } else if (p.type_account === "Basic") {
      html += `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
          ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
            ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` 
            : ''}
        </div>
      `;
      if (p.volunteer === 'ANO') html += `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>`;
      if (p.drones)        html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.note)          html += `<p><i class="bi bi-chat-left-text me-1"></i><strong>O mnƒõ:</strong> ${p.note}</p>`;
      if (p.travel)        html += `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>`;
      if (p.licenses)      html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
      if (p.specialization)html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
      html += `
        <div class="mt-3">
          <button class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2 w-100" onclick="contactPilot('${p.email}')">
            ‚úâÔ∏è Napsat pilotovi
          </button>
        </div>
      `;
    } else if (p.type_account === "Premium") {
      html += `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
          ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
            ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` 
            : ''}
        </div>
      `;
      if (p.volunteer === 'ANO') html += `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>`;
      if (p.email)         html += `<p><i class="bi bi-envelope-at me-1"></i><a href="mailto:${p.email}">${p.email}</a></p>`;
      if (p.phone)         html += `<p><i class="bi bi-telephone-fill me-1"></i><a href="tel:${p.phone}">${p.phone}</a></p>`;
      if (p.drones)        html += `<p><i class="bi bi-drone me-1"></i><strong>Drony:</strong> ${p.drones}</p>`;
      if (p.specialization)html += `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>`;
      if (p.travel)        html += `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>`;
      if (p.licenses)      html += `<p><i class="bi bi-award me-1"></i><strong>Licence:</strong> ${p.licenses}</p>`;
    }
  } else if (!isAvailable) {
    html += `
      <h3><i class="bi bi-person-circle me-1"></i>${fakeNameWithBadge}</h3>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
      <p class="text-danger"><i class="bi bi-exclamation-triangle-fill me-1"></i>Tento pilot moment√°lnƒõ nen√≠ k dispozici</p>
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
    `;
  } else {
    // nep≈ôihl√°≈°en√Ω inzerent, ale souhlas existuje ‚Üí stejn√© chov√°n√≠ jako index (nezobraz√≠me kontakty)
    html += `
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h3 class="mb-0"><i class="bi bi-person-circle me-1"></i>${pilotNameWithBadge}</h3>
        ${p.registrationnumber && p.registrationnumber.startsWith("CZE") && p.registrationnumber.length === 16 
          ? `<img src="/icons/approved_4.png" alt="Ovƒõ≈ôen√Ω provozovatel" width="60" class="me-2">` 
          : ''}
      </div>
      ${p.volunteer === 'ANO' ? `<div class="mb-2"><span class="badge-volunteer">Dobrovoln√≠k</span></div>` : ''}
      <p><i class="bi bi-envelope-at me-1"></i><span class="text-muted">[e-mail po p≈ôihl√°≈°en√≠]</span></p>
      ${p.phone ? `<p><i class="bi bi-telephone-fill me-1"></i><span class="text-muted">[telefon skryt]</span></p>` : ''}
      ${p.specialization ? `<p><i class="bi bi-puzzle-fill me-1"></i><strong>Specializace:</strong> ${p.specialization}</p>` : ''}
      ${p.travel ? `<p><i class="bi bi-signpost me-1"></i><strong>Doj√≠≈ædƒõn√≠:</strong> ${p.travel}</p>` : ''}
      <p class="text-muted"><em>P≈ôihlaste se jako inzerent pro v√≠ce informac√≠ o pilotovi.</em></p>
    `;
  }

  html += `</div>`;
  return html;
})


             markers.addLayer(circle);
            pilotCircles.push(circle);
          }
        });
        map.addLayer(markers);
        if (markers.getBounds().isValid()) {
          map.fitBounds(markers.getBounds(), { padding: [30, 30] });
        }
      });

    map.on('zoomend', () => {
  const zoom = map.getZoom();
  pilotCircles.forEach(circle => {
    const maxZoom = 14;
    const minZoom = 7;
    const minRadius = 100;
    const maxRadius = 2000;

    // Nastaven√≠ r√°diusu pro r≈Øzn√© typy √∫ƒçt≈Ø
    let accountMinRadius = minRadius;
    let accountMaxRadius = maxRadius;

    if (circle.options.fillColor === 'darkgreen') { // Basic √∫ƒçet (tmavƒõ zelen√Ω)
      accountMinRadius = 100;   // Min r√°dius pro Basic
      accountMaxRadius = 4000;  // Max r√°dius pro Basic
    } else if (circle.options.fillColor === 'purple') { // Premium √∫ƒçet (fialov√Ω)
      accountMinRadius = 100;  // Min r√°dius pro Premium
      accountMaxRadius = 10000; // Max r√°dius pro Premium
    }

    const ratio = (zoom - minZoom) / (maxZoom - minZoom);
    const radius = Math.max(accountMinRadius, accountMaxRadius - (accountMaxRadius - accountMinRadius) * ratio);
    circle.setRadius(radius);

    const opacity = 0.2 + 0.2 * (1 - ratio);
    circle.setStyle({ fillOpacity: opacity });
  });
});

function contactPilot(pilotEmail) {
  console.log('Pilot email:', pilotEmail);  // Debugging: Zkontrolujte, zda je e-mail spr√°vnƒõ p≈ôed√°n

  const advertiserEmail = localStorage.getItem('inzerentEmail');
  
  if (!advertiserEmail) {
    alert("Mus√≠te b√Ωt p≈ôihl√°≈°en jako inzerent.");
    return;
  }

  if (!pilotEmail) {
    alert("Chyba: Nelze naj√≠t kontaktn√≠ √∫daje pilota.");
    return;
  }

  // Send a request to check for an existing conversation or create a new one
  fetch('/create-conversation', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      pilotEmail,
      advertiserEmail
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      const chatUrl = `chat.html?conversationId=${data.conversationId}&pilotEmail=${encodeURIComponent(pilotEmail)}&inzerentEmail=${encodeURIComponent(advertiserEmail)}`;
      window.location.href = chatUrl;  // Redirect to chat page with the conversationId and emails
    } else {
      alert("Chyba p≈ôi vytv√°≈ôen√≠ konverzace.");
    }
  })
  .catch(error => {
    console.error('Chyba p≈ôi odes√≠l√°n√≠ po≈æadavku:', error);
    alert("Nastala chyba p≈ôi odes√≠l√°n√≠ po≈æadavku.");
  });
}


function isVerifiedPilot(pilot) {
  // nap≈ô. CZE123456789AB
  const regPattern = /^CZE[A-Za-z0-9]{13}$/;
  return regPattern.test(pilot.registrationnumber || '');
}



function extractUniqueSpecializations(pilots) {
  const specs = new Set();
  pilots.forEach(p => {
    if (p.specialization) {
      p.specialization.split(",").forEach(spec => specs.add(spec.trim()));
    }
  });
  return Array.from(specs).sort((a, b) => a.localeCompare(b));
}

function populateSpecializationFilter(pilots) {
  const select = document.getElementById("filter-specialization");
  if (!select) return;
  const uniqueSpecs = extractUniqueSpecializations(pilots);
  select.innerHTML = '<option value="">V≈°echny specializace</option>' + 
    uniqueSpecs.map(s => `<option value="${s}">${s}</option>`).join('');
}


  fetch('/pilots')
  .then(res => res.json())
  .then(data => {
    allPilots = data;
    populateSpecializationFilter(allPilots); // ‚¨ÖÔ∏è Tady se dopln√≠ filtr
    renderPilots(allPilots);
    applyFilters();
  });


  document.getElementById('filter-specialization').addEventListener('change', applyFilters);
document.getElementById('filter-region').addEventListener('change', applyFilters);
document.getElementById('filter-availability').addEventListener('change', applyFilters);
document.getElementById('filter-volunteer').addEventListener('change', applyFilters);
document.getElementById('filter-verified').addEventListener('change', applyFilters);

document.getElementById('reset-filters-btn').addEventListener('click', resetFilters);


document.getElementById('center-map-btn').addEventListener('click', function() {
  document.getElementById('sekce-mapa').scrollIntoView({ behavior: 'smooth' });
});

function resetFilters() {
  document.getElementById('filter-specialization').value = '';
  document.getElementById('filter-region').value = '';
  document.getElementById('filter-availability').value = '';
  document.getElementById('filter-volunteer').value = '';
  const fv = document.getElementById('filter-verified'); if (fv) fv.value = '';

  applyFilters();
}


// ‚öôÔ∏è jednor√°zov√© napojen√≠ dat pilota na existuj√≠c√≠ kruhy podle p≈ôesn√© shody lat|lon
let __pilotAttachmentDone = false;
function __ensurePilotAttached() {
  if (__pilotAttachmentDone) return;
  if (!Array.isArray(allPilots) || allPilots.length === 0) return;

  const byLatLon = new Map();
  allPilots.forEach(p => {
    if (p && p.latitude != null && p.longitude != null) {
      byLatLon.set(`${p.latitude}|${p.longitude}`, p);
    }
  });

  pilotCircles.forEach(c => {
    if (!c.__pilot && c.getLatLng) {
      const ll = c.getLatLng();
      const key = `${ll.lat}|${ll.lng}`;
      if (byLatLon.has(key)) c.__pilot = byLatLon.get(key);
    }
  });

  __pilotAttachmentDone = true;
}


function applyFilters() {
  __ensurePilotAttached(); // zajist√≠, ≈æe ka≈æd√Ω kruh m√° c.__pilot (pokud to jde)

  const selectedSpec = (document.getElementById('filter-specialization')?.value || '').toLowerCase();
  const selectedRegion = (document.getElementById('filter-region')?.value || '').toLowerCase();
  const selectedAvailability = document.getElementById('filter-availability')?.value || '';
  const selectedVolunteer = document.getElementById('filter-volunteer')?.value || '';
  const selectedVerified = document.getElementById('filter-verified')?.value || '';

  // rebuild cluster pouze z existuj√≠c√≠ch kruh≈Ø
  markers.clearLayers();

  pilotCircles.forEach(circle => {
    const p = circle.__pilot || {}; // pokud se nepoda≈ô√≠ napojit, nech√°me proj√≠t vƒõt≈°inu filtr≈Ø
    const spec = (p.specialization || '').toLowerCase();
    const region = (p.region || '').toLowerCase();
    const isVerified = isVerifiedPilot(p);


    const match =
      (!selectedSpec || spec.includes(selectedSpec)) &&
      (!selectedRegion || region.includes(selectedRegion)) &&
      (!selectedAvailability || p.available === selectedAvailability) &&
      (!selectedVolunteer || p.volunteer === selectedVolunteer) &&
      (!selectedVerified ||
        (selectedVerified === 'YES' && isVerified) ||
        (selectedVerified === 'NO' && !isVerified));

    if (match) {
      markers.addLayer(circle);
    }
  });

  if (markers.getLayers().length > 0 && markers.getBounds().isValid()) {
    map.fitBounds(markers.getBounds(), { padding: [30, 30] });
  }
}

fetch('/chat.html')
  .then(response => response.text())
  .then(data => {
    document.getElementById('chat-container').innerHTML = data;
  })
  .catch(error => console.error('Error loading chat.html:', error));

</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
  const advertiserEmail = localStorage.getItem("inzerentEmail");
  const advertiserId = localStorage.getItem("inzerentId"); // taky zkontrolujeme ID
  const banner = document.getElementById("advertiser-banner");

    if (advertiserEmail && advertiserId && banner) {
    document.getElementById("advertiser-text").innerHTML = `P≈ôihl√°≈°en jako: <strong>${advertiserEmail}</strong>`;
    banner.style.display = "flex";

    const logoutBtn = document.getElementById("logout-btn");
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("inzerentId");
      localStorage.removeItem("inzerentEmail");
      window.location.href = "/inzerent.html";
    });
  } else {
    console.log("‚ùå Inzerent nen√≠ p≈ôihl√°≈°en nebo chyb√≠ ID");
  }
});

// Vytvo≈ôen√≠ ovl√°dac√≠ho prvku pro tlaƒç√≠tko s ≈°ipkou
const centerMapButton = L.control({ position: 'topright' });

centerMapButton.onAdd = function (map) {
  const button = L.DomUtil.create('button', 'btn btn-sm');
  button.innerHTML = '<i class="bi bi-arrow-up-square-fill"></i>';  // ≈†ipka dol≈Ø (Bootstrap Icon)
  button.style.backgroundColor = 'transparent';  // Pr≈Øhledn√© pozad√≠
  button.style.border = 'none';  // Bez okraje
  button.style.fontSize = '36px';  // Velikost ikony
  button.style.cursor = 'pointer';  // Kurzoru na tlaƒç√≠tko

  button.onclick = function () {
    // Posune str√°nku na sekci filtr≈Ø
    const filterSection = document.getElementById('filter-section');
    if (filterSection) {
      filterSection.scrollIntoView({ behavior: 'smooth' });  // Plynul√Ω posun
    }
  };

  return button;
};

// P≈ôid√°n√≠ ovl√°dac√≠ho prvku do mapy
centerMapButton.addTo(map);

</script>

<footer class="footer mt-5 pt-4 pb-4 bg-light border-top">
  <div class="container">
    <div class="row gy-3 justify-content-between">
      
      <!-- Logo a popis -->
      <div class="col-md-4">
        <a href="/" class="d-flex align-items-center mb-2 text-decoration-none text-dark">
          <img src="/icons/logo.png" alt="Logo NajdiPilota" height="40" class="me-2" />
          <span class="fw-bold fs-5">NajdiPilota.cz</span>
        </a>
        <p class="small text-muted">Spojujeme z√°kazn√≠ky s ovƒõ≈ôen√Ωmi piloty dron≈Ø po cel√© ƒåR. Rychl√© spojen√≠ bez prost≈ôedn√≠k≈Ø.</p>
      </div>

      <!-- Navigace -->
      <div display="no" class="col-md-2">
        <h6 class="fw-bold">Navigace</h6>
        <ul class="list-unstyled">
          <li><a href="/index.html?inzerent=1" class="text-decoration-none text-muted">Mapa pilot≈Ø</a></li>
          <li><a href="/o-projektu.html?inzerent=1" class="text-decoration-none text-muted">O projektu</a></li>
          <li><a href="/kontakt.html?inzerent=1" class="text-decoration-none text-muted">Kontakt</a></li>
         <li><a href="/v-procesu.html" class="text-decoration-none text-muted">Blog</a></li>
        </ul>
      </div>

      <!-- Pr√°vn√≠ -->
      <div class="col-md-3">
        <h6 class="fw-bold">Informace</h6>
        <ul class="list-unstyled">
          <li><a href="/gdpr.html" class="text-decoration-none text-muted">Zpracov√°n√≠ osobn√≠ch √∫daj≈Ø</a></li>
          <li><a href="mailto:dronadmin@seznam.cz?subject=Chyba na webu" class="text-decoration-none text-muted">Nahl√°sit chybu</a></li>
        </ul>
      </div>

      <!-- Kontakt -->
      <div class="col-md-3">
        <h6 class="fw-bold">Provozovatel</h6>
        <p class="small text-muted mb-1">Ing. Bohuslav Vladyka<br>IƒåO: 08578591<br>Praha, ƒåesk√° republika</p>
        <p class="small text-muted mb-0">üìß <a href="mailto:dronadmin@seznam.cz" class="text-muted">dronadmin@seznam.cz</a></p>
      </div>

    </div>

    <hr class="my-4">

    <div class="d-flex justify-content-between align-items-center small text-muted">
      <span>&copy; <span id="year"></span> NajdiPilota.cz</span>
      <div>
        <a href="/gdpr.html" class="text-muted me-3"><i class="bi bi-facebook"></i></a>
        <a href="/v-procesu.html" class="text-muted me-3"><i class="bi bi-instagram"></i></a>
        <a href="/v-procesu.html" class="text-muted"><i class="bi bi-linkedin"></i></a>
      </div>
    </div>
  </div>
</footer>

<script>
  // Vlo≈æ√≠ aktu√°ln√≠ rok do copyrightu
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("year").textContent = new Date().getFullYear();
  });
</script>

</body>
</html>
