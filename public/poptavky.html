<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Poptávky – NajdiPilota.cz</title>
  <meta name="description" content="Přidejte poptávku na letecké práce dronem a oslovte ověřené piloty v okolí."/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
      <img src="/icons/logo.png" alt="" height="60" class="me-2" loading="lazy" aria-hidden="true"/>
      <span class="fs-4">NajdiPilota.cz</span>
    </a>

    <div class="ms-auto d-none d-md-flex">
       <!-- Odkaz na zprávy bude dynamicky nastaven v JavaScriptu -->
      <a id="messages-link" href="#" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-envelope me-1"></i>Moje zprávy
      </a>
      <a href="poptavky.html" class="btn btn-outline-secondary btn-sm ms-2">
        <i class="bi bi-clipboard-plus me-1"></i>Poptávky
      </a>
    </div>
  </div>
</nav>

<div class="container my-4">
  <!-- Inzerent banner / stav -->
  <div id="inzerent-info" class="alert alert-warning d-none"></div>

  <div class="row g-4">
    <!-- FORMULÁŘ PRO INZERENTA -->
    <div class="col-12">
      <div id="form-card" class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 id="form-title" class="card-title mb-0">
      <i class="bi bi-clipboard-plus me-2"></i><span>Přidat poptávku</span>
    </h5>
    <div class="d-flex gap-2">
      <button id="btn-cancel-edit" type="button" class="btn btn-outline-secondary btn-sm d-none">
        Zrušit úpravy
      </button>
      <button id="btn-toggle-form" type="button" class="pilot-login-btn btn-sm user-action d-flex align-items-center justify-content-center px-3 py-2">
        Otevřít formulář
      </button>
    </div>
  </div>

          <div id="form-locked" class="alert alert-info d-none">
            Pro přidání poptávky musíte být přihlášen jako inzerent.
          </div>

          <form id="poptavka-form" class="d-none">
            <div class="mb-3">
              <label class="form-label">Krátký popis*</label>
              <input type="text" class="form-control" id="title" maxlength="120" placeholder="Např. Fotografování rodinného domu dronem" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Detail poptávky</label>
              <textarea class="form-control" id="description" rows="4" placeholder="Upřesněte požadavky, termíny, výstupy..."></textarea>
            </div>

            <div class="row">
              <div class="col-md-7 mb-3">
                <label class="form-label">Lokalita*</label>
                <input type="text" class="form-control" id="location" placeholder="Město / adresa" required>
              </div>
              <div class="col-md-5 mb-3">
                <label class="form-label">Kraj</label>
                <select id="region" class="form-select">
                  <option value="">Vyberte kraj</option>
                  <option>Hlavní město Praha</option>
                  <option>Středočeský kraj</option>
                  <option>Jihočeský kraj</option>
                  <option>Plzeňský kraj</option>
                  <option>Karlovarský kraj</option>
                  <option>Ústecký kraj</option>
                  <option>Liberecký kraj</option>
                  <option>Královéhradecký kraj</option>
                  <option>Pardubický kraj</option>
                  <option>Vysočina</option>
                  <option>Jihomoravský kraj</option>
                  <option>Olomoucký kraj</option>
                  <option>Zlínský kraj</option>
                  <option>Moravskoslezský kraj</option>
                </select>
              </div>
            </div>

<div class="row">
  <div class="col-md-6 mb-3">
    <label class="form-label">Rozpočet (Kč)</label>
    <input type="number" min="0" step="100" class="form-control" id="budget" placeholder="např. 8 000">
    <div class="form-check mt-1">
      <input class="form-check-input" type="checkbox" id="budget-agreed">
      <label class="form-check-label" for="budget-agreed">Dohodou</label>
    </div>
  </div>
  <div class="col-md-6 mb-3">
    <label class="form-label">Termín</label>
    <input type="date" class="form-control" id="deadline">
  </div>
</div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="publicContacts">
              <label class="form-check-label" for="publicContacts">
                Souhlasím se zveřejněním této poptávky pro piloty na platformě.
              </label>
            </div>

            <button id="btn-submit" type="submit"
            class="btn btn-primary w-100 pilot-login-btn btn-sm user-action justify-content-center px-3 py-2">
      <i class="bi bi-send me-1"></i><span>Odeslat poptávku</span>
    </button>
    <div id="form-note" class="form-text mt-2">Po odeslání se vaše poptávka objeví ve výpisu níže.</div>
  </form>
</div>

    <!-- VÝPIS POPTÁVEK -->
   <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div class="d-flex align-items-center gap-2">
    <i class="bi bi-list-task"></i>
    <h5 class="mb-0">Aktivní poptávky</h5>
  </div>

  <div class="d-flex align-items-center gap-3">
    <select id="filter-region" class="form-select form-select-sm w-auto">
      <option value="">Všechny kraje</option>
      <option>Hlavní město Praha</option>
      <option>Středočeský kraj</option>
      <option>Jihočeský kraj</option>
      <option>Plzeňský kraj</option>
      <option>Karlovarský kraj</option>
      <option>Ústecký kraj</option>
      <option>Liberecký kraj</option>
      <option>Královéhradecký kraj</option>
      <option>Pardubický kraj</option>
      <option>Vysočina</option>
      <option>Jihomoravský kraj</option>
      <option>Olomoucký kraj</option>
      <option>Zlínský kraj</option>
      <option>Moravskoslezský kraj</option>
    </select>

    <div class="form-check form-switch m-0">
      <input class="form-check-input" type="checkbox" id="filter-mine">
      <label class="form-check-label small" for="filter-mine">Moje poptávky</label>
    </div>
  </div>
</div>

      <div id="poptavky-list" class="vstack gap-3"></div>
      <div id="empty-state" class="text-center text-muted d-none">Zatím tu nic není.</div>
    </div>
  </div>
</div>

<footer class="footer py-4">
  <div class="container text-center">
    <small>&copy; NajdiPilota.cz</small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
let editingId = null;
window.__advertiserEmail = '';
// -----------------------------
// Pomocné utility (fetch/json)
// -----------------------------
async function apiJson(url, data) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    credentials: 'include',
    body: JSON.stringify(data)
  });
  if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
  return res.json();
}

function formatKc(n) {
  if (n == null || n === '') return '';
  if (n === 'dohodou') return 'Dohodou';   // přidáno
  try { return new Intl.NumberFormat('cs-CZ').format(+n) + ' Kč'; } catch { return n + ' Kč'; }
}

function formatDateISO(d) {
  if (!d) return '';
  const dt = new Date(d);
  return isNaN(dt) ? '' : dt.toLocaleDateString('cs-CZ');
}
function escapeHtml(s) {
  return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
function setQueryParam(key, value) {
  const url = new URL(window.location.href);
  if (value && value !== '') url.searchParams.set(key, value);
  else url.searchParams.delete(key);
  history.replaceState(null, "", url.toString());
}
function getQueryParam(key, fallback = '') {
  return new URL(window.location.href).searchParams.get(key) ?? fallback;
}

// -------------------------------------------
// Úvodní zpráva, která se pošle inzerentovi
// -------------------------------------------
// function buildIntroMessage(d) {
//  const rows = [
//    `Dobrý den,`,
//    `reaguji na Vaši poptávku „${d.title ?? ''}“.`,
//    '',
//    `• Lokalita: ${d.location ?? ''}${d.region ? `, ${d.region}` : ''}`,
//    '',
//    `Mám zájem domluvit detaily (rozsah prací, termíny, výstupy).`,
//    '',
//    `Děkuji a těším se na odpověď.`
//  ].filter(Boolean);
//  return rows.join('\n');
// }

// -------------------------------------------
// Získání e-mailu pilota (session → LS → prompt)
// -------------------------------------------
async function resolvePilotEmail() {
  try {
    const meRes = await fetch('/get-my-pilot', { credentials: 'include' });
    if (meRes.ok) {
      const me = await meRes.json();
      if (me?.email) {
        localStorage.setItem('pilotEmail', me.email);
        return me.email;
      }
    }
  } catch (_) {}
  const ls = (localStorage.getItem('pilotEmail') || '').trim();
  if (ls) return ls;

  const ask = (prompt('Zadejte váš e-mail pilota pro odeslání reakce:') || '').trim();
  if (ask) {
    localStorage.setItem('pilotEmail', ask);
    return ask;
  }
  throw new Error('Pilot není přihlášen a e-mail nebyl zadán.');
}

// -------------------------------------------
// Editace / smazání vlastní poptávky (MVP)
// -------------------------------------------
let _lastData = []; // naplní loadPoptavky()

async function editDemand(id) { 
  id = Number(id);
  const item = (_lastData || []).find(d => Number(d.id) === id);
  if (!item) return alert('Poptávka nenalezena.');

  const adv = (window.__advertiserEmail || localStorage.getItem('inzerentEmail') || '').toLowerCase();
  if (!adv || String(item.advertiser_email || '').toLowerCase() !== adv) {
    return alert('Toto není vaše poptávka.');
  }

  const title       = prompt('Nadpis', item.title || '') ?? item.title;
  const description = prompt('Popis', item.description || '') ?? item.description;
  const location    = prompt('Lokalita', item.location || '') ?? item.location;
  const region      = prompt('Kraj', item.region || '') ?? item.region;
  const budgetStr   = prompt('Rozpočet (Kč)', item.budget ?? '') ?? item.budget;
  const deadline    = prompt('Termín (YYYY-MM-DD)', item.deadline ?? '') ?? item.deadline;

  try {
    const res = await fetch(`/poptavky/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        title, description, location, region,
        budget: budgetStr === '' ? null : Number(budgetStr),
        deadline: deadline || null
        // public necháme beze změny; případně můžeš doplnit prompt na viditelnost
      })
    });
    if (!res.ok) throw new Error(await res.text());
    await loadPoptavky(currentRegion());
  } catch (err) {
    console.error(err);
    alert('Nepodařilo se upravit poptávku: ' + (err?.message || err));
  }
}

async function deleteDemand(id) {
  id = Number(id);
  const item = (_lastData || []).find(d => Number(d.id) === id);
  if (!item) return alert('Poptávka nenalezena.');

  const adv = (window.__advertiserEmail || localStorage.getItem('inzerentEmail') || '').toLowerCase();
  if (!adv || String(item.advertiser_email || '').toLowerCase() !== adv) {
    return alert('Toto není vaše poptávka.');
  }

  if (!confirm('Opravdu smazat tuto poptávku?')) return;

  try {
    const res = await fetch(`/poptavky/${id}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include'
    });
    if (!res.ok) throw new Error(await res.text());
    _lastData = _lastData.filter(d => Number(d.id) !== id);
    renderList(_lastData);
  } catch (err) {
    console.error(err);
    alert('Mazání selhalo: ' + (err?.message || err));
  }
}

// -------------------------------------------
// Označení poptávky jako hotové
// -------------------------------------------
async function markDone(id) {
  const confirmHotovo = confirm('Označit tuto poptávku jako hotovou?');
  if (!confirmHotovo) return;

  // jednoduchý prompt (můžeš později nahradit modálním oknem)
  const rating = prompt('Jak jste spokojeni s výsledkem? (1–5 hvězdiček)', '5');
  const note = prompt('Chcete přidat krátký komentář?', '');

  try {
    const res = await fetch(`/poptavky/${id}/status`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        status: 'Hotovo',
        satisfaction: Number(rating) || null,
        note: note?.trim() || null
      }),
      credentials: 'include'
    });
    if (!res.ok) throw new Error(await res.text());
    alert('Děkujeme za zpětnou vazbu! Poptávka označena jako hotová.');
    await loadPoptavky(currentRegion());
  } catch (err) {
    console.error('❌', err);
    alert('Nepodařilo se uložit hodnocení: ' + (err?.message || err));
  }
}


function startEditDemand(id) {
  id = Number(id);
  const item = (_lastData || []).find(d => Number(d.id) === id);
  if (!item) return alert('Poptávka nenalezena.');

  // pojistka vlastnictví na FE (BE to stejně hlídá)
  const adv = (window.__advertiserEmail || '').toLowerCase();
  if (!adv || String(item.advertiser_email || '').toLowerCase() !== adv) {
    return alert('Toto není vaše poptávka.');
  }
  setEditMode(item);
}

// -------------------------------------------
// Reakce pilota na poptávku (vytvoří konverzaci)
// -------------------------------------------
async function handleReactById(id) {
  id = Number(id);
  const demand = (_lastData || []).find(d => Number(d.id) === Number(id));
  if (!demand) return alert('Poptávka nenalezena.');
  const btn = event?.currentTarget;
  const originalHTML = btn ? btn.innerHTML : null;

  try {
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Odesílám…';
    }

    // 1) Kdo jsem (pilot)?
    const pilotEmail = await resolvePilotEmail();

    // 2) Vytvoř / najdi konverzaci
    const { success, conversationId, message } = await apiJson('/create-conversation', {
      pilotEmail,
      advertiserEmail: demand.advertiser_email
    });
    if (!success || !conversationId) throw new Error(message || 'Nepodařilo se vytvořit konverzaci');
 
     // 3) Pošli úvodní zprávu
 // const intro = buildIntroMessage(demand);
 // const sendRes = await apiJson('/send-message', {
 //  conversationId,
 //  senderEmail: pilotEmail,
 //  message: intro
 // });
 // if (!sendRes.success) throw new Error('Zprávu se nepodařilo odeslat.');


    
    // 4) Přesměruj do chatu (chat.html očekává tyto 3 parametry)
    const url = new URL(location.origin + '/chat.html');
    url.searchParams.set('conversationId', conversationId);
    url.searchParams.set('pilotEmail', pilotEmail);
    url.searchParams.set('inzerentEmail', demand.advertiser_email);
    location.href = url.toString();

  } catch (err) {
    console.error(err);
    alert('Nepodařilo se reagovat na poptávku: ' + (err?.message || err));
    if (btn && originalHTML != null) { btn.disabled = false; btn.innerHTML = originalHTML; }
  }
}

function toggleFormVisibility(forceOpen = null) {
  const form = document.getElementById('poptavka-form');
  const btnToggle = document.getElementById('btn-toggle-form');
  const isOpen = !form.classList.contains('d-none');
  const willOpen = (forceOpen === null) ? !isOpen : !!forceOpen;

  form.classList.toggle('d-none', !willOpen);
  btnToggle.innerText = willOpen ? 'Zavřít formulář' : 'Otevřít formulář';

  if (willOpen) {
    document.getElementById('form-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function setCreateMode() {
  editingId = null;
  document.getElementById('form-title').querySelector('span').innerText = 'Přidat poptávku';
  document.getElementById('btn-submit').querySelector('span').innerText = 'Odeslat poptávku';
  document.getElementById('btn-cancel-edit').classList.add('d-none');

  const form = document.getElementById('poptavka-form');
  form.reset();
  document.getElementById('publicContacts').checked = true; // default
}

function setEditMode(item) {
  editingId = Number(item.id);
  document.getElementById('form-title').querySelector('span').innerText = 'Upravit poptávku';
  document.getElementById('btn-submit').querySelector('span').innerText = 'Uložit změny';
  document.getElementById('btn-cancel-edit').classList.remove('d-none');

  // Naplnění polí
  document.getElementById('title').value       = item.title || '';
  document.getElementById('description').value = item.description || '';
  document.getElementById('location').value    = item.location || '';
  document.getElementById('region').value      = item.region || '';
  document.getElementById('budget').value      = (item.budget ?? '') === null ? '' : (item.budget ?? '');
  document.getElementById('deadline').value    = item.deadline ? String(item.deadline).slice(0,10) : '';
  document.getElementById('publicContacts').checked = !!item.public;

  toggleFormVisibility(true); // otevři formulář
}

// -----------------------------
// Hlavní IIFE
// -----------------------------
(async function () {
  // ------- role: pilot? -------
  let isPilot = false;
  const fromIndex = document.referrer.includes('/index.html') || document.referrer.endsWith('/');
  const pilotQS = ['pilot','as'].some(k => {
    const v = (new URL(location.href)).searchParams.get(k);
    return v === '1' || v === 'pilot' || v === 'true';
  });
  if (fromIndex || pilotQS) isPilot = true;
  try {
    if (!isPilot) {
      const me = await fetch('/get-my-pilot', { credentials: 'include' });
      if (me.ok) {
        const user = await me.json();
        if (user && user.id) isPilot = true;
      }
    }
  } catch (_) {}

  

  // ------- role: inzerent? -------
  let advertiserEmail = '';
try {
  const r = await fetch('/get-my-advertiser', { credentials: 'include' });
  if (r.ok) {
    const me = await r.json();
    advertiserEmail = (me?.email || '').toLowerCase();
  }
} catch(_) {}

// fallback (volitelný)
if (!advertiserEmail) advertiserEmail = (localStorage.getItem('inzerentEmail') || '').toLowerCase();

// >>> PŘIDEJ TOTO:
window.__advertiserEmail = advertiserEmail;

const isAdvertiser = !!advertiserEmail;;

  // sjednoť "zdroj pravdy" pro zbytek skriptu i pro funkce mimo IIFE
  window.__advertiserEmail = advertiserEmail || '';
  if (window.__advertiserEmail) {
    // pro zpětnou kompatibilitu klidně ulož i do LS
    localStorage.setItem('inzerentEmail', window.__advertiserEmail);
  }
  

  // fallback pro starý způsob (nepovinné)
  if (!advertiserEmail) advertiserEmail = (localStorage.getItem('inzerentEmail') || '').toLowerCase();
  

// ------- Nastavení odkazu na zprávy podle role -------
  const messagesLink = document.getElementById('messages-link');
  if (messagesLink) {
    if (isPilot) {
      messagesLink.href = 'moje-zpravy.html';
    } else if (isAdvertiser) {
      messagesLink.href = 'moje-zpravy-inzerent.html';
    } else {
      // Pokud není přihlášen žádný uživatel, skrýt odkaz
      messagesLink.style.display = 'none';
    }
  }


  // ------- prvky formuláře -------
  const form = document.getElementById('poptavka-form');
  const formLocked = document.getElementById('form-locked');
  const info = document.getElementById('inzerent-info');

  if (info) {
  if (isAdvertiser && window.__advertiserEmail) {
    info.classList.remove('d-none', 'alert-warning');
    info.classList.add('alert-success');
    info.innerHTML =
      `<i class="bi bi-person-check me-2"></i>` +
      `Jste přihlášen jako inzerent: <strong>${escapeHtml(String(window.__advertiserEmail))}</strong>`;
  } else {
    info.classList.remove('d-none', 'alert-success');
    info.classList.add('alert-warning');
    info.innerHTML =
      `<i class="bi bi-info-circle me-2"></i>` +
      `Pro přidání poptávky musíte být přihlášen jako inzerent.`;
  }
}

  const btnToggleForm = document.getElementById('btn-toggle-form');
const btnCancelEdit = document.getElementById('btn-cancel-edit');

btnToggleForm?.addEventListener('click', () => {
  // pokud nejsi přihlášený inzerent, rovnou nic
  if (!isAdvertiser) return;

  // když přepínáš, zachovej režim (create/edit) a jen otevři/zavři UI
  toggleFormVisibility();
});

btnCancelEdit?.addEventListener('click', () => {
  setCreateMode();
  toggleFormVisibility(false); // po zrušení klidně formulář zavři (nebo nech otevřený – jak chceš)
});

 if (isAdvertiser) {
  formLocked.classList.add('d-none');
  info.classList.remove('d-none');
  // tlačítko otevřít viditelné
  document.getElementById('btn-toggle-form')?.classList.remove('d-none');
} else {
  formLocked.classList.remove('d-none');
  info.classList.add('d-none');
  // schovat tlačítko a formulář
  document.getElementById('btn-toggle-form')?.classList.add('d-none');
  document.getElementById('poptavka-form')?.classList.add('d-none');
}

  // ------- doplnění „Moje poptávky“ přepínače (když chybí v HTML) -------
  const regionSelect = document.getElementById('filter-region');
  let mineSwitch = document.getElementById('filter-mine');
  (function ensureMineSwitch() {
    if (!mineSwitch) {
      const host = regionSelect?.parentElement; // stejný wrapper jako select
      if (host) {
        const wrap = document.createElement('div');
        wrap.className = 'form-check form-switch ms-1';
        wrap.innerHTML = `
          <input class="form-check-input" type="checkbox" id="filter-mine">
          <label class="form-check-label small" for="filter-mine">Moje poptávky</label>
        `;
        host.appendChild(wrap);
        mineSwitch = wrap.querySelector('#filter-mine');
      }
    }
    // když není přihlášen inzerent, přepínač skryj
    if (mineSwitch && !isAdvertiser) {
      mineSwitch.closest('.form-check')?.classList.add('d-none');
    }
  })();

  // volitelný textový vyhledávač, pokud ho později přidáš do HTML
  const queryInput = document.getElementById('filter-query');

  function currentRegion() {
    return regionSelect?.value || '';
  }

  // init z URL
  const urlRegion = getQueryParam('region', '');
  if (regionSelect) regionSelect.value = urlRegion;

  // ------- listenery -------
  regionSelect?.addEventListener('change', async () => {
    setQueryParam('region', currentRegion());
    await loadPoptavky(currentRegion());
  });
  mineSwitch?.addEventListener('change', async () => {
    await loadPoptavky(currentRegion());
  });
  queryInput?.addEventListener('input', () => {
    renderList(_lastData || []);
  });

  // ------- submit formuláře (vytvoření poptávky) -------
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
     if (!isAdvertiser) return; // pojistka

    const budgetInput = document.getElementById('budget').value.trim();
const budgetAgreed = document.getElementById('budget-agreed').checked;
const budgetValue = budgetAgreed ? 'dohodou' : (budgetInput === '' ? null : Number(budgetInput));

const payload = {
  title: document.getElementById('title').value.trim(),
  description: document.getElementById('description').value.trim(),
  location: document.getElementById('location').value.trim(),
  region: document.getElementById('region').value,
  budget: budgetValue,
  deadline: document.getElementById('deadline').value || null,
  public: document.getElementById('publicContacts').checked,
};


    try {
    let res;
    if (editingId) {
      // EDIT
      res = await fetch(`/poptavky/${editingId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
    } else {
      // CREATE
      res = await fetch('/poptavky', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
    }
    
    if (!res.ok) throw new Error(await res.text());

    // Hotovo – reset UI a obnov seznam
    setCreateMode();
    toggleFormVisibility(false);
    await loadPoptavky(currentRegion());
    window.scrollTo({ top: 0, behavior: 'smooth' });

  } catch (err) {
    console.error(err);
    alert((editingId ? 'Úprava' : 'Uložení') + ' poptávky selhalo: ' + (err?.message || err));
  }
});

  // ------- načítání poptávek (veřejné / moje) -------
  async function loadPoptavky(region = '') {
    const mine = !!mineSwitch?.checked;
    let url = '/poptavky';

    if (mine) {
      const qp = new URLSearchParams({ mine: '1' });
      if (region) qp.set('region', region); // volitelně
      url += `?${qp.toString()}`;
    } else {
      const qs = region ? `?region=${encodeURIComponent(region)}` : '';
      url += qs;
    }

    const res = await fetch(url, { credentials: 'include' });
    _lastData = await res.json();
    renderList(_lastData);
  }

  // ------- vykreslení seznamu -------
  function renderList(items) {
  const container = document.getElementById('poptavky-list');
  const empty = document.getElementById('empty-state');
  const q = (document.getElementById('filter-query')?.value || '').trim().toLowerCase();
  const selectedRegion = currentRegion();

  container.innerHTML = '';

  const filtered = (items || []).filter(x => {
    if (selectedRegion && (x.region || '') !== selectedRegion) return false;
    if (!q) return true;
    const hay = `${x.title||''} ${x.description||''} ${x.location||''}`.toLowerCase();
    return hay.includes(q);
  });

  if (filtered.length === 0) {
    empty.classList.remove('d-none');
    return;
  }
  empty.classList.add('d-none');

  filtered.forEach(x => {
    // Bezpečné datumy
    let createdStr = '';
    try {
      const created = x?.created_at ? new Date(x.created_at) : null;
      if (created && !isNaN(created)) createdStr = created.toLocaleDateString('cs-CZ');
    } catch (_) {}

    let deadlineStr = '';
    try {
      const dl = x?.deadline ? new Date(x.deadline) : null;
      if (dl && !isNaN(dl)) deadlineStr = dl.toLocaleDateString('cs-CZ');
    } catch (_) {}

    const isMine = !!(x.advertiser_email && window.__advertiserEmail &&
  String(x.advertiser_email).toLowerCase() === String(window.__advertiserEmail));


    const isPublic = !!x.public;

    const card = document.createElement('div');
    card.className = 'card shadow-sm';
    card.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${escapeHtml(x.title || '')}</h6>
            <div class="text-muted small">
              ${escapeHtml(x.location || '')}${x.region ? ' · ' + escapeHtml(x.region) : ''}
            </div>
          </div>
          <div class="d-flex align-items-center gap-2">
            ${createdStr ? `<span class="badge bg-light text-secondary">${createdStr}</span>` : ''}
            
            ${isMine ? `
              <button type="button" class="btn btn-outline-secondary btn-sm p-1"
        title="Upravit" aria-label="Upravit"
        onclick="startEditDemand(${Number(x.id)})">
  <i class="bi bi-pencil"></i>
</button>
              <button type="button" class="btn btn-outline-danger btn-sm p-1"
                      title="Smazat" aria-label="Smazat"
                      onclick="deleteDemand(${Number(x.id)})">
                <i class="bi bi-trash"></i>
              </button>

              <button type="button" class="btn btn-success btn-sm p-1"
          title="Označit jako hotovo"
          aria-label="Hotovo"
          onclick="markDone(${Number(x.id)})">
    ✅
  </button>
              
            ` : ``}
          </div>
        </div>

        ${x.description ? `<p class="mt-3 mb-2">${escapeHtml(x.description || '')}</p>` : ''}

        <div class="d-flex flex-wrap gap-3 align-items-center mt-2">
          ${
  x.budget === 'dohodou'
    ? `<span class="badge bg-success-subtle text-success-emphasis">
         <i class="bi bi-cash-coin me-1"></i>Dohodou
       </span>`
    : (Number.isFinite(Number(x.budget)) ? `
       <span class="badge bg-success-subtle text-success-emphasis">
         <i class="bi bi-cash-coin me-1"></i>${Number(x.budget).toLocaleString('cs-CZ')} Kč
       </span>` : '')
}
          ${deadlineStr ? `
            <span class="badge bg-warning-subtle text-warning-emphasis">
              <i class="bi bi-calendar-event me-1"></i>${deadlineStr}
            </span>` : ''
          }
        </div>

        ${isPilot ? `
          <div class="mt-3">
            <button type="button" class="btn btn-outline-primary btn-sm"
                    title="Napsat inzerentovi"
                    onclick="handleReactById(${Number(x.id)})">
              <i class="bi bi-reply me-1"></i>Reagovat
            </button>
          </div>` : ``}
      </div>
    `;
    container.appendChild(card);
  });
}


  // zpřístupnění funkcí z IIFE ven (pro edit/delete)
  window.loadPoptavky = loadPoptavky;
  window.currentRegion = currentRegion;
  window.renderList = renderList;

  // první načtení
  await loadPoptavky(urlRegion);
})();



</script>

</body>
</html>
