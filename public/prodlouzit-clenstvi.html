<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prodloužení členství | NajdiPilota.cz</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <style>
    .membership-card {
      border: 2px solid transparent;
      border-radius: var(--radius);
      transition: all 0.3s ease;
      height: 100%;
      cursor: pointer;
    }
    .membership-card.active {
      border-color: var(--primary);
      box-shadow: 0 0 10px rgba(0, 119, 182, 0.5);
    }
    .membership-price {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
    }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="/index.html">
      <img src="/icons/logo.png" alt="" height="60" class="me-2" loading="lazy" aria-hidden="true" />
      <span class="fs-4">NajdiPilota.cz | Členství</span>
    </a>
  </div>
</nav>

<div class="container py-5">
  <h2 class="text-center mb-4">Vyberte si typ členství</h2>

  <!-- Info řádek -->
  <div id="membership-info" class="alert alert-info text-center mb-4" style="display:none;">
    <!-- Dynamicky doplníme -->
  </div>

  <form id="membership-form">
    <div class="row g-4">
      <!-- Free -->
      <div class="col-md-4">
        <input type="radio" name="membership_type" value="Free" class="d-none" id="plan-free">
        <label for="plan-free" class="w-100">
          <div class="card membership-card text-center p-4">
            <h4>Free</h4>
            <p class="membership-price">0 Kč</p>
            <ul class="list-unstyled">
              <li>1 specializace</li>
              <li>1 dron</li>
              <li>Bez webu / portfolia</li>
              <li>Základní viditelnost</li>
            </ul>
          </div>
        </label>
      </div>

      <!-- Basic -->
      <div class="col-md-4">
        <input type="radio" name="membership_type" value="Basic" class="d-none" id="plan-basic">
        <label for="plan-basic" class="w-100">
          <div class="card membership-card text-center p-4">
            <h4>Basic</h4>
            <p class="membership-price">Cenu doplníme</p>
            <ul class="list-unstyled">
              <li>Až 3 specializace</li>
              <li>Až 2 drony</li>
              <li>Možnost nastavit dostupnost</li>
              <li>Registrační číslo provozovatele</li>
              <li>Zobrazení telefonu a e-mailu</li>
              <li>Odkaz na portfolio / web</li>
            </ul>
          </div>
        </label>
      </div>

      <!-- Premium -->
      <div class="col-md-4">
        <input type="radio" name="membership_type" value="Premium" class="d-none" id="plan-premium">
        <label for="plan-premium" class="w-100">
          <div class="card membership-card text-center p-4">
            <h4>Premium</h4>
            <p class="membership-price">Cenu doplníme</p>
            <ul class="list-unstyled">
              <li>Neomezené specializace</li>
              <li>Neomezený počet dronů</li>
              <li>Veškeré kontaktní údaje</li>
              <li>Prioritní viditelnost na mapě</li>
              <li>Zvýrazněný profil</li>
            </ul>
          </div>
        </label>
      </div>
    </div>

    <!-- Platební údaje + QR -->
    <div id="payment-section" class="mt-5" style="display: none;">
      <h4 class="mb-3">Bankovní údaje</h4>
      <ul class="list-group mb-4">
        <li class="list-group-item"><strong>Částka:</strong> <span id="price">–</span></li>
        <li class="list-group-item"><strong>Číslo účtu (IBAN):</strong> <span id="iban">CZ7530300000003034593012</span></li>
        <li class="list-group-item"><strong>Zpráva pro příjemce:</strong> <span id="recipient-msg">[e-mail]</span></li>
      </ul>

      <h4 class="mb-3">QR kód pro platbu</h4>
      <div class="text-center mb-3">
        <canvas id="qrcode"></canvas>
      </div>
      <p class="text-muted text-center">Naskenujte v mobilní bankovní aplikaci.</p>
    </div>

    <div class="text-center mt-4">
      <a href="/account.html" class="btn btn-secondary">⬅ Zpět na účet</a>
    </div>
  </form>
</div>

<script>
const priceMap = {
  Basic: 199, // Kč
  Premium: 349
};
const iban = "CZ7530300000003034593012";
const currency = "CZK";

function removeDiacritics(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function generateQR(plan) {
  const price = priceMap[plan] || 0;
  document.getElementById("price").innerText = price ? price + " Kč" : "0 Kč";

  const email = localStorage.getItem("loggedEmail") || "neznamy@pilot.cz";
  const recipientMsg = removeDiacritics(`Clenstvi ${plan} pro ${email}`);

  document.getElementById("recipient-msg").innerText = recipientMsg;
  document.getElementById("iban").innerText = iban;

  const amount = price.toFixed(2);
  const qrPayload = `SPD*1.0*ACC:${iban}*AM:${amount}*CC:${currency}*MSG:${recipientMsg}`;

  new QRious({
    element: document.getElementById('qrcode'),
    value: qrPayload,
    size: 250
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  const email = localStorage.getItem("loggedEmail");
  if (!email) return;

  try {
    const res = await fetch("/pilots");
    const pilots = await res.json();
    const pilot = pilots.find(p => p.email === email);
    if (!pilot) return;

    // Info o účtu
    let currentType = pilot.type_account;
    if (!["Free", "Basic", "Premium"].includes(currentType)) currentType = "Free";

    const validUntil = pilot.visible_valid ? new Date(pilot.visible_valid) : null;
    let daysLeft = validUntil ? Math.ceil((validUntil - new Date()) / (1000 * 60 * 60 * 24)) : 0;
    if (daysLeft < 0) daysLeft = 0;

    const infoBox = document.getElementById("membership-info");
    infoBox.innerHTML = `
      Aktuálně využíváte <strong>${currentType}</strong> účet
      ${validUntil ? `a zbývá vám ještě <strong>${daysLeft} dnů</strong>` : ""}.<br>
      Každé prodloužení je o <strong>1 měsíc</strong>.
    `;
    infoBox.style.display = "block";

    // Nastavit aktuální výběr
    const currentInput = document.querySelector(`input[name="membership_type"][value="${currentType}"]`);
    if (currentInput) {
      currentInput.checked = true;
      const card = currentInput.closest(".membership-card");
      if (card) card.classList.add("active");
      if (currentType !== "Free") {
        document.getElementById("payment-section").style.display = "block";
        generateQR(currentType);
      }
    }

    // Kliknutí / změna výběru
    document.querySelectorAll("input[name='membership_type']").forEach(input => {
      input.addEventListener("change", () => {
        document.querySelectorAll(".membership-card").forEach(c => c.classList.remove("active"));
        const card = input.closest(".membership-card");
        if (card) card.classList.add("active");

        if (input.value === "Free") {
          document.getElementById("payment-section").style.display = "none";
        } else {
          document.getElementById("payment-section").style.display = "block";
          generateQR(input.value);
        }
      });
    });

  } catch (err) {
    console.error("Chyba při načítání pilotů:", err);
  }
});
</script>

</body>
</html>
